
{% extends "base.html" %}

{% block head %}
<title>Otomatik Kâr Hesaplama</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
<style>
  .card {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
  }
  .card:hover {
    transform: translateY(-5px);
  }
  .profit-card {
    border-left: 5px solid #28a745;
  }
  .loss-card {
    border-left: 5px solid #dc3545;
  }
  .high-margin {
    background-color: rgba(40, 167, 69, 0.1);
  }
  .medium-margin {
    background-color: rgba(255, 193, 7, 0.1);
  }
  .low-margin {
    background-color: rgba(220, 53, 69, 0.1);
  }
  .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  #resultTable {
    width: 100% !important;
  }
  .animate-fade {
    animation: fadeIn 0.5s;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h1 class="mb-4">Otomatik Kâr Hesaplama</h1>

  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Maliyet ve Fiyat Bilgileri</h5>
        </div>
        <div class="card-body">
          <form id="profitCalculatorForm">
            <div class="form-group">
              <label for="product_cost">Ürün Maliyeti (₺):</label>
              <input type="number" class="form-control" id="product_cost" step="0.01" min="0" required>
            </div>
            <div class="form-group">
              <label for="shipping_cost">Kargo Maliyeti (₺):</label>
              <input type="number" class="form-control" id="shipping_cost" step="0.01" min="0" value="0">
            </div>
            <div class="form-group">
              <label for="packaging_cost">Paketleme Maliyeti (₺):</label>
              <input type="number" class="form-control" id="packaging_cost" step="0.01" min="0" value="0">
            </div>
            <div class="form-group">
              <label for="sale_price">Satış Fiyatı (₺):</label>
              <input type="number" class="form-control" id="sale_price" step="0.01" min="0" required>
            </div>
            <div class="form-group">
              <label for="platform">Satış Platformu:</label>
              <select class="form-control" id="platform">
                <option value="trendyol">Trendyol</option>
                <option value="hepsiburada">Hepsiburada</option>
                <option value="n11">N11</option>
                <option value="amazon">Amazon</option>
                <option value="other">Diğer</option>
              </select>
            </div>
            <div class="form-group" id="commissionRateGroup">
              <label for="commission_rate">Komisyon Oranı (%):</label>
              <input type="number" class="form-control" id="commission_rate" step="0.01" min="0" max="100" value="18">
            </div>
            <button type="submit" class="btn btn-primary btn-block">Hesapla</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card" id="resultCard" style="display: none;">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Kâr Analiz Sonuçları</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <div class="card profit-card h-100">
                <div class="card-body">
                  <h5 class="card-title">Kâr Analizi</h5>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Net Kâr:</span>
                    <span id="net_profit" class="font-weight-bold"></span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Kâr Marjı:</span>
                    <span id="profit_margin" class="font-weight-bold"></span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>ROI (Yatırım Getirisi):</span>
                    <span id="roi" class="font-weight-bold"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">Maliyet Dağılımı</h5>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Toplam Maliyet:</span>
                    <span id="total_cost" class="font-weight-bold"></span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Komisyon Tutarı:</span>
                    <span id="commission_amount" class="font-weight-bold"></span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>KDV Tutarı:</span>
                    <span id="vat_amount" class="font-weight-bold"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h5>Ayrıntılı Kâr Hesaplaması</h5>
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Kalem</th>
                  <th>Tutar (₺)</th>
                  <th>Yüzde (%)</th>
                </tr>
              </thead>
              <tbody id="detailedCalculationBody">
              </tbody>
            </table>
          </div>

          <div class="mt-4">
            <h5>Hedef Kâr İçin Önerilen Fiyatlar</h5>
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Hedef Kâr Marjı</th>
                  <th>Önerilen Fiyat (₺)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>%10</td>
                  <td id="price_10_percent"></td>
                </tr>
                <tr>
                  <td>%15</td>
                  <td id="price_15_percent"></td>
                </tr>
                <tr>
                  <td>%20</td>
                  <td id="price_20_percent"></td>
                </tr>
                <tr>
                  <td>%25</td>
                  <td id="price_25_percent"></td>
                </tr>
                <tr>
                  <td>%30</td>
                  <td id="price_30_percent"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Toplu Kayıtlı Ürün Kâr Analizi</h5>
        </div>
        <div class="card-body">
          <button id="loadProductsBtn" class="btn btn-info mb-3">Ürünleri Yükle ve Analiz Et</button>
          <div id="productsTableContainer" style="display: none;">
            <table id="productsTable" class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Ürün Kodu</th>
                  <th>Ürün Adı</th>
                  <th>Maliyet (₺)</th>
                  <th>Satış Fiyatı (₺)</th>
                  <th>Kâr Marjı (%)</th>
                  <th>Net Kâr (₺)</th>
                  <th>İşlemler</th>
                </tr>
              </thead>
              <tbody id="productsTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS Kütüphaneleri -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>

<script>
  $(document).ready(function() {
    // Platform seçimine göre komisyon oranını güncelle
    $('#platform').change(function() {
      const platform = $(this).val();
      let commissionRate = 0;
      
      switch(platform) {
        case 'trendyol':
          commissionRate = 18;
          break;
        case 'hepsiburada':
          commissionRate = 20;
          break;
        case 'n11':
          commissionRate = 15;
          break;
        case 'amazon':
          commissionRate = 25;
          break;
        default:
          commissionRate = 10;
      }
      
      $('#commission_rate').val(commissionRate);
    });

    // Kar hesaplama formu submit
    $('#profitCalculatorForm').submit(function(e) {
      e.preventDefault();
      
      // Form değerlerini al
      const productCost = parseFloat($('#product_cost').val());
      const shippingCost = parseFloat($('#shipping_cost').val() || 0);
      const packagingCost = parseFloat($('#packaging_cost').val() || 0);
      const salePrice = parseFloat($('#sale_price').val());
      const commissionRate = parseFloat($('#commission_rate').val() || 0);
      
      // Hesaplamalar
      const commissionAmount = (salePrice * commissionRate) / 100;
      const vatRate = 18; // KDV oranı
      const vatAmount = (salePrice * vatRate) / 100;
      
      const totalCost = productCost + shippingCost + packagingCost + commissionAmount;
      const netProfit = salePrice - totalCost - vatAmount;
      const profitMargin = (netProfit / salePrice) * 100;
      const roi = (netProfit / totalCost) * 100;
      
      // Sonuçları göster
      $('#resultCard').show();
      $('#net_profit').text(netProfit.toFixed(2) + ' ₺');
      $('#profit_margin').text(profitMargin.toFixed(2) + '%');
      $('#roi').text(roi.toFixed(2) + '%');
      $('#total_cost').text(totalCost.toFixed(2) + ' ₺');
      $('#commission_amount').text(commissionAmount.toFixed(2) + ' ₺');
      $('#vat_amount').text(vatAmount.toFixed(2) + ' ₺');
      
      // Profit renklendirme
      if (profitMargin > 0) {
        $('#net_profit').removeClass('text-danger').addClass('text-success');
      } else {
        $('#net_profit').removeClass('text-success').addClass('text-danger');
      }
      
      // Ayrıntılı hesaplama tablosu
      const detailedCalculation = [
        { item: 'Satış Fiyatı', amount: salePrice, percentage: 100 },
        { item: 'Ürün Maliyeti', amount: -productCost, percentage: -(productCost / salePrice * 100) },
        { item: 'Kargo Maliyeti', amount: -shippingCost, percentage: -(shippingCost / salePrice * 100) },
        { item: 'Paketleme Maliyeti', amount: -packagingCost, percentage: -(packagingCost / salePrice * 100) },
        { item: 'Komisyon', amount: -commissionAmount, percentage: -commissionRate },
        { item: 'KDV', amount: -vatAmount, percentage: -vatRate },
        { item: 'Net Kâr', amount: netProfit, percentage: profitMargin }
      ];
      
      let html = '';
      detailedCalculation.forEach(item => {
        const amountClass = item.amount < 0 ? 'text-danger' : (item.item === 'Satış Fiyatı' ? '' : 'text-success');
        const percentageClass = item.percentage < 0 ? 'text-danger' : (item.item === 'Satış Fiyatı' ? '' : 'text-success');
        
        html += `<tr>
          <td>${item.item}</td>
          <td class="${amountClass}">${item.amount.toFixed(2)} ₺</td>
          <td class="${percentageClass}">${Math.abs(item.percentage).toFixed(2)}%</td>
        </tr>`;
      });
      
      $('#detailedCalculationBody').html(html);
      
      // Önerilen fiyat hesaplaması
      const targetMargins = [10, 15, 20, 25, 30];
      targetMargins.forEach(margin => {
        // Formül: totalCost / (1 - (margin/100))
        const suggestedPrice = (totalCost + vatAmount) / (1 - (margin/100));
        $(`#price_${margin}_percent`).text(suggestedPrice.toFixed(2) + ' ₺');
      });
    });
    
    // Ürünleri yükle ve analiz et
    $('#loadProductsBtn').click(function() {
      $(this).attr('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Yükleniyor...');
      
      // Sunucudan ürün verilerini almayı simüle et
      setTimeout(function() {
        // Örnek veri
        const products = [
          { code: '001', name: 'Kadın Spor Ayakkabı', cost: 180.00, price: 399.90, margin: 32.5, profit: 129.90 },
          { code: '002', name: 'Erkek Deri Cüzdan', cost: 85.00, price: 249.90, margin: 45.3, profit: 113.25 },
          { code: '003', name: 'Çocuk Kışlık Mont', cost: 210.00, price: 399.90, margin: 29.7, profit: 118.80 },
          { code: '004', name: 'Unisex Güneş Gözlüğü', cost: 65.00, price: 199.90, margin: 51.2, profit: 102.37 },
          { code: '005', name: 'Kadın El Çantası', cost: 145.00, price: 349.90, margin: 38.5, profit: 134.78 },
          { code: '006', name: 'Erkek Kot Pantolon', cost: 120.00, price: 299.90, margin: 42.1, profit: 126.22 },
          { code: '007', name: 'Kadın Triko Kazak', cost: 95.00, price: 229.90, margin: 40.8, profit: 93.83 },
          { code: '008', name: 'Bebek Uyku Tulumu', cost: 110.00, price: 269.90, margin: 39.2, profit: 105.84 }
        ];
        
        let html = '';
        products.forEach(product => {
          let marginClass = '';
          if (product.margin > 40) {
            marginClass = 'high-margin';
          } else if (product.margin > 25) {
            marginClass = 'medium-margin';
          } else {
            marginClass = 'low-margin';
          }
          
          html += `<tr class="${marginClass}">
            <td>${product.code}</td>
            <td>${product.name}</td>
            <td>${product.cost.toFixed(2)} ₺</td>
            <td>${product.price.toFixed(2)} ₺</td>
            <td>${product.margin.toFixed(2)}%</td>
            <td>${product.profit.toFixed(2)} ₺</td>
            <td>
              <button class="btn btn-sm btn-primary analyze-product" data-code="${product.code}">Detaylı Analiz</button>
            </td>
          </tr>`;
        });
        
        $('#productsTableBody').html(html);
        $('#productsTableContainer').show();
        $('#loadProductsBtn').attr('disabled', false).text('Ürünleri Yeniden Yükle');
        
        // DataTable'ı başlat
        $('#productsTable').DataTable({
          "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.21/i18n/Turkish.json"
          },
          "order": [[4, "desc"]]
        });
        
        // Detaylı analiz butonu işlevi
        $('.analyze-product').click(function() {
          const productCode = $(this).data('code');
          const product = products.find(p => p.code === productCode);
          
          // Ürün verilerini forma doldur
          $('#product_cost').val(product.cost);
          $('#sale_price').val(product.price);
          $('#shipping_cost').val(20);
          $('#packaging_cost').val(5);
          
          // Otomatik olarak hesaplama formunu tetikle
          $('#profitCalculatorForm').submit();
          
          // Sayfanın üstüne kaydır
          $('html, body').animate({
            scrollTop: $("#profitCalculatorForm").offset().top - 100
          }, 500);
        });
        
      }, 1500);
    });
  });
</script>
{% endblock %}
