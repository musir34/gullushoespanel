
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3">Veri Güncelleme Durumu</h1>
            <p class="text-muted">Sistem tarafından otomatik olarak güncellemeler yapılacaktır. Bu sayfadan manuel olarak da güncelleyebilirsiniz.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Son Güncelleme Bilgileri</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Veri Türü</th>
                                <th>Son Güncelleme</th>
                                <th>Sonuç</th>
                                <th>Toplam Kayıt</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Ürünler</td>
                                <td>{{ last_updates.products.time|default('Hiç güncellenmmedi') }}</td>
                                <td>
                                    {% if last_updates.products.success %}
                                        <span class="text-success">Başarılı</span>
                                    {% else %}
                                        <span class="text-danger">Başarısız</span>
                                    {% endif %}
                                </td>
                                <td>{{ last_updates.products.count|default('0') }}</td>
                            </tr>
                            <tr>
                                <td>Siparişler</td>
                                <td>{{ last_updates.orders.time|default('Hiç güncellenmmedi') }}</td>
                                <td>
                                    {% if last_updates.orders.success %}
                                        <span class="text-success">Başarılı</span>
                                    {% else %}
                                        <span class="text-danger">Başarısız</span>
                                    {% endif %}
                                </td>
                                <td>{{ last_updates.orders.count|default('0') }}</td>
                            </tr>
                            <tr>
                                <td>İadeler/Talepler</td>
                                <td>{{ last_updates.claims.time|default('Hiç güncellenmmedi') }}</td>
                                <td>
                                    {% if last_updates.claims.success %}
                                        <span class="text-success">Başarılı</span>
                                    {% else %}
                                        <span class="text-danger">Başarısız</span>
                                    {% endif %}
                                </td>
                                <td>{{ last_updates.claims.count|default('0') }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Manuel Güncelleme</h5>
                </div>
                <div class="card-body">
                    <p>İstediğiniz veri türünü manuel olarak güncelleyebilirsiniz.</p>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="updateData('products')" id="update-products-btn">
                            <i class="bi bi-box"></i> Ürünleri Güncelle
                        </button>
                        
                        <button class="btn btn-primary" onclick="updateData('orders')" id="update-orders-btn">
                            <i class="bi bi-cart"></i> Siparişleri Güncelle
                        </button>
                        
                        <button class="btn btn-primary" onclick="updateData('claims')" id="update-claims-btn">
                            <i class="bi bi-arrow-return-left"></i> İadeleri/Talepleri Güncelle
                        </button>
                        
                        <button class="btn btn-danger" onclick="updateData('all')" id="update-all-btn">
                            <i class="bi bi-arrow-repeat"></i> Tüm Verileri Güncelle
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Zamanlama Bilgisi</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Ürünler
                            <span class="badge bg-primary">Her 3 saatte bir</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Siparişler
                            <span class="badge bg-primary">Her 30 dakikada bir</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            İadeler/Talepler
                            <span class="badge bg-primary">Her saat başı</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateData(dataType) {
    const btnId = `update-${dataType}-btn`;
    const button = document.getElementById(btnId);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Güncelleniyor...';
    }

    fetch(`/api/update-data/${dataType}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Başarılı', data.message, 'success');
        } else {
            showNotification('Hata', data.message, 'danger');
        }
        
        // 3 saniye sonra sayfayı yenile
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    })
    .catch(error => {
        console.error('Hata:', error);
        showNotification('Hata', 'Güncelleme sırasında bir hata oluştu.', 'danger');
    })
    .finally(() => {
        if (button) {
            button.disabled = false;
            button.innerHTML = button.innerHTML.replace('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Güncelleniyor...', dataType === 'all' ? '<i class="bi bi-arrow-repeat"></i> Tüm Verileri Güncelle' : `<i class="bi bi-${dataType === 'products' ? 'box' : dataType === 'orders' ? 'cart' : 'arrow-return-left'}"></i> ${dataType === 'products' ? 'Ürünleri' : dataType === 'orders' ? 'Siparişleri' : 'İadeleri/Talepleri'} Güncelle`);
        }
    });
}

function showNotification(title, message, type) {
    // Toast gösterme işlevi
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}</strong>: ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
    bsToast.show();
    
    // 5 saniye sonra toast'ı kaldır
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1050';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
