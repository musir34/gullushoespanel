<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş Listesi</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Genel Sayfa Ayarları */
        body {
            background-color: #f5f5f5;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin-top: 60px;
        }

        /* Kullanıcı Bilgisi */
        .user-info {
            position: fixed;
            top: 15px;
            left: 20px;
            z-index: 10;
            font-size: 14px;
            color: #333;
        }

        /* Üstteki Butonları Sağ Üst Köşeye Hizalama */
        .btn-group-top {
            position: fixed;
            top: 15px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        /* Buton Stilleri */
        .btn {
            border-radius: 10px;
            padding: 5px 12px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* Sipariş Kartları */
        .order-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }

        .card {
            width: 100%;
            max-width: 350px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .product-image {
            width: 100%;
            height: auto;
            border-radius: 10px 10px 0 0;
        }

        .card-title {
            font-weight: bold;
            color: #444;
            text-align: center;
            margin: 10px 0;
        }

        .card-text {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }

        /* Form ve Input Alanları */
        .form-control {
            border-radius: 10px;
            padding: 8px;
            font-size: 0.85rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        }

        .form-group {
            position: relative;
            margin-bottom: 35px;
        }

        /* Barkod Uyarıları */
        .alert {
            position: absolute;
            top: -30px;
            left: 0;
            right: 0;
            font-size: 12px;
            padding: 5px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        .alert-show {
            opacity: 1;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Kopyalama İkonu */
        .copy-container {
            position: relative;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }

        .copy-confirmation {
            color: green;
            font-size: 1em;
            margin-left: 5px;
            display: none;
        }

        .copy-confirmation.show {
            display: inline-block;
        }

        /* Alt Butonlar Sol Tarafa Hizalama */
        .bottom-buttons {
            text-align: left;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-bottom {
            max-width: 200px;
            padding: 8px 15px;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .btn-bottom:hover {
            opacity: 0.9;
        }

        /* Sabit Üst Bölüm (Kargo Bilgileri) */
        .fixed-header {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        /* Modal Pencere Ayarları */
        .modal-content {
            border-radius: 15px;
            padding: 20px;
        }

        .modal-header {
            border-bottom: none;
            justify-content: center;
        }

        .modal-footer {
            border-top: none;
            justify-content: center;
        }

        /* Özel Renk Sınıfları */
        .bg-orange {
            background-color: orange;
            color: white;
        }

        .bg-red {
            background-color: red;
            color: white;
        }

        /* Yeni Eklenen Stil - "Yazdır" Butonuna PNG Ekleme */
        .btn-warning-img {
            padding: 0;
            width: 50px; /* Buton genişliğini isteğinize göre ayarlayabilirsiniz */
            height: 50px; /* Buton yüksekliğini isteğinize göre ayarlayabilirsiniz */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-warning-img img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px; /* İsteğe bağlı: Köşeleri yuvarlama */
        }

        /* Responsive Ayarlar */
        @media (max-width: 768px) {
            .btn-group-top {
                flex-direction: column;
                right: 10px;
                top: 60px;
            }

            .btn {
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            .card-title {
                font-size: 0.9rem;
            }

            .card-text {
                font-size: 0.8rem;
            }

            .order-container {
                justify-content: center;
            }

            .btn-bottom {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Kullanıcı Bilgisi Sol Üstte -->
        <div class="user-info">
            Giriş Yapan: <strong>{{ session['first_name'] }} {{ session['last_name'] }}</strong>
        </div>

        <!-- Sağ Üst Köşede Butonlar -->
        <div class="btn-group-top">
            <form method="POST" action="{{ url_for('logout') }}">
                <button type="submit" class="btn btn-danger">Çıkış Yap</button>
            </form>
            {% if session['role'] == 'admin' %}
            <a href="{{ url_for('approve_users') }}" class="btn btn-warning">Kullanıcı Yönetimi</a>
            {% endif %}
            <a href="{{ url_for('home.home') }}" class="btn btn-secondary">Anasayfa</a>
        </div>

        <!-- Sayfa Başlığı -->
        <div class="text-center mb-5">
            <h2>Sipariş Listesi</h2>
            <h5>Şu anki sayfa: {{ page }}</h5>
        </div>

        <!-- Üst Buton Grupları -->
        <div class="row mb-4">
            <div class="col-md-4 text-center">
                <a href="{{ url_for('order_list_service.order_list_all') }}" class="btn btn-primary w-100">Tüm Siparişler</a>
            </div>
            <div class="col-md-4 text-center">
                <a href="{{ url_for('order_list_service.order_list_new') }}" class="btn btn-warning w-100">Yeni Siparişler</a>
            </div>
            <div class="col-md-4 text-center">
                <a href="{{ url_for('order_list_service.order_list_processed') }}" class="btn btn-success w-100">İşleme Alınanlar</a>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-6 text-center">
                <a href="{{ url_for('order_list_service.order_list_shipped') }}" class="btn bg-red w-100">Kargoda</a>
            </div>
            <div class="col-md-6 text-center">
                <a href="{{ url_for('order_list_service.order_list_delivered') }}" class="btn bg-orange w-100">Teslim Edilenler</a>
            </div>
        </div>

        <!-- Toplam Sipariş Sayısı -->
        <div class="text-center mb-4">
            <h4>Toplam Sipariş Sayısı: {{ total_orders_count }}</h4>
        </div>

        <!-- Arama ve Siparişleri Güncelleme -->
        <div class="row mb-4">
            <div class="col-md-8">
                <form method="GET" action="{{ url_for('order_list_service.order_list_all') }}">
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="Sipariş Numarasına Göre Ara" value="{{ request.args.get('search', '') }}">
                        <button class="btn btn-primary" type="submit">Ara</button>
                    </div>
                </form>
            </div>
            <div class="col-md-4 text-end">
                <form method="POST" action="{{ url_for('order_service.fetch_trendyol_orders_route') }}">
                    <button type="submit" class="btn btn-secondary">Siparişleri Güncelle</button>
                </form>
            </div>
        </div>

        <!-- Siparişlerin Listelendiği Kısım -->
        <div class="row order-container">
            {% for order in orders %}
            <div class="col-md-6 col-lg-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Sipariş Tarihi:</strong> {{ order.order_date }}<br>
                            <span class="cargo-provider {{ 'orange' if 'MNG Kargo' in order.cargo_provider_name else 'black' }}">
                                ({{ order.cargo_provider_name }})
                            </span>
                            <!-- Statü Bilgisi -->
                            {% set translated_status = {
                                'Created': 'Yeni',
                                'Picking': 'İşleme Alındı',
                                'Shipped': 'Kargoda',
                                'Delivered': 'Teslim Edildi'
                            }.get(order.status, order.status) %}
                            <span class="badge 
                                {% if translated_status == 'Yeni' %}
                                    bg-warning
                                {% elif translated_status == 'İşleme Alındı' %}
                                    bg-success
                                {% elif translated_status == 'Kargoda' %}
                                    bg-danger
                                {% elif translated_status == 'Teslim Edildi' %}
                                    bg-orange
                                {% else %}
                                    bg-secondary
                                {% endif %}">
                                {{ translated_status }}
                            </span><br>
                            <strong>Sipariş Numarası:</strong> {{ order.order_number }}
                            <span class="copy-container">
                                <span class="clipboard-icon" onclick="copyToClipboard('{{ order.order_number }}', this)">
                                    📋
                                </span>
                                <span class="copy-confirmation">✔️</span>
                            </span>
                        </div>
                        <div>
                            <form method="POST" action="{{ url_for('order_list_service.order_label') }}" target="_blank">
                                <input type="hidden" name="order_number" value="{{ order.order_number }}">
                                <input type="hidden" name="shipping_code" value="{{ order.shipping_barcode }}">
                                <input type="hidden" name="cargo_provider" value="{{ order.cargo_provider_name }}">
                                <input type="hidden" name="customer_name" value="{{ order.customer_name }}">
                                <input type="hidden" name="customer_surname" value="{{ order.customer_surname }}">
                                <input type="hidden" name="customer_address" value="{{ order.customer_address }}">
                                <button type="submit" class="cargo-button">
                                    <img src="https://img.icons8.com/doodle/48/000000/delivery.png" class="truck-icon" alt="Kargo">
                                </button>
                            </form>
                            <button class="btn btn-secondary mt-2" onclick="showArchiveModal('{{ order.order_number }}')">Arşivle</button>

                        </div>
                    </div>
                    <div class="card-body">
                        {% if translated_status in ['Yeni', 'İşleme Alındı'] %}
                        <h6><strong>Kargoya Kalan Süre:</strong> <span class="remaining-time" id="remaining-time-{{ loop.index }}" data-end-time="{{ order.agreed_delivery_date or order.estimated_delivery_end }}">{{ order.remaining_time }}</span></h6>
                        {% endif %}
                        <button class="btn btn-outline-primary w-100 toggle-details mt-3" data-bs-toggle="collapse" data-bs-target="#details-{{ loop.index }}" aria-expanded="false" aria-controls="details-{{ loop.index }}">Ürün Detayları</button>
                        <div id="details-{{ loop.index }}" class="collapse details-section mt-3">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Stok Kodu</th>
                                        <th>Ürün Barkodu</th>
                                        <th>Görsel</th>
                                        <th>Miktar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for detail in order.processed_details %}
                                    <tr>
                                        <td>{{ detail.sku }}</td>
                                        <td>{{ detail.barcode }}</td>
                                        <td>
                                            <img src="{{ detail.image_url }}" alt="Ürün Görseli" style="max-width: 100px;"/>
                                        </td>
                                        <td><strong>{{ detail.quantity }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Sayfalama -->
        <nav aria-label="Sayfa gezintisi" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for(request.endpoint, page=page-1, search=request.args.get('search', ''), _external=False) }}">Önceki</a>
                </li>
                {% endif %}
                {% for i in range(1, total_pages + 1) %}
                <li class="page-item {% if i == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for(request.endpoint, page=i, search=request.args.get('search', ''), _external=False) }}">{{ i }}</a>
                </li>
                {% endfor %}
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for(request.endpoint, page=page+1, search=request.args.get('search', ''), _external=False) }}">Sonraki</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>

    <!-- Arşiv Sebebi Modal Penceresi -->
    <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="archiveForm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Arşivleme Sebebi Seçin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="archiveOrderNumber" name="order_number" value="">
                        <div class="mb-3">
                            <label for="archiveReason" class="form-label">Sebep</label>
                            <select class="form-control" id="archiveReason" name="archive_reason" required>
                                <option value="">Sebep Seçin</option>
                                <option value="Stok Tükendi">Stok Tükendi</option>
                                <option value="Kusurlu/Defolu Ürün">Kusurlu/Defolu Ürün</option>
                                <option value="Paket İçeriği Eksik">Paket İçeriği Eksik</option>
                                <option value="Ürün Sorunu Gideriliyor">Ürün Sorunu Gideriliyor</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Arşivle</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Geçici Kopyalama Alanı -->
    <textarea id="temp-copier" style="position: absolute; top: -1000px;"></textarea>

    <!-- JavaScript - Kopyalama ve Barkod Doğrulama -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyToClipboard(text, element) {
            const tempInput = document.getElementById('temp-copier');
            tempInput.value = text;
            tempInput.select();
            tempInput.setSelectionRange(0, 99999); // Mobile cihazlar için
            document.execCommand('copy');
            const confirmation = element.nextElementSibling;
            confirmation.classList.add('show');
            setTimeout(() => {
                confirmation.classList.remove('show');
            }, 2000);
        }

        function showArchiveModal(order_number) {
            // Sipariş numarasını modal içindeki input'a ekle
            document.getElementById('archiveOrderNumber').value = order_number;
            // Modal penceresini aç
            var archiveModal = new bootstrap.Modal(document.getElementById('archiveModal'));
            archiveModal.show();
        }

        // Arşivleme formunu yöneten kod
        $('#archiveForm').submit(function(event) {
            event.preventDefault(); // Sayfanın yeniden yüklenmesini engelle
            var order_number = $('#archiveOrderNumber').val();
            var archive_reason = $('#archiveReason').val();

            if (!archive_reason) {
                alert('Lütfen bir sebep seçin.');
                return;
            }

            // Sunucuya POST isteği gönder
            $.post('/archive_order', { order_number: order_number, archive_reason: archive_reason }, function(response) {
                if (response.success) {
                    alert('Sipariş arşivlendi!');
                    // Modalı kapat
                    $('#archiveModal').modal('hide');
                    // Sayfayı yenile veya ana sayfaya yönlendir
                    window.location.href = '/';
                } else {
                    alert('Sipariş arşivlenirken bir hata oluştu: ' + response.message);
                }
            }).fail(function() {
                alert('Sipariş arşivlenirken bir hata oluştu.');
            });
        });

        // Kalan Süreyi Güncelleyen Fonksiyon
        function updateRemainingTime() {
            const remainingTimeElements = document.querySelectorAll('.remaining-time');
            const now = new Date();
            remainingTimeElements.forEach(element => {
                const endTime = new Date(element.getAttribute('data-end-time') + "Z"); // Zulu zaman dilimi
                const timeDiff = endTime.getTime() - now.getTime();
                if (timeDiff > 0) {
                    const totalMinutes = Math.floor(timeDiff / 60000);
                    const days = Math.floor(totalMinutes / 1440);
                    const hours = Math.floor((totalMinutes % 1440) / 60);
                    const minutes = totalMinutes % 60;
                    let newTimeString = '';
                    if (days > 0) newTimeString += `${days} gün `;
                    if (hours > 0) newTimeString += `${hours} saat `;
                    newTimeString += `${minutes} dakika`;
                    element.innerText = `${newTimeString}`;
                    if (totalMinutes <= 600) { // 10 saatten az kaldıysa
                        element.classList.add('red');
                    } else {
                        element.classList.remove('red');
                    }
                } else {
                    element.innerText = `0 dakika`;
                    element.classList.add('red');
                }
            });
        }

        setInterval(updateRemainingTime, 60000); // Her dakika güncelle
        window.onload = updateRemainingTime;
    </script>
</body>

</html>