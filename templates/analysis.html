{% extends "base.html" %}

{% block content %}
<!-- Dashboard Arayüzü için Ek CSS -->
<style>
  /* Genel Layout */
  #wrapper {
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  /* Sidebar Stilleri */
  #sidebar-wrapper {
    min-width: 250px;
    max-width: 250px;
    background: #343a40;
    color: #fff;
    transition: all 0.3s;
  }
  #sidebar-wrapper .sidebar-heading {
    padding: 1.5rem 1rem;
    font-size: 1.2rem;
    background: #23272b;
  }
  #sidebar-wrapper .list-group-item {
    background: #343a40;
    border: none;
    color: #adb5bd;
  }
  #sidebar-wrapper .list-group-item:hover {
    background: #495057;
    color: #fff;
  }
  /* Sayfa İçerik Stilleri */
  #page-content-wrapper {
    width: 100%;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
  }
  /* Navbar Düzenlemesi */
  .navbar {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  /* Kart Stilleri */
  .card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  .card-header {
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }
  /* Responsive Canvas Ayarı */
  canvas {
    width: 100% !important;
    max-height: 400px;
  }
  /* Sidebar Toggle Durumu */
  #wrapper.toggled #sidebar-wrapper {
    margin-left: -250px;
  }
</style>

<div id="wrapper">
  <!-- Sidebar (Stok Raporu butonu kaldırıldı) -->
  <div id="sidebar-wrapper">
    <div class="sidebar-heading">Analiz Paneli</div>
    <div class="list-group list-group-flush">
      <a href="#" class="list-group-item list-group-item-action active" data-section="dashboard">Dashboard</a>
      <a href="#" class="list-group-item list-group-item-action" data-section="sales">Satışlar</a>
      <a href="#" class="list-group-item list-group-item-action" data-section="returns">İadeler</a>
      <a href="#" class="list-group-item list-group-item-action" data-section="products">Ürün Analizleri</a>
      <a href="#" class="list-group-item list-group-item-action" data-section="stock">Stok Raporu</a>
    </div>
  </div>

  <!-- Sayfa İçeriği -->
  <div id="page-content-wrapper">
    <!-- Üst Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
      <button class="btn btn-primary" id="menu-toggle">Menüyü Göster/Gizle</button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
          <li class="nav-item active">
            <a class="nav-link" href="#">Ana Sayfa</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Ayarlar</a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container-fluid">
      <h1 class="mb-4">Satış ve İade Analizleri</h1>
      <!-- Stok Raporu Butonu Analiz Paneline Eklendi -->
      <div class="mb-4">
        <button class="btn btn-warning" onclick="window.location.href='/stock-report'">
          <i class="fas fa-boxes"></i> Stok Raporu
        </button>
      </div>

      <div class="row">
        <!-- Günlük Satışlar Kartı -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header bg-primary text-white">
              Günlük Satışlar
            </div>
            <div class="card-body">
              <canvas id="dailySalesChart"></canvas>
            </div>
          </div>
        </div>
        <!-- İade Nedenleri Kartı -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header bg-danger text-white">
              İade Nedenleri (Güncel Veri Okuma Grafiği)
            </div>
            <div class="card-body">
              <canvas id="returnsChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Ürün Bazlı Satış Analizi Kartı -->
      <div class="card">
        <div class="card-header bg-success text-white">
          Ürün Bazlı Satış Analizi
        </div>
        <div class="card-body">
          <canvas id="productSalesChart"></canvas>
        </div>
      </div>

      <!-- Ürün Bazlı Satışlar Tablosu -->
      <div class="card">
        <div class="card-header bg-info text-white">
          Ürün Bazlı Satışlar Tablosu
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="productSalesTable">
              <thead>
                <tr>
                  <th>Ürün ID</th>
                  <th>Renk</th>
                  <th>Beden</th>
                  <th>Satış Adedi</th>
                  <th>Toplam Gelir</th>
                  <th>Ortalama Fiyat</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div> <!-- container-fluid -->
  </div> <!-- page-content-wrapper -->
</div> <!-- wrapper -->

<!-- Sidebar Toggle Script -->
<script>
  document.getElementById("menu-toggle").addEventListener("click", function(e) {
    e.preventDefault();
    document.getElementById("wrapper").classList.toggle("toggled");
  });

  // Sidebar menü yönetimi
  document.querySelectorAll('.list-group-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      // Aktif sınıfı güncelle
      document.querySelectorAll('.list-group-item').forEach(i => i.classList.remove('active'));
      this.classList.add('active');
      
      // İlgili bölümü göster/gizle
      const section = this.getAttribute('data-section');
      document.querySelectorAll('.card').forEach(card => {
        if (section === 'dashboard') {
          card.style.display = 'block';
        } else if (section === 'stock' && card.querySelector('.card-header').textContent.trim() === 'Stok Durumu') {
          card.style.display = 'block';
        } else if (section === 'sales' && card.querySelector('.card-header').textContent.includes('Satış')) {
          card.style.display = 'block';
        } else if (section === 'returns' && card.querySelector('.card-header').textContent.includes('İade')) {
          card.style.display = 'block';
        } else if (section === 'products' && card.querySelector('.card-header').textContent.includes('Ürün')) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  });
</script>

<!-- Chart.js Kütüphanesi -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // API'den verileri çekiyoruz
  fetch('/api/sales-stats')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        createDailySalesChart(data.daily_sales);
        createReturnsChart(data.returns);
        createProductSalesChart(data.product_sales_chart);
        populateProductTable(data.product_sales);
      }
    })
    .catch(error => console.error('Veri çekme hatası:', error));
});

function createDailySalesChart(dailySales) {
  const ctx = document.getElementById('dailySalesChart').getContext('2d');
  const dates = dailySales.map(sale => sale.date);
  const orderCounts = dailySales.map(sale => sale.order_count);
  const totalAmounts = dailySales.map(sale => sale.total_amount);

  // Gradient tanımları
  const gradientOrders = ctx.createLinearGradient(0, 0, 0, 400);
  gradientOrders.addColorStop(0, 'rgba(0, 123, 255, 0.7)');
  gradientOrders.addColorStop(1, 'rgba(0, 123, 255, 0.3)');

  const gradientAmounts = ctx.createLinearGradient(0, 0, 0, 400);
  gradientAmounts.addColorStop(0, 'rgba(255, 193, 7, 0.7)');
  gradientAmounts.addColorStop(1, 'rgba(255, 193, 7, 0.3)');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Sipariş Sayısı',
        data: orderCounts,
        borderColor: 'rgba(0, 123, 255, 1)',
        backgroundColor: gradientOrders,
        fill: true,
        tension: 0.3,
        yAxisID: 'y'
      },
      {
        label: 'Toplam Tutar (TL)',
        data: totalAmounts,
        borderColor: 'rgba(255, 193, 7, 1)',
        backgroundColor: gradientAmounts,
        fill: true,
        tension: 0.3,
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          position: 'left',
          grid: { color: 'rgba(0,0,0,0.1)' }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}

function createReturnsChart(returns) {
  const ctx = document.getElementById('returnsChart').getContext('2d');
  const reasons = returns.map(r => r.reason);
  const counts = returns.map(r => r.count);

  // Gradient tanımı
  const gradientReturns = ctx.createLinearGradient(0, 0, 0, 400);
  gradientReturns.addColorStop(0, 'rgba(220, 53, 69, 0.7)');
  gradientReturns.addColorStop(1, 'rgba(220, 53, 69, 0.3)');

  new Chart(ctx, {
    type: 'bar', // Güncel veri okuma tipi olarak bar grafiği
    data: {
      labels: reasons,
      datasets: [{
        label: 'İade Sayısı',
        data: counts,
        backgroundColor: gradientReturns,
        borderColor: 'rgba(220, 53, 69, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.1)' }
        }
      }
    }
  });
}

function createProductSalesChart(productSalesData) {
  const ctx = document.getElementById('productSalesChart').getContext('2d');
  const productIds = productSalesData.map(item => item.product_id);
  const saleCounts = productSalesData.map(item => item.sale_count);
  const totalRevenues = productSalesData.map(item => item.total_revenue);

  // Gradient tanımları
  const gradientSales = ctx.createLinearGradient(0, 0, 0, 400);
  gradientSales.addColorStop(0, 'rgba(54, 162, 235, 0.7)');
  gradientSales.addColorStop(1, 'rgba(54, 162, 235, 0.3)');

  const gradientRevenues = ctx.createLinearGradient(0, 0, 0, 400);
  gradientRevenues.addColorStop(0, 'rgba(75, 192, 192, 0.7)');
  gradientRevenues.addColorStop(1, 'rgba(75, 192, 192, 0.3)');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: productIds,
      datasets: [{
        label: 'Satış Adedi',
        data: saleCounts,
        backgroundColor: gradientSales,
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1,
        yAxisID: 'y'
      },
      {
        label: 'Toplam Gelir',
        data: totalRevenues,
        backgroundColor: gradientRevenues,
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          position: 'left',
          grid: { color: 'rgba(0,0,0,0.1)' }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}

function populateProductTable(productSales) {
  const tbody = document.querySelector('#productSalesTable tbody');
  tbody.innerHTML = '';

  productSales.forEach(product => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${product.product_id}</td>
      <td>${product.color}</td>
      <td>${product.size}</td>
      <td>${product.sale_count}</td>
      <td>${product.total_revenue.toFixed(2)} TL</td>
      <td>${product.average_price.toFixed(2)} TL</td>
    `;
    tbody.appendChild(row);
  });
}
</script>
{% endblock %}
