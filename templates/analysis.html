{% extends "base.html" %}

{% block content %}
<!-- Dashboard Arayüzü için Ek CSS -->
<style>
  /* Genel Layout */
  #wrapper {
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  /* Sidebar Stilleri */
  #sidebar-wrapper {
    min-width: 250px;
    max-width: 250px;
    background: #343a40;
    color: #fff;
    transition: all 0.3s;
  }
  #sidebar-wrapper .sidebar-heading {
    padding: 1.5rem 1rem;
    font-size: 1.2rem;
    background: #23272b;
  }
  #sidebar-wrapper .list-group-item {
    background: #343a40;
    border: none;
    color: #adb5bd;
  }
  #sidebar-wrapper .list-group-item:hover {
    background: #495057;
    color: #fff;
  }
  /* Sayfa İçerik Stilleri */
  #page-content-wrapper {
    width: 100%;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
  }
  /* Navbar Düzenlemesi */
  .navbar {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  /* Kart Stilleri */
  .card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  .card-header {
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }
  /* Responsive Canvas Ayarı */
  canvas {
    width: 100% !important;
    max-height: 400px;
  }
  /* Sidebar Toggle Durumu */
  #wrapper.toggled #sidebar-wrapper {
    margin-left: -250px;
  }
</style>

<div id="wrapper">
  <!-- Sidebar (Stok Raporu butonu kaldırıldı) -->
  <div id="sidebar-wrapper">
    <div class="sidebar-heading">Analiz Paneli</div>
    <div class="list-group list-group-flush">
      <a href="#" class="list-group-item list-group-item-action active" data-section="dashboard">Dashboard</a>
      <a href="#" class="list-group-item list-group-item-action" data-section="sales">Satışlar</a>
      <a href="#" class="list-group-item list-group-item-action" data-section="returns">İadeler</a>
      <a href="#" class="list-group-item list-group-item-action" data-section="products">Ürün Analizleri</a>
      <a href="#" class="list-group-item list-group-item-action" data-section="stock">Stok Raporu</a>
    </div>
  </div>

  <!-- Sayfa İçeriği -->
  <div id="page-content-wrapper">
    <!-- Üst Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
      <button class="btn btn-primary" id="menu-toggle">Menüyü Göster/Gizle</button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
          <li class="nav-item active">
            <a class="nav-link" href="#">Ana Sayfa</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Ayarlar</a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row mb-4">
        <div class="col-lg-8">
          <h1>Satış ve İade Analizleri</h1>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-primary" onclick="setDateFilter('last7')">Son 7 Gün</button>
                  <button type="button" class="btn btn-outline-primary" onclick="setDateFilter('last30')">Son 30 Gün</button>
                  <button type="button" class="btn btn-outline-primary" onclick="setDateFilter('thisMonth')">Bu Ay</button>
                  <button type="button" class="btn btn-outline-primary" onclick="setDateFilter('thisYear')">Bu Yıl</button>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <label>Başlangıç Tarihi:</label>
                  <input type="date" id="startDate" class="form-control" onchange="updateCharts()">
                </div>
                <div class="col-md-6">
                  <label>Bitiş Tarihi:</label>
                  <input type="date" id="endDate" class="form-control" onchange="updateCharts()">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Günlük Satışlar Kartı -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header bg-primary text-white">
              Günlük Satışlar
            </div>
            <div class="card-body">
              <canvas id="dailySalesChart"></canvas>
            </div>
          </div>
        </div>
        <!-- İade Nedenleri Kartı -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header bg-danger text-white">
              İade Nedenleri (Güncel Veri Okuma Grafiği)
            </div>
            <div class="card-body">
              <canvas id="returnsChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Ürün Bazlı Satış Analizi Kartı -->
      <div class="card">
        <div class="card-header bg-success text-white">
          Ürün Bazlı Satış Analizi
        </div>
        <div class="card-body">
          <canvas id="productSalesChart"></canvas>
        </div>
      </div>

      <!-- Ürün Bazlı Satışlar Tablosu -->
      <div class="card">
        <div class="card-header bg-info text-white">
          Ürün Bazlı Satışlar Tablosu
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="productSalesTable">
              <thead>
                <tr>
                  <th>Ürün ID</th>
                  <th>Renk</th>
                  <th>Beden</th>
                  <th>Satış Adedi</th>
                  <th>Toplam Gelir</th>
                  <th>Ortalama Fiyat</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div> <!-- container-fluid -->
  </div> <!-- page-content-wrapper -->
</div> <!-- wrapper -->

<!-- Sidebar Toggle Script -->
<script>
  document.getElementById("menu-toggle").addEventListener("click", function(e) {
    e.preventDefault();
    document.getElementById("wrapper").classList.toggle("toggled");
  });

  // Sidebar menü yönetimi
  document.querySelectorAll('.list-group-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      // Aktif sınıfı güncelle
      document.querySelectorAll('.list-group-item').forEach(i => i.classList.remove('active'));
      this.classList.add('active');
      
      // İlgili bölümü göster/gizle
      const section = this.getAttribute('data-section');
      document.querySelectorAll('.card').forEach(card => {
        if (section === 'dashboard') {
          card.style.display = 'block';
        } else if (section === 'stock' && card.querySelector('.card-header').textContent.trim() === 'Stok Durumu') {
          card.style.display = 'block';
        } else if (section === 'sales' && card.querySelector('.card-header').textContent.includes('Satış')) {
          card.style.display = 'block';
        } else if (section === 'returns' && card.querySelector('.card-header').textContent.includes('İade')) {
          card.style.display = 'block';
        } else if (section === 'products' && card.querySelector('.card-header').textContent.includes('Ürün')) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  });
</script>

<!-- Chart.js Kütüphanesi -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  setDateFilter('last30'); // Varsayılan olarak son 30 günü göster
});

function setDateFilter(period) {
  const today = new Date();
  let startDate = new Date();
  
  switch(period) {
    case 'last7':
      startDate.setDate(today.getDate() - 7);
      break;
    case 'last30':
      startDate.setDate(today.getDate() - 30);
      break;
    case 'thisMonth':
      startDate = new Date(today.getFullYear(), today.getMonth(), 1);
      break;
    case 'thisYear':
      startDate = new Date(today.getFullYear(), 0, 1);
      break;
  }
  
  document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
  document.getElementById('endDate').value = today.toISOString().split('T')[0];
  updateCharts();
}

// Mevcut grafikleri saklamak için global değişkenler
let dailySalesChartInstance = null;
let returnsChartInstance = null;
let productSalesChartInstance = null;

function destroyCharts() {
    console.log("Mevcut grafikler temizleniyor...");
    if (dailySalesChartInstance) {
        dailySalesChartInstance.destroy();
        console.log("Günlük satış grafiği temizlendi");
    }
    if (returnsChartInstance) {
        returnsChartInstance.destroy();
        console.log("İade grafiği temizlendi");
    }
    if (productSalesChartInstance) {
        productSalesChartInstance.destroy();
        console.log("Ürün satış grafiği temizlendi");
    }
}

function updateCharts() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    console.log(`Tarih aralığı seçildi: ${startDate} - ${endDate}`);
    if (!startDate || !endDate) {
        console.warn("Tarih aralığı eksik!");
        return;
    }

    // Mevcut grafikleri temizle
    destroyCharts();

    // API'den verileri çek
    console.log("API isteği yapılıyor...");
    fetch(`/api/sales-stats?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            console.log('API yanıt durumu:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP hata! Durum: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API yanıt verisi:', data);
            if (data.success) {
                try {
                    console.log("Günlük satış verisi:", data.daily_sales);
                    dailySalesChartInstance = createDailySalesChart(data.daily_sales);
                    
                    console.log("İade verisi:", data.returns);
                    returnsChartInstance = createReturnsChart(data.returns);
                    
                    console.log("Ürün satış verisi:", data.product_sales_chart);
                    productSalesChartInstance = createProductSalesChart(data.product_sales_chart);
                    
                    console.log("Tablo güncelleniyor...");
                    populateProductTable(data.product_sales);
                    
                    console.log("Tüm grafikler başarıyla güncellendi");
                } catch (err) {
                    console.error("Grafik oluşturma hatası:", err);
                }
            } else {
                console.error("API başarısız yanıt döndü:", data.error);
            }
        })
        .catch(error => {
            console.error('Veri çekme hatası:', error);
            alert('Veri yüklenirken bir hata oluştu. Lütfen tekrar deneyin.');
        });
}

function createDailySalesChart(dailySales) {
  console.log("Günlük satış grafiği oluşturuluyor...");
  const ctx = document.getElementById('dailySalesChart').getContext('2d');
  if (!dailySales || !Array.isArray(dailySales)) {
    console.error("Geçersiz günlük satış verisi:", dailySales);
    return null;
  }
  const dates = dailySales.map(sale => sale.date);
  const orderCounts = dailySales.map(sale => sale.order_count);
  const totalAmounts = dailySales.map(sale => sale.total_amount);

  // Gradient tanımları
  const gradientOrders = ctx.createLinearGradient(0, 0, 0, 400);
  gradientOrders.addColorStop(0, 'rgba(0, 123, 255, 0.7)');
  gradientOrders.addColorStop(1, 'rgba(0, 123, 255, 0.3)');

  const gradientAmounts = ctx.createLinearGradient(0, 0, 0, 400);
  gradientAmounts.addColorStop(0, 'rgba(255, 193, 7, 0.7)');
  gradientAmounts.addColorStop(1, 'rgba(255, 193, 7, 0.3)');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Sipariş Sayısı',
        data: orderCounts,
        borderColor: 'rgba(0, 123, 255, 1)',
        backgroundColor: gradientOrders,
        fill: true,
        tension: 0.3,
        yAxisID: 'y'
      },
      {
        label: 'Toplam Tutar (TL)',
        data: totalAmounts,
        borderColor: 'rgba(255, 193, 7, 1)',
        backgroundColor: gradientAmounts,
        fill: true,
        tension: 0.3,
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          position: 'left',
          grid: { color: 'rgba(0,0,0,0.1)' }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}

function createReturnsChart(returns) {
  const ctx = document.getElementById('returnsChart').getContext('2d');
  const reasons = returns.map(r => r.reason);
  const counts = returns.map(r => r.count);

  // Gradient tanımı
  const gradientReturns = ctx.createLinearGradient(0, 0, 0, 400);
  gradientReturns.addColorStop(0, 'rgba(220, 53, 69, 0.7)');
  gradientReturns.addColorStop(1, 'rgba(220, 53, 69, 0.3)');

  new Chart(ctx, {
    type: 'bar', // Güncel veri okuma tipi olarak bar grafiği
    data: {
      labels: reasons,
      datasets: [{
        label: 'İade Sayısı',
        data: counts,
        backgroundColor: gradientReturns,
        borderColor: 'rgba(220, 53, 69, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.1)' }
        }
      }
    }
  });
}

function createProductSalesChart(productSalesData) {
  console.log('Gelen ürün satış verisi:', JSON.stringify(productSalesData, null, 2));
  
  if (!productSalesData || !Array.isArray(productSalesData)) {
    console.error('Geçersiz ürün satış verisi:', productSalesData);
    console.error('Veri tipi:', typeof productSalesData);
    console.error('Veri yapısı:', Object.prototype.toString.call(productSalesData));
    return;
  }

  const ctx = document.getElementById('productSalesChart').getContext('2d');
  const productIds = productSalesData.map(item => item.product_id || 'Bilinmeyen');
  const saleCounts = productSalesData.map(item => item.sale_count || 0);
  const totalRevenues = productSalesData.map(item => item.total_revenue || 0);

  // Gradient tanımları
  const gradientSales = ctx.createLinearGradient(0, 0, 0, 400);
  gradientSales.addColorStop(0, 'rgba(54, 162, 235, 0.7)');
  gradientSales.addColorStop(1, 'rgba(54, 162, 235, 0.3)');

  const gradientRevenues = ctx.createLinearGradient(0, 0, 0, 400);
  gradientRevenues.addColorStop(0, 'rgba(75, 192, 192, 0.7)');
  gradientRevenues.addColorStop(1, 'rgba(75, 192, 192, 0.3)');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: productIds,
      datasets: [{
        label: 'Satış Adedi',
        data: saleCounts,
        backgroundColor: gradientSales,
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1,
        yAxisID: 'y'
      },
      {
        label: 'Toplam Gelir',
        data: totalRevenues,
        backgroundColor: gradientRevenues,
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          position: 'left',
          grid: { color: 'rgba(0,0,0,0.1)' }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: { drawOnChartArea: false }
        }
      }
    }
  });
}

function populateProductTable(productSales) {
  const tbody = document.querySelector('#productSalesTable tbody');
  tbody.innerHTML = '';

  productSales.forEach(product => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${product.product_id}</td>
      <td>${product.color}</td>
      <td>${product.size}</td>
      <td>${product.sale_count}</td>
      <td>${product.total_revenue.toFixed(2)} TL</td>
      <td>${product.average_price.toFixed(2)} TL</td>
    `;
    tbody.appendChild(row);
  });
}
</script>
{% endblock %}
