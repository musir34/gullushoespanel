{% extends "base.html" %}
{% block content %}
<style>
.stats-container {
    padding: 2rem 0;
    background: #f8f9fa;
}

.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

.bg-primary, .bg-success, .bg-info {
    background: linear-gradient(45deg, #2193b0, #6dd5ed) !important;
}

.bg-success {
    background: linear-gradient(45deg, #11998e, #38ef7d) !important;
}

.bg-info {
    background: linear-gradient(45deg, #36d1dc, #5b86e5) !important;
}

.card-header {
    background: none;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 1.5rem 1.5rem 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-body {
    padding: 1.5rem;
}

.form-select {
    border-radius: 20px;
    padding: 0.375rem 1rem;
    border: 1px solid #e0e0e0;
    background-color: #f8f9fa;
}

.date-range-card {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.date-range-card input[type="date"] {
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    padding: 0.5rem 1rem;
}

.btn-primary {
    background: linear-gradient(45deg, #2193b0, #6dd5ed);
    border: none;
    border-radius: 20px;
    padding: 0.5rem 1.5rem;
    transition: all 0.3s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(33, 147, 176, 0.3);
}

#totalSales, #totalOrders, #avgOrderAmount {
    font-size: 1.8rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.card-title {
    color: rgba(255,255,255,0.9);
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.chart-container {
    padding: 1.5rem;
    background: white;
    border-radius: 15px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: transform 0.2s;
}

.chart-container:hover {
    transform: translateY(-5px);
}

.chart-title {
    font-size: 1.1rem;
    color: #333;
    margin-bottom: 1rem;
    font-weight: 500;
}

.stat-value {
    font-size: 2rem;
    font-weight: 600;
    color: #2193b0;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.5rem;
}

/* Tablo için ek stil */
.table thead th {
    background-color: #f0f0f0;
    font-weight: 600;
}

.table-hover tbody tr:hover {
    background-color: #f7f7f7;
    cursor: pointer;
}

.modal-header {
    background-color: #2193b0;
    color: #fff;
}

</style>

<div class="container mt-4">
    <h2>Satış Raporları</h2>

    <!-- Tarih Aralığı Seçimi -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tarih Aralığı</h5>
                    <div class="d-flex">
                        <input type="date" id="startDate" class="form-control mr-2">
                        <input type="date" id="endDate" class="form-control ml-2">
                        <button class="btn btn-primary ml-2" onclick="updateCharts()">Uygula</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Özet Kartları -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Toplam Satış</h5>
                    <h3 class="card-text" id="totalSales">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Toplam Sipariş</h5>
                    <h3 class="card-text" id="totalOrders">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Ortalama Sipariş Tutarı</h5>
                    <h3 class="card-text" id="avgOrderAmount">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Grafikler -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Günlük Satışlar (Son 30 Gün)</span>
                    <select class="form-select form-select-sm w-auto" id="dailyChartType">
                        <option value="amount">Tutar</option>
                        <option value="count">Adet</option>
                    </select>
                </div>
                <div class="card-body">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>En Çok Satan Ürünler</span>
                    <select class="form-select form-select-sm w-auto" id="productChartType">
                        <option value="amount">Tutar</option>
                        <option value="count">Adet</option>
                    </select>
                </div>
                <div class="card-body">
                    <canvas id="productSalesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Yeni Grafikler -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <span>Haftalık Büyüme</span>
                </div>
                <div class="card-body">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Yeni Analiz Kartları -->
    <div class="row mt-4">
        <!-- Müşteri Segmentleri -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <span>En İyi Müşteriler</span>
                </div>
                <div class="card-body">
                    <canvas id="customerSegmentChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Şehir Bazlı Satışlar -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <span>Şehir Bazlı Satışlar</span>
                </div>
                <div class="card-body">
                    <canvas id="cityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ürün Kategorileri -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <span>Ürün Kategorileri</span>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Günlük Satış Detayları Tablosu -->
    <div class="row mt-4">
        <div class="col-md-12">
            <h4>Günlük Satış Detayları</h4>
            <table class="table table-striped table-hover" id="dailySalesTable">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Satış Adedi</th>
                        <th>Satış Tutarı</th>
                        <th>Detay</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Ürün Satış Detayları Tablosu -->
    <div class="row mt-4">
        <div class="col-md-12">
            <h4>Ürün Satış Detayları</h4>
            <table class="table table-striped table-hover" id="productSalesTable">
                <thead>
                    <tr>
                        <th>Ürün Adı</th>
                        <th>SKU</th>
                        <th>Renk</th>
                        <th>Beden</th>
                        <th>Satış Adedi</th>
                        <th>Satış Tutarı</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS ile doldurulacak -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Detay Modal (isteğe bağlı örnek) -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">Sipariş Detayları</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <p id="orderDetailsContent">Sipariş detay bilgisi burada görüntülenecek.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Bootstrap 5 veya 4 kullanıyorsanız (örnek Bootstrap 5) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let dailyChart = null;
let productChart = null;
let salesData = null;

// Para formatlaması
function formatCurrency(amount) {
    return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY'
    }).format(amount);
}

// Özet Kartlarını Güncelle
function updateSummaryCards(data) {
    const totalAmount = data.daily_sales.reduce((sum, item) => sum + item.amount, 0);
    const totalCount = data.daily_sales.reduce((sum, item) => sum + item.count, 0);
    const avgAmount = totalCount === 0 ? 0 : (totalAmount / totalCount);

    document.getElementById('totalSales').textContent = formatCurrency(totalAmount);
    document.getElementById('totalOrders').textContent = totalCount;
    document.getElementById('avgOrderAmount').textContent = formatCurrency(avgAmount);
}

// Günlük Satışlar Grafiği
function createDailyChart(data, type = 'amount') {
    if (dailyChart) {
        dailyChart.destroy();
    }

    const ctx = document.getElementById('dailySalesChart').getContext('2d');
    dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.daily_sales.map(item => item.date),
            datasets: [{
                label: type === 'amount' ? 'Satış Tutarı' : 'Sipariş Adedi',
                data: data.daily_sales.map(item => type === 'amount' ? item.amount : item.count),
                borderColor: '#4CAF50',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return type === 'amount' ? formatCurrency(value) : `${value} adet`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return type === 'amount' ? formatCurrency(value) : value;
                        }
                    }
                }
            }
        }
    });
}

// En Çok Satan Ürünler Grafiği
function createProductChart(data, type = 'amount') {
    if (productChart) {
        productChart.destroy();
    }

    const ctx = document.getElementById('productSalesChart').getContext('2d');
    productChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.product_sales.map(item => {
                // Ürün adının yanında beden ve renk bilgileri de gösterilebilir
                const name = item.product_name || 'Ürün';
                const sku = item.sku || '-';
                const size = item.size || '-';
                const color = item.color || '-';
                return `${name} (${sku}) - ${size} / ${color}`;
            }),
            datasets: [{
                label: type === 'amount' ? 'Satış Tutarı' : 'Satış Adedi',
                data: data.product_sales.map(item => type === 'amount' ? item.amount : item.count),
                backgroundColor: '#2196F3'
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return type === 'amount' ? formatCurrency(value) : `${value} adet`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                },
                x: {
                    ticks: {
                        callback: function(value) {
                            return type === 'amount' ? formatCurrency(value) : value;
                        }
                    }
                }
            }
        }
    });
}

// Haftalık Büyüme Grafiği
function createGrowthChart(data) {
    const ctx = document.getElementById('growthChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.weekly_growth.map(w => w.week),
            datasets: [{
                label: 'Haftalık Büyüme (%)',
                data: data.weekly_growth.map(w => w.growth_rate),
                borderColor: '#FF6384',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => `%${value}`
                    }
                }
            }
        }
    });
}

// Müşteri Segmentleri Grafiği
function createCustomerSegmentChart(data) {
    const ctx = document.getElementById('customerSegmentChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.customer_segments.map(c => c.name),
            datasets: [{
                label: 'Toplam Harcama',
                data: data.customer_segments.map(c => c.total_spent),
                backgroundColor: '#4CAF50'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Toplam Harcama: ${formatCurrency(context.raw)}`;
                        },
                        afterLabel: function(context) {
                            const customer = data.customer_segments[context.dataIndex];
                            return `Sipariş Sayısı: ${customer.order_count}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

// Şehir Bazlı Satışlar Grafiği
function createCityChart(data) {
    const ctx = document.getElementById('cityChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.top_cities.map(c => c.city),
            datasets: [{
                data: data.top_cities.map(c => c.amount),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const city = data.top_cities[context.dataIndex];
                            const total = data.top_cities.reduce((a, b) => a + b.amount, 0);
                            const percentage = (context.raw / total * 100).toFixed(1);
                            return [
                                `Şehir: ${context.label}`,
                                `Tutar: ${formatCurrency(context.raw)}`,
                                `Oran: %${percentage}`,
                                `Sipariş Sayısı: ${city.order_count}`
                            ];
                        }
                    }
                }
            }
        }
    });
}

// Ürün Kategorileri Grafiği
function createCategoryChart(data) {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.product_categories.map(c => c.category),
            datasets: [{
                data: data.product_categories.map(c => c.amount),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${formatCurrency(context.raw)}`;
                        }
                    }
                }
            }
        }
    });
}

/* --- Tablo Veri Doldurma Fonksiyonları --- */
// Günlük Satışlar Tablosu
function populateDailySalesTable(data) {
    const tableBody = document.getElementById('dailySalesTable').querySelector('tbody');
    tableBody.innerHTML = ''; // Mevcut satırları temizle

    data.daily_sales.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.date}</td>
            <td>${item.count}</td>
            <td>${formatCurrency(item.amount)}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="showOrderDetailsModal('${item.date}')">
                    Detay
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Ürün Satışları Tablosu
function populateProductSalesTable(data) {
    const tableBody = document.getElementById('productSalesTable').querySelector('tbody');
    tableBody.innerHTML = ''; // Mevcut satırları temizle

    data.product_sales.forEach(item => {
        const row = document.createElement('tr');

        // Değerler yoksa '-' şeklinde gösterelim
        const productName = item.product_name || 'N/A';
        const sku = item.sku || '-';
        const color = item.color || '-';
        const size = item.size || '-';
        const count = item.count;
        const amount = formatCurrency(item.amount);

        row.innerHTML = `
            <td>${productName}</td>
            <td>${sku}</td>
            <td>${color}</td>
            <td>${size}</td>
            <td>${count}</td>
            <td>${amount}</td>
        `;
        tableBody.appendChild(row);
    });
}

// Detay Modal'i göstermek için örnek fonksiyon
function showOrderDetailsModal(date) {
    const modalEl = document.getElementById('orderDetailsModal');
    const modalBody = document.getElementById('orderDetailsContent');

    // Burada seçilen tarih ile ilgili daha detaylı bilgi fetch edebilirsiniz
    // veya data.daily_sales içinden ilgili öğeyi bulup gösterebilirsiniz.
    modalBody.innerText = date + " tarihli satış detayları burada gösterilecek.";

    // Bootstrap modal açma
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

// API'den veri çekip tüm bileşenleri güncelleyen fonksiyon
function updateCharts() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    fetch(`/api/sales-stats?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            salesData = data;
            // Özet kartları
            updateSummaryCards(data);
            // Grafikleri oluştur/güncelle
            createDailyChart(data, document.getElementById('dailyChartType').value);
            createProductChart(data, document.getElementById('productChartType').value);
            createGrowthChart(data);
            createCustomerSegmentChart(data);
            createCityChart(data);
            createCategoryChart(data);
            // Tabloları güncelle
            populateDailySalesTable(data);
            populateProductSalesTable(data);
        });
}

// Sayfa yüklendiğinde varsayılan tarihleri ayarla
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);

    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];

    updateCharts(); // Varsayılan olarak son 30 günlük veriyi yükle

    // Chart tiplerini seçince grafiği yenile
    document.getElementById('dailyChartType').addEventListener('change', function(e) {
        if (salesData) {
            createDailyChart(salesData, e.target.value);
        }
    });

    document.getElementById('productChartType').addEventListener('change', function(e) {
        if (salesData) {
            createProductChart(salesData, e.target.value);
        }
    });
});
</script>
{% endblock %}
