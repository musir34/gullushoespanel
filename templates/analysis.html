
{% extends "base.html" %}
{% block content %}
<style>
.stats-container {
    padding: 2rem 0;
    background: #f8f9fa;
}

.card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

.bg-primary, .bg-success, .bg-info {
    background: linear-gradient(45deg, #2193b0, #6dd5ed) !important;
}

.bg-success {
    background: linear-gradient(45deg, #11998e, #38ef7d) !important;
}

.bg-info {
    background: linear-gradient(45deg, #36d1dc, #5b86e5) !important;
}

.card-header {
    background: none;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 1.5rem 1.5rem 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-body {
    padding: 1.5rem;
}

.form-select {
    border-radius: 20px;
    padding: 0.375rem 1rem;
    border: 1px solid #e0e0e0;
    background-color: #f8f9fa;
}

.date-range-card {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.date-range-card input[type="date"] {
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    padding: 0.5rem 1rem;
}

.btn-primary {
    background: linear-gradient(45deg, #2193b0, #6dd5ed);
    border: none;
    border-radius: 20px;
    padding: 0.5rem 1.5rem;
    transition: all 0.3s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(33, 147, 176, 0.3);
}

#totalSales, #totalOrders, #avgOrderAmount {
    font-size: 1.8rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.card-title {
    color: rgba(255,255,255,0.9);
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.chart-container {
    padding: 1.5rem;
    background: white;
    border-radius: 15px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: transform 0.2s;
}

.chart-container:hover {
    transform: translateY(-5px);
}

.chart-title {
    font-size: 1.1rem;
    color: #333;
    margin-bottom: 1rem;
    font-weight: 500;
}

.stat-value {
    font-size: 2rem;
    font-weight: 600;
    color: #2193b0;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.5rem;
}
</style>

<div class="container mt-4">
    <h2>Satış Raporları</h2>
    
    <!-- Tarih Aralığı Seçimi -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tarih Aralığı</h5>
                    <div class="d-flex">
                        <input type="date" id="startDate" class="form-control mr-2">
                        <input type="date" id="endDate" class="form-control ml-2">
                        <button class="btn btn-primary ml-2" onclick="updateCharts()">Uygula</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Özet Kartları -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Toplam Satış</h5>
                    <h3 class="card-text" id="totalSales">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Toplam Sipariş</h5>
                    <h3 class="card-text" id="totalOrders">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Ortalama Sipariş Tutarı</h5>
                    <h3 class="card-text" id="avgOrderAmount">-</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Günlük Satışlar (Son 30 Gün)</span>
                    <select class="form-select form-select-sm w-auto" id="dailyChartType">
                        <option value="amount">Tutar</option>
                        <option value="count">Adet</option>
                    </select>
                </div>
                <div class="card-body">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>En Çok Satan Ürünler</span>
                    <select class="form-select form-select-sm w-auto" id="productChartType">
                        <option value="amount">Tutar</option>
                        <option value="count">Adet</option>
                    </select>
                </div>
                <div class="card-body">
                    <canvas id="productSalesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Yeni Grafikler -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <span>Haftalık Büyüme</span>
                </div>
                <div class="card-body">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Yeni Analiz Kartları -->
    <div class="row mt-4">
        <!-- Müşteri Segmentleri -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <span>En İyi Müşteriler</span>
                </div>
                <div class="card-body">
                    <canvas id="customerSegmentChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Şehir Bazlı Satışlar -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <span>Şehir Bazlı Satışlar</span>
                </div>
                <div class="card-body">
                    <canvas id="cityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ürün Kategorileri -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <span>Ürün Kategorileri</span>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Diğer scriptler aynı kalacak, sadece yeni grafik fonksiyonları eklenecek
function createCustomerSegmentChart(data) {
    const ctx = document.getElementById('customerSegmentChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.customer_segments.map(c => c.name),
            datasets: [{
                label: 'Toplam Harcama',
                data: data.customer_segments.map(c => c.total_spent),
                backgroundColor: '#4CAF50'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return formatCurrency(context.raw);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

function createCityChart(data) {
    const ctx = document.getElementById('cityChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.top_cities.map(c => c.city),
            datasets: [{
                data: data.top_cities.map(c => c.amount),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${formatCurrency(context.raw)}`;
                        }
                    }
                }
            }
        }
    });
}

function createCategoryChart(data) {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.product_categories.map(c => c.category),
            datasets: [{
                data: data.product_categories.map(c => c.amount),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${formatCurrency(context.raw)}`;
                        }
                    }
                }
            }
        }
    });
}

// Mevcut updateCharts fonksiyonunu güncelle
function updateCharts() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    fetch(`/api/sales-stats?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            salesData = data;
            updateSummaryCards(data);
            createDailyChart(data);
            createProductChart(data);
            createGrowthChart(data);
            createCustomerSegmentChart(data);
            createCityChart(data);
            createCategoryChart(data);
        });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function updateCharts() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    fetch(`/api/sales-stats?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            salesData = data;
            updateSummaryCards(data);
            createDailyChart(data);
            createProductChart(data);
            createGrowthChart(data);
            createCustomerSegmentChart(data);
            createCityChart(data);
            createCategoryChart(data);
        });
}

function createGrowthChart(data) {
    const ctx = document.getElementById('growthChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.weekly_growth.map(w => w.week),
            datasets: [{
                label: 'Haftalık Büyüme (%)',
                data: data.weekly_growth.map(w => w.growth_rate),
                borderColor: '#FF6384',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => `%${value}`
                    }
                }
            }
        }
    });
}

function createPaymentChart(data) {
    const ctx = document.getElementById('paymentChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.payment_methods.map(p => p.method),
            datasets: [{
                data: data.payment_methods.map(p => p.amount),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0'
                ]
            }]
        },
        options: {
            responsive: true
        }
    });
}

// Sayfa yüklendiğinde varsayılan tarihleri ayarla
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    
    updateCharts();
});
</script>
<script>
let dailyChart = null;
let productChart = null;
let salesData = null;

function formatCurrency(amount) {
    return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY'
    }).format(amount);
}

function updateSummaryCards(data) {
    const totalAmount = data.daily_sales.reduce((sum, item) => sum + item.amount, 0);
    const totalCount = data.daily_sales.reduce((sum, item) => sum + item.count, 0);
    const avgAmount = totalAmount / totalCount;

    document.getElementById('totalSales').textContent = formatCurrency(totalAmount);
    document.getElementById('totalOrders').textContent = totalCount;
    document.getElementById('avgOrderAmount').textContent = formatCurrency(avgAmount);
}

function createDailyChart(data, type = 'amount') {
    if (dailyChart) {
        dailyChart.destroy();
    }

    const ctx = document.getElementById('dailySalesChart').getContext('2d');
    dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.daily_sales.map(item => item.date),
            datasets: [{
                label: type === 'amount' ? 'Satış Tutarı' : 'Sipariş Adedi',
                data: data.daily_sales.map(item => type === 'amount' ? item.amount : item.count),
                borderColor: '#4CAF50',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return type === 'amount' ? formatCurrency(value) : `${value} adet`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return type === 'amount' ? formatCurrency(value) : value;
                        }
                    }
                }
            }
        }
    });
}

function createProductChart(data, type = 'amount') {
    if (productChart) {
        productChart.destroy();
    }

    const ctx = document.getElementById('productSalesChart').getContext('2d');
    productChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.product_sales.map(item => item.name),
            datasets: [{
                label: type === 'amount' ? 'Satış Tutarı' : 'Satış Adedi',
                data: data.product_sales.map(item => type === 'amount' ? item.amount : item.count),
                backgroundColor: '#2196F3'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return type === 'amount' ? formatCurrency(value) : `${value} adet`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return type === 'amount' ? formatCurrency(value) : value;
                        }
                    }
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/sales-stats')
        .then(response => response.json())
        .then(data => {
            salesData = data;
            updateSummaryCards(data);
            createDailyChart(data);
            createProductChart(data);
        });

    document.getElementById('dailyChartType').addEventListener('change', function(e) {
        if (salesData) {
            createDailyChart(salesData, e.target.value);
        }
    });

    document.getElementById('productChartType').addEventListener('change', function(e) {
        if (salesData) {
            createProductChart(salesData, e.target.value);
        }
    });
});
</script>
{% endblock %}
