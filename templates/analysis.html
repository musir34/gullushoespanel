
{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Satış Raporları</h2>
    
    <!-- Tarih Aralığı Seçimi -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Tarih Aralığı</h5>
                    <div class="d-flex">
                        <input type="date" id="startDate" class="form-control mr-2">
                        <input type="date" id="endDate" class="form-control ml-2">
                        <button class="btn btn-primary ml-2" onclick="updateCharts()">Uygula</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Özet Kartları -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">Toplam Satış</h5>
                    <h3 class="card-text" id="totalSales">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Toplam Sipariş</h5>
                    <h3 class="card-text" id="totalOrders">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Ortalama Sipariş Tutarı</h5>
                    <h3 class="card-text" id="avgOrderAmount">-</h3>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Günlük Satışlar (Son 30 Gün)</span>
                    <select class="form-select form-select-sm w-auto" id="dailyChartType">
                        <option value="amount">Tutar</option>
                        <option value="count">Adet</option>
                    </select>
                </div>
                <div class="card-body">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>En Çok Satan Ürünler</span>
                    <select class="form-select form-select-sm w-auto" id="productChartType">
                        <option value="amount">Tutar</option>
                        <option value="count">Adet</option>
                    </select>
                </div>
                <div class="card-body">
                    <canvas id="productSalesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Yeni Grafikler -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <span>Haftalık Büyüme</span>
                </div>
                <div class="card-body">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function updateCharts() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    fetch(`/api/sales-stats?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            salesData = data;
            updateSummaryCards(data);
            createDailyChart(data);
            createProductChart(data);
            createGrowthChart(data);
        });
}

function createGrowthChart(data) {
    const ctx = document.getElementById('growthChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.weekly_growth.map(w => w.week),
            datasets: [{
                label: 'Haftalık Büyüme (%)',
                data: data.weekly_growth.map(w => w.growth_rate),
                borderColor: '#FF6384',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => `%${value}`
                    }
                }
            }
        }
    });
}

function createPaymentChart(data) {
    const ctx = document.getElementById('paymentChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.payment_methods.map(p => p.method),
            datasets: [{
                data: data.payment_methods.map(p => p.amount),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0'
                ]
            }]
        },
        options: {
            responsive: true
        }
    });
}

// Sayfa yüklendiğinde varsayılan tarihleri ayarla
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    
    updateCharts();
});
</script>
<script>
let dailyChart = null;
let productChart = null;
let salesData = null;

function formatCurrency(amount) {
    return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY'
    }).format(amount);
}

function updateSummaryCards(data) {
    const totalAmount = data.daily_sales.reduce((sum, item) => sum + item.amount, 0);
    const totalCount = data.daily_sales.reduce((sum, item) => sum + item.count, 0);
    const avgAmount = totalAmount / totalCount;

    document.getElementById('totalSales').textContent = formatCurrency(totalAmount);
    document.getElementById('totalOrders').textContent = totalCount;
    document.getElementById('avgOrderAmount').textContent = formatCurrency(avgAmount);
}

function createDailyChart(data, type = 'amount') {
    if (dailyChart) {
        dailyChart.destroy();
    }

    const ctx = document.getElementById('dailySalesChart').getContext('2d');
    dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.daily_sales.map(item => item.date),
            datasets: [{
                label: type === 'amount' ? 'Satış Tutarı' : 'Sipariş Adedi',
                data: data.daily_sales.map(item => type === 'amount' ? item.amount : item.count),
                borderColor: '#4CAF50',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return type === 'amount' ? formatCurrency(value) : `${value} adet`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return type === 'amount' ? formatCurrency(value) : value;
                        }
                    }
                }
            }
        }
    });
}

function createProductChart(data, type = 'amount') {
    if (productChart) {
        productChart.destroy();
    }

    const ctx = document.getElementById('productSalesChart').getContext('2d');
    productChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.product_sales.map(item => item.name),
            datasets: [{
                label: type === 'amount' ? 'Satış Tutarı' : 'Satış Adedi',
                data: data.product_sales.map(item => type === 'amount' ? item.amount : item.count),
                backgroundColor: '#2196F3'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return type === 'amount' ? formatCurrency(value) : `${value} adet`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return type === 'amount' ? formatCurrency(value) : value;
                        }
                    }
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/sales-stats')
        .then(response => response.json())
        .then(data => {
            salesData = data;
            updateSummaryCards(data);
            createDailyChart(data);
            createProductChart(data);
        });

    document.getElementById('dailyChartType').addEventListener('change', function(e) {
        if (salesData) {
            createDailyChart(salesData, e.target.value);
        }
    });

    document.getElementById('productChartType').addEventListener('change', function(e) {
        if (salesData) {
            createProductChart(salesData, e.target.value);
        }
    });
});
</script>
{% endblock %}
