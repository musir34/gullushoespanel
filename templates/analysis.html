{% extends "base.html" %}

{% block content %}
<!-- Dashboard Arayüzü için Ek CSS -->
<style>
  /* Genel Layout */
  #wrapper {
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  /* Sidebar Stilleri */
  #sidebar-wrapper {
    min-width: 250px;
    max-width: 250px;
    background: #343a40;
    color: #fff;
    transition: all 0.3s;
  }
  #sidebar-wrapper .sidebar-heading {
    padding: 1.5rem 1rem;
    font-size: 1.2rem;
    background: #23272b;
  }
  #sidebar-wrapper .list-group-item {
    background: #343a40;
    border: none;
    color: #adb5bd;
  }
  #sidebar-wrapper .list-group-item:hover {
    background: #495057;
    color: #fff;
  }
  /* Sayfa İçerik Stilleri */
  #page-content-wrapper {
    width: 100%;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
  }
  /* Navbar Düzenlemesi */
  .navbar {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  /* Kart Stilleri */
  .card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    margin-bottom: 20px;
  }
  .card-header {
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
  }
  /* Responsive Canvas Ayarı */
  canvas {
    width: 100% !important;
    max-height: 400px;
  }
  /* Sidebar Toggle Durumu */
  #wrapper.toggled #sidebar-wrapper {
    margin-left: -250px;
  }
</style>

<div id="wrapper">
  <!-- Sidebar -->
  <div id="sidebar-wrapper">
    <div class="sidebar-heading">Analiz Paneli</div>
    <div class="list-group list-group-flush">
      <a href="#" class="list-group-item list-group-item-action">Dashboard</a>
      <a href="#" class="list-group-item list-group-item-action">Satışlar</a>
      <a href="#" class="list-group-item list-group-item-action">İadeler</a>
      <a href="#" class="list-group-item list-group-item-action">Ürün Analizleri</a>
    </div>
  </div>

  <!-- Sayfa İçeriği -->
  <div id="page-content-wrapper">
    <!-- Üst Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
      <button class="btn btn-primary" id="menu-toggle">Menüyü Göster/Gizle</button>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto mt-2 mt-lg-0">
          <li class="nav-item active">
            <a class="nav-link" href="#">Ana Sayfa</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Ayarlar</a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container-fluid">
      <h1 class="mb-4">Satış ve İade Analizleri</h1>

      <div class="row">
        <!-- Günlük Satışlar Kartı -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header bg-primary text-white">
              Günlük Satışlar
            </div>
            <div class="card-body">
              <canvas id="dailySalesChart"></canvas>
            </div>
          </div>
        </div>
        <!-- İade Nedenleri Kartı -->
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header bg-danger text-white">
              İade Nedenleri (Radar Analizi)
            </div>
            <div class="card-body">
              <canvas id="returnsChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Stok Raporu Kartı -->
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          Stok Durumu
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="stockTable">
              <thead>
                <tr>
                  <th>Ürün ID</th>
                  <th>Renk</th>
                  <th>Beden</th>
                  <th>Toplam Stok</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ürün Bazlı Satışlar Tablosu -->
      <div class="card">
        <div class="card-header bg-success text-white">
          Ürün Bazlı Satışlar
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="productSalesTable">
              <thead>
                <tr>
                  <th>Ürün ID</th>
                  <th>Renk</th>
                  <th>Beden</th>
                  <th>Satış Adedi</th>
                  <th>Toplam Gelir</th>
                  <th>Ortalama Fiyat</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div> <!-- container-fluid -->
  </div> <!-- page-content-wrapper -->
</div> <!-- wrapper -->

<!-- Sidebar Toggle Script -->
<script>
  document.getElementById("menu-toggle").addEventListener("click", function(e) {
    e.preventDefault();
    document.getElementById("wrapper").classList.toggle("toggled");
  });
</script>

<!-- Chart.js Kütüphanesi -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // API'den verileri çekiyoruz
  fetch('/api/sales-stats')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        createDailySalesChart(data.daily_sales);
        createReturnsChart(data.returns);
        populateProductTable(data.product_sales);
        populateStockTable(data.stock_stats);
      }
    })
    .catch(error => console.error('Veri çekme hatası:', error));
});

function createDailySalesChart(dailySales) {
  const ctx = document.getElementById('dailySalesChart').getContext('2d');
  const dates = dailySales.map(sale => sale.date);
  const orderCounts = dailySales.map(sale => sale.order_count);
  const totalAmounts = dailySales.map(sale => sale.total_amount);

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Sipariş Sayısı',
        data: orderCounts,
        borderColor: 'rgba(255, 255, 255, 0.9)',
        backgroundColor: 'rgba(0, 123, 255, 0.5)',
        fill: true,
        tension: 0.3
      },
      {
        label: 'Toplam Tutar (TL)',
        data: totalAmounts,
        borderColor: 'rgba(255, 193, 7, 0.9)',
        backgroundColor: 'rgba(255, 193, 7, 0.5)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0,0,0,0.1)'
          }
        }
      }
    }
  });
}

function createReturnsChart(returns) {
  const ctx = document.getElementById('returnsChart').getContext('2d');
  const reasons = returns.map(r => r.reason);
  const counts = returns.map(r => r.count);

  new Chart(ctx, {
    type: 'radar',
    data: {
      labels: reasons,
      datasets: [{
        label: 'İade Sayısı',
        data: counts,
        backgroundColor: 'rgba(220, 53, 69, 0.3)',
        borderColor: 'rgba(220, 53, 69, 1)',
        pointBackgroundColor: 'rgba(220, 53, 69, 1)'
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0,0,0,0.1)'
          }
        }
      },
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
}

function populateStockTable(stockStats) {
  const tbody = document.querySelector('#stockTable tbody');
  tbody.innerHTML = '';

  stockStats.forEach(stock => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${stock.product_id}</td>
      <td>${stock.color}</td>
      <td>${stock.size}</td>
      <td>${stock.total_stock}</td>
    `;
    tbody.appendChild(row);
  });
}

function populateProductTable(productSales) {
  const tbody = document.querySelector('#productSalesTable tbody');
  tbody.innerHTML = '';

  productSales.forEach(product => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${product.product_id}</td>
      <td>${product.color}</td>
      <td>${product.size}</td>
      <td>${product.sale_count}</td>
      <td>${product.total_revenue.toFixed(2)} TL</td>
      <td>${product.average_price.toFixed(2)} TL</td>
    `;
    tbody.appendChild(row);
  });
}
</script>
{% endblock %}
