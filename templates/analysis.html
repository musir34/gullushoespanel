{% extends "base.html" %}

{% block content %}
<!-- Modern Analiz Sayfası -->
<div class="dashboard-container">
  <!-- Üst Kontrol Paneli -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-body p-0">
          <div class="d-flex flex-wrap align-items-center">
            <!-- Tarih Seçici -->
            <div class="date-selector p-3 flex-grow-1">
              <div class="d-flex align-items-center">
                <div class="btn-group me-3">
                  <button type="button" class="btn btn-sm btn-outline-primary quick-filter active" data-filter="last7">Son 7 Gün</button>
                  <button type="button" class="btn btn-sm btn-outline-primary quick-filter" data-filter="last30">Son 30 Gün</button>
                  <button type="button" class="btn btn-sm btn-outline-primary quick-filter" data-filter="this_month">Bu Ay</button>
                </div>
                <div class="custom-date-range d-flex align-items-center">
                  <input type="date" class="form-control form-control-sm" id="startDate">
                  <span class="mx-2">-</span>
                  <input type="date" class="form-control form-control-sm" id="endDate">
                  <button id="filterByDate" class="btn btn-sm btn-primary ms-2">Uygula</button>
                </div>
              </div>
            </div>
            <!-- Dışa Aktarma Butonu -->
            <div class="export-buttons p-3 border-start">
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-download me-1"></i> Dışa Aktar
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
                  <li><a class="dropdown-item" href="#" id="exportExcel"><i class="bi bi-file-excel me-2"></i>Excel</a></li>
                  <li><a class="dropdown-item" href="#" id="exportPDF"><i class="bi bi-file-pdf me-2"></i>PDF</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" id="printReport"><i class="bi bi-printer me-2"></i>Yazdır</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Özet Metrikler -->
  <div class="row mb-4">
    <!-- Toplam Sipariş -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Toplam Sipariş</div>
              <div class="d-flex align-items-center">
                <h3 class="mb-0" id="totalOrders">0</h3>
                <div class="trend-indicator ms-2 small">
                  <span class="text-success"><i class="bi bi-arrow-up me-1"></i>3.2%</span>
                </div>
              </div>
            </div>
            <div class="bg-primary bg-opacity-10 p-3 rounded">
              <i class="bi bi-cart-check text-primary fs-3"></i>
            </div>
          </div>
          <div class="progress mt-3" style="height: 3px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: 70%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Satılan Ürün -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Satılan Ürün Adedi</div>
              <div class="d-flex align-items-center">
                <h3 class="mb-0" id="totalItemsSold">0</h3>
                <div class="trend-indicator ms-2 small">
                  <span class="text-success"><i class="bi bi-arrow-up me-1"></i>1.8%</span>
                </div>
              </div>
            </div>
            <div class="bg-success bg-opacity-10 p-3 rounded">
              <i class="bi bi-box-seam text-success fs-3"></i>
            </div>
          </div>
          <div class="progress mt-3" style="height: 3px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: 60%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toplam Gelir -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Toplam Ciro (TL)</div>
              <div class="d-flex align-items-center">
                <h3 class="mb-0" id="totalRevenue">0</h3>
                <div class="trend-indicator ms-2 small">
                  <span class="text-success"><i class="bi bi-arrow-up me-1"></i>4.5%</span>
                </div>
              </div>
            </div>
            <div class="bg-warning bg-opacity-10 p-3 rounded">
              <i class="bi bi-coin text-warning fs-3"></i>
            </div>
          </div>
          <div class="progress mt-3" style="height: 3px;">
            <div class="progress-bar bg-warning" role="progressbar" style="width: 80%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- İade Oranı -->
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">İade Oranı</div>
              <div class="d-flex align-items-center">
                <h3 class="mb-0" id="returnRate">%0</h3>
                <div class="trend-indicator ms-2 small">
                  <span class="text-danger"><i class="bi bi-arrow-down me-1"></i>0.5%</span>
                </div>
              </div>
            </div>
            <div class="bg-danger bg-opacity-10 p-3 rounded">
              <i class="bi bi-arrow-return-left text-danger fs-3"></i>
            </div>
          </div>
          <div class="progress mt-3" style="height: 3px;">
            <div class="progress-bar bg-danger" role="progressbar" style="width: 25%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ana Grafik ve Ürün Tablosu -->
  <div class="row mb-4">
    <!-- Satış Trendi Grafiği -->
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Satış Trendi</h5>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary chart-period active" data-period="daily">Günlük</button>
            <button type="button" class="btn btn-outline-secondary chart-period" data-period="weekly">Haftalık</button>
            <button type="button" class="btn btn-outline-secondary chart-period" data-period="monthly">Aylık</button>
          </div>
        </div>
        <div class="card-body">
          <canvas id="salesTrendChart" height="280"></canvas>
        </div>
      </div>
    </div>

    <!-- En Çok Satan Ürünler -->
    <div class="col-lg-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">En Çok Satan Ürünler</h5>
        </div>
        <div class="card-body px-0 pb-0">
          <div class="table-responsive" style="height: 280px; overflow-y: auto;">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="px-3">Merchant SKU</th>
                  <th>Ürün</th>
                  <th class="text-end px-3">Adet</th>
                  <th class="text-end px-3">Toplam</th>
                </tr>
              </thead>
              <tbody id="topProductsTable">
                <!-- JavaScript ile doldurulacak -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- İkinci Sıra -->
  <div class="row mb-4">
    <!-- Satış Dağılımı -->
    <div class="col-md-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Satış Dağılımı</h5>
        </div>
        <div class="card-body">
          <canvas id="salesDistributionChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- Sipariş Saatleri -->
    <div class="col-md-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Sipariş Saatleri</h5>
        </div>
        <div class="card-body">
          <canvas id="salesHoursChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- İade Nedenleri -->
    <div class="col-md-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">İade Nedenleri</h5>
        </div>
        <div class="card-body">
          <canvas id="returnsChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Üçüncü Sıra -->
  <div class="row mb-4">
    <!-- Kategori Performansı -->
    <div class="col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Kategori Performansı</h5>
        </div>
        <div class="card-body">
          <canvas id="categorySalesChart" height="300"></canvas>
        </div>
      </div>
    </div>

    <!-- Haftalık Karşılaştırma -->
    <div class="col-md-6 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Haftalık Karşılaştırma</h5>
        </div>
        <div class="card-body">
          <canvas id="weeklyComparisonChart" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Dördüncü Sıra - AI Öngörüleri ve Tablo -->
  <div class="row mb-4">
    <!-- AI Öngörüleri -->
    <div class="col-lg-4 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Öngörüleri</h5>
          <button id="refreshAiInsights" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
        <div class="card-body">
          <div id="aiInsightContainer" class="p-3 border rounded bg-light mb-3" style="height: 250px; overflow-y: auto;">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="placeholder-glow">
              <span class="placeholder col-7"></span>
              <span class="placeholder col-4"></span>
              <span class="placeholder col-4"></span>
              <span class="placeholder col-6"></span>
              <span class="placeholder col-8"></span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Ürün Bazlı Satış Tablosu -->
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Ürün Bazlı Satışlar</h5>
          <div class="input-group input-group-sm" style="width: 200px;">
            <input type="text" class="form-control" placeholder="Ürün Ara..." id="productSearchInput">
            <button class="btn btn-outline-secondary" type="button" id="productSearchButton">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
        <div class="card-body px-0 pb-0">
          <div class="table-responsive" style="height: 250px; overflow-y: auto;">
            <table class="table table-hover align-middle mb-0" id="productSalesTable">
              <thead class="table-light">
                <tr>
                  <th class="ps-3">Merchant SKU</th>
                  <th>Ürün ID</th>
                  <th>Renk</th>
                  <th>Beden</th>
                  <th class="text-end">Adet</th>
                  <th class="text-end">Gelir (TL)</th>
                  <th class="text-end pe-3">Ort. Fiyat</th>
                </tr>
              </thead>
              <tbody>
                <!-- JavaScript ile doldurulacak -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gelecek Tahminleri -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0">
          <h5 class="mb-0">Gelecek 30 Gün Satış Tahmini</h5>
        </div>
        <div class="card-body">
          <canvas id="salesPredictionChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stil ve Scriptler -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>

<style>
  .dashboard-container {
    padding: 1.5rem;
    background-color: #f8f9fa;
  }

  .card {
    border-radius: 0.625rem;
    transition: all 0.3s ease;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08) !important;
  }

  .card-header {
    padding: 1rem 1.25rem;
    font-weight: 500;
  }

  th {
    font-weight: 500;
    white-space: nowrap;
  }

  .progress {
    background-color: rgba(0, 0, 0, 0.05);
  }

  .trend-indicator {
    font-size: 0.75rem;
    line-height: 1;
  }

  .chart-period.active {
    background-color: #6c757d;
    color: white;
  }

  #aiInsightContainer {
    font-size: 0.9rem;
    background-color: #f8f9fb !important;
    border-color: #e9ecef !important;
  }

  .table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }
</style>

<script>
  // Genel değişkenler
  let salesTrendChart, salesDistributionChart, salesHoursChart, 
      returnsChart, categorySalesChart, weeklyComparisonChart,
      salesPredictionChart;

  document.addEventListener("DOMContentLoaded", () => {
    // Tarih kontrollerini ayarla
    setupDateControls();

    // Sayfa yüklendiğinde varsayılan verileri çek
    loadSalesStats();

    // AI öngörülerini yükle
    setTimeout(loadAiInsights, 1500);

    // Grafik türlerini değiştirme olayları
    document.querySelectorAll('.chart-period').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.chart-period').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // Seçilen döneme göre satış trendini güncelle (günlük, haftalık, aylık)
        updateSalesTrendPeriod(this.getAttribute('data-period'));
      });
    });

    // Hızlı filtre butonları
    document.querySelectorAll('.quick-filter').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelectorAll('.quick-filter').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        const filterValue = this.getAttribute('data-filter');
        loadSalesStats(`?quick_filter=${filterValue}`);
      });
    });

    // Tarih aralığı filtresi
    document.getElementById('filterByDate').addEventListener('click', function() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) {
        alert('Lütfen başlangıç ve bitiş tarihlerini seçin.');
        return;
      }
      loadSalesStats(`?start_date=${startDate}&end_date=${endDate}`);
    });

    // AI öngörülerini yenile
    document.getElementById('refreshAiInsights').addEventListener('click', function() {
      const container = document.getElementById('aiInsightContainer');
      container.innerHTML = `
        <div class="d-flex justify-content-center align-items-center h-100">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
          </div>
        </div>
      `;
      loadAiInsights();
    });

    // Dışa aktarma butonları
    setupExportButtons();

    // Ürün arama
    document.getElementById('productSearchButton').addEventListener('click', searchProducts);
    document.getElementById('productSearchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchProducts();
      }
    });
  });

  // Tarih kontrollerini ayarla
  function setupDateControls() {
    // Bugünün tarihini al
    const today = new Date();

    // Bitiş tarihi olarak bugünü ayarla
    const endDateInput = document.getElementById('endDate');
    endDateInput.valueAsDate = today;

    // Başlangıç tarihi olarak 30 gün öncesini ayarla
    const startDate = new Date();
    startDate.setDate(today.getDate() - 30);
    const startDateInput = document.getElementById('startDate');
    startDateInput.valueAsDate = startDate;
  }

  // Dışa aktarma butonlarını ayarla
  function setupExportButtons() {
    document.getElementById('exportExcel').addEventListener('click', function() {
      alert('Excel dışa aktarma işlemi başlatılıyor...');
      // Excel dışa aktarma kodu buraya gelecek
    });

    document.getElementById('exportPDF').addEventListener('click', function() {
      alert('PDF dışa aktarma işlemi başlatılıyor...');
      // PDF dışa aktarma kodu buraya gelecek
    });

    document.getElementById('printReport').addEventListener('click', function() {
      window.print();
    });
  }

  // Ürün arama fonksiyonu
  function searchProducts() {
    const searchTerm = document.getElementById('productSearchInput').value.trim().toLowerCase();
    const table = document.getElementById('productSalesTable');
    const rows = table.querySelectorAll('tbody tr');

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      if (text.includes(searchTerm) || searchTerm === '') {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  // Sales Stats verilerini yükle
  async function loadSalesStats(queryParams = '') {
    try {
      const response = await fetch('/api/sales-stats' + queryParams);
      const data = await response.json();
      console.log('API yanıt verisi:', data);

      if (data.success) {
        // Özet Bilgileri doldur
        document.getElementById('totalOrders').innerText = data.total_orders ?? 0;
        document.getElementById('totalItemsSold').innerText = data.total_items_sold ?? 0;
        document.getElementById('totalRevenue').innerText = formatCurrency(data.total_revenue ?? 0);

        // İade oranı hesapla (şimdilik sabit)
        const returnRate = calculateReturnRate(data);
        document.getElementById('returnRate').innerText = `%${returnRate.toFixed(1)}`;

        // Grafikleri güncelle
        createSalesTrendChart(data.daily_sales);
        createSalesDistributionChart(data.product_sales_chart);
        createSalesHoursChart();
        createReturnsChart(data.returns);
        createCategorySalesChart();
        createWeeklyComparisonChart();
        createSalesPredictionChart();

        // Tabloları doldur
        populateTopProductsTable(data.product_sales_chart);
        populateProductTable(data.product_sales);
      } else {
        console.error('API hatası:', data.error);
        showError('Veri yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.');
      }
    } catch (error) {
      console.error('Veri çekme hatası:', error);
      showError('Sunucu bağlantısında bir sorun oluştu. Lütfen internet bağlantınızı kontrol edin.');
    }
  }

  // İade oranı hesaplama
  function calculateReturnRate(data) {
    // Gerçek hesaplama yerine şimdilik sabit değer
    return 5.2;
  }

  // Para formatı
  function formatCurrency(value) {
    return new Intl.NumberFormat('tr-TR', { 
      minimumFractionDigits: 2, 
      maximumFractionDigits: 2 
    }).format(value) + " ₺";
  }

  // Hata mesajı gösterme
  function showError(message) {
    // Bootstrap toast veya alert
    alert(message);
  }

  // Satış Trendi Grafiği
  function createSalesTrendChart(dailySales) {
    const ctx = document.getElementById('salesTrendChart').getContext('2d');
    if (salesTrendChart) salesTrendChart.destroy();

    if (!dailySales || dailySales.length === 0) {
      console.warn('Günlük satış verisi bulunamadı');
      return;
    }

    // Verileri düzenle (ters çevir - en eskiden yeniye)
    const sortedSales = [...dailySales].reverse();
    const dates = sortedSales.map(sale => sale.date);
    const revenues = sortedSales.map(sale => sale.total_amount || 0);
    const orderCounts = sortedSales.map(sale => sale.order_count || 0);

    // Grafik oluştur
    salesTrendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'Toplam Ciro (₺)',
            data: revenues,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: createGradient(ctx, 'rgba(75, 192, 192, 0.2)'),
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            yAxisID: 'y'
          },
          {
            label: 'Sipariş Sayısı',
            data: orderCounts,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'transparent',
            borderWidth: 2,
            tension: 0.3,
            borderDash: [],
            fill: false,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.datasetIndex === 0) {
                  label += formatCurrency(context.raw);
                } else {
                  label += context.raw;
                }
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 10
              },
              maxTicksLimit: 10
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            grid: {
              borderDash: [3, 3]
            },
            title: {
              display: true,
              text: 'Ciro (₺)'
            },
            ticks: {
              callback: function(value) {
                return value.toLocaleString('tr-TR');
              }
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            grid: {
              display: false
            },
            title: {
              display: true,
              text: 'Sipariş Sayısı'
            }
          }
        }
      }
    });
  }

  // Satış trendini periyoda göre güncelle
  function updateSalesTrendPeriod(period) {
    // Bu fonksiyon period değerine göre (daily, weekly, monthly) grafiği güncelleyebilir
    // Veriyi tekrar çekip veya mevcut veriyi uygun şekilde gruplama yaparak
    console.log(`Satış trendi ${period} olarak güncelleniyor...`);
  }

  // Satış Dağılımı Grafiği
  function createSalesDistributionChart(products) {
    const ctx = document.getElementById('salesDistributionChart').getContext('2d');
    if (salesDistributionChart) salesDistributionChart.destroy();

    if (!products || products.length === 0) {
      console.warn('Ürün satış verisi bulunamadı');
      return;
    }

    // En çok satan 5 ürün + diğerleri
    const topProducts = products.slice(0, 5);
    const otherProducts = products.slice(5);

    const labels = topProducts.map(item => item.merchant_sku || 'Bilinmeyen');
    if (otherProducts.length > 0) {
      labels.push('Diğer');
    }

    const values = topProducts.map(item => item.total_revenue || 0);
    if (otherProducts.length > 0) {
      const otherValue = otherProducts.reduce((sum, item) => sum + (item.total_revenue || 0), 0);
      values.push(otherValue);
    }

    // Renkler
    const colors = [
      'rgba(75, 192, 192, 0.7)',
      'rgba(54, 162, 235, 0.7)',
      'rgba(255, 206, 86, 0.7)',
      'rgba(153, 102, 255, 0.7)',
      'rgba(255, 99, 132, 0.7)',
      'rgba(96, 96, 96, 0.7)'
    ];

    salesDistributionChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: colors,
          borderColor: colors.map(color => color.replace('0.7', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12,
              usePointStyle: true,
              pointStyle: 'circle',
              padding: 15,
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw;
                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }

  // Sipariş Saatleri Grafiği
  function createSalesHoursChart() {
    const ctx = document.getElementById('salesHoursChart');
    if (!ctx) return;

    if (salesHoursChart) salesHoursChart.destroy();

    // Örnek veri
    const hours = ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', 
                 '12', '13', '14', '15', '16', '17', '18, '19', '20', '21', '22', '23'];

    const data = [5, 3, 2, 1, 0, 0, 1, 3, 10, 15, 22, 35, 45, 50, 65, 70, 55, 40, 25, 45, 60, 40, 20, 10];

    salesHoursChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: hours,
        datasets: [{
          label: 'Sipariş Sayısı',
          data: data,
          backgroundColor: createGradient(ctx, 'rgba(54, 162, 235, 0.5)'),
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              title: function(tooltipItems) {
                return `${tooltipItems[0].label}:00 - ${tooltipItems[0].label}:59`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              borderDash: [3, 3]
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 9
              }
            }
          }
        }
      }
    });
  }

  // İade Nedenleri Grafiği
  function createReturnsChart(returns) {
    const ctx = document.getElementById('returnsChart');
    if (!ctx) return;

    if (returnsChart) returnsChart.destroy();

    // Veri kontrolü
    const data = returns && returns.length > 0 ? returns : [
      {reason: 'Beden Uyumsuzluğu', count: 35},
      {reason: 'Renk/Görsel Farklılığı', count: 25},
      {reason: 'Kalite Sorunu', count: 18},
      {reason: 'Yanlış Ürün', count: 12},
      {reason: 'Diğer', count: 10}
    ];

    returnsChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: data.map(item => item.reason),
        datasets: [{
          data: data.map(item => item.count),
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(255, 205, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(54, 162, 235, 0.7)'
          ],
          borderColor: [
            'rgb(255, 99, 132)',
            'rgb(255, 159, 64)',
            'rgb(255, 205, 86)',
            'rgb(75, 192, 192)',
            'rgb(54, 162, 235)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12,
              usePointStyle: true,
              pointStyle: 'circle',
              font: {
                size: 10
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.raw;
                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${context.label}: ${value} adet (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }

  // Kategori Performansı Grafiği
  function createCategorySalesChart() {
    const ctx = document.getElementById('categorySalesChart');
    if (!ctx) return;

    if (categorySalesChart) categorySalesChart.destroy();

    // Örnek veri
    const categories = ['Kadın Ayakkabı', 'Erkek Ayakkabı', 'Çocuk Ayakkabı', 'Çanta', 'Aksesuar'];
    const salesCounts = [1200, 950, 450, 300, 200];
    const revenues = [1500000, 1200000, 400000, 200000, 100000];

    categorySalesChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: categories,
        datasets: [
          {
            label: 'Satış Adedi',
            data: salesCounts,
            backgroundColor: createGradient(ctx, 'rgba(54, 162, 235, 0.5)'),
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            borderRadius: 4,
            order: 2
          },
          {
            label: 'Gelir (TL)',
            data: revenues,
            backgroundColor: 'transparent',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            type: 'line',
            tension: 0.4,
            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
            pointBorderColor: '#fff',
            pointRadius: 4,
            order: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: true,
            title: {
              display: true,
              text: 'Satış Adedi'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: true,
            grid: {
              display: false
            },
            title: {
              display: true,
              text: 'Gelir (TL)'
            },
            ticks: {
              callback: function(value) {
                return value.toLocaleString('tr-TR');
              }
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          }
        }
      }
    });
  }

  // Haftalık Karşılaştırma Grafiği
  function createWeeklyComparisonChart() {
    const ctx = document.getElementById('weeklyComparisonChart');
    if (!ctx) return;

    if (weeklyComparisonChart) weeklyComparisonChart.destroy();

    // Örnek veri - son 4 hafta
    const days = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'];

    // Son 4 hafta verileri
    const currentWeek = [45, 52, 49, 60, 55, 70, 65];
    const previousWeek = [40, 48, 45, 55, 50, 65, 60];
    const twoWeeksAgo = [38, 45, 42, 50, 48, 62, 58];
    const threeWeeksAgo = [35, 42, 40, 48, 45, 58, 55];

    weeklyComparisonChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: days,
        datasets: [
          {
            label: 'Bu Hafta',
            data: currentWeek,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
          },
          {
            label: 'Geçen Hafta',
            data: previousWeek,
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
          },
          {
            label: '2 Hafta Önce',
            data: twoWeeksAgo,
            backgroundColor: 'rgba(255, 206, 86, 0.2)',
            borderColor: 'rgba(255, 206, 86, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(255, 206, 86, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(255, 206, 86, 1)'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        elements: {
          line: {
            tension: 0.2
          }
        },
        scales: {
          r: {
            angleLines: {
              display: true,
              color: 'rgba(0, 0, 0, 0.1)'
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            },
            pointLabels: {
              font: {
                size: 11
              }
            },
            ticks: {
              backdropColor: 'transparent',
              font: {
                size: 10
              }
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          }
        }
      }
    });
  }

  // Satış Tahmini Grafiği
  function createSalesPredictionChart() {
    const ctx = document.getElementById('salesPredictionChart');
    if (!ctx) return;

    if (salesPredictionChart) salesPredictionChart.destroy();

    // Örnek veri
    const today = new Date();
    const dates = [];
    const actualSales = [];
    const predictedSales = [];
    const lowerBound = [];
    const upperBound = [];

    // Geçmiş 30 gün
    for (let i = 60; i > 0; i--) {
      const date = new Date(today);
      date.setDate(today.getDate() - i);
      dates.push(date.toISOString().slice(0, 10));

      // Gerçek satışlar - rastgele veriler
      const value = Math.floor(Math.random() * 30) + 50;
      actualSales.push(value);

      predictedSales.push(null);
      lowerBound.push(null);
      upperBound.push(null);
    }

    // Bugün
    dates.push(today.toISOString().slice(0, 10));
    const todayValue = Math.floor(Math.random() * 30) + 50;
    actualSales.push(todayValue);
    predictedSales.push(todayValue);
    lowerBound.push(null);
    upperBound.push(null);

    // Gelecek 30 gün
    for (let i = 1; i <= 30; i++) {
      const date = new Date(today);
      date.setDate(today.getDate() + i);
      dates.push(date.toISOString().slice(0, 10));

      // Tahmin verileri
      const predictedValue = Math.floor(Math.random() * 30) + 50;
      predictedSales.push(predictedValue);
      lowerBound.push(predictedValue - Math.floor(Math.random() * 10) - 5);
      upperBound.push(predictedValue + Math.floor(Math.random() * 10) + 5);

      actualSales.push(null);
    }

    salesPredictionChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [
          {
            label: 'Gerçek Satışlar',
            data: actualSales,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            fill: false,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 4
          },
          {
            label: 'Tahmin',
            data: predictedSales,
            borderColor: 'rgba(255, 159, 64, 1)',
            backgroundColor: 'rgba(255, 159, 64, 0.1)',
            borderWidth: 2,
            fill: false,
            borderDash: [],
            pointRadius: 0,
            pointHoverRadius: 4
          },
          {
            label: 'Üst Sınır',
            data: upperBound,
            borderColor: 'rgba(255, 159, 64, 0.3)',
            borderWidth: 1,
            backgroundColor: 'transparent',
            fill: '+1',  // Bir sonraki veri seti ile doldur
            pointRadius: 0,
            borderDash: [5, 5]
          },
          {
            label: 'Alt Sınır',
            data: lowerBound,
            borderColor: 'rgba(255, 159, 64, 0.3)',
            borderWidth: 1,
            backgroundColor: 'rgba(255, 159, 64, 0.1)',
            fill: false,
            pointRadius: 0,
            borderDash: [5, 5]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false
          },
          annotation: {
            annotations: {
              line1: {
                type: 'line',
                xMin: today.toISOString().slice(0, 10),
                xMax: today.toISOString().slice(0, 10),
                borderColor: 'rgba(0, 0, 0, 0.3)',
                borderWidth: 1,
                borderDash: [5, 5],
                label: {
                  content: 'Bugün',
                  enabled: true,
                  position: 'start',
                  backgroundColor: 'rgba(0, 0, 0, 0.7)'
                }
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              tooltipFormat: 'dd MMMM yyyy',
              displayFormats: {
                day: 'd MMM'
              }
            },
            ticks: {
              maxTicksLimit: 15,
              font: {
                size: 10
              }
            },
            grid: {
              display: false
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              font: {
                size: 10
              }
            },
            grid: {
              borderDash: [3, 3]
            }
          }
        }
      }
    });
  }

  // En Çok Satan Ürünler Tablosu
  function populateTopProductsTable(productData) {
    const tbody = document.getElementById('topProductsTable');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!productData || productData.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `<td colspan="4" class="text-center">Veri bulunamadı</td>`;
      tbody.appendChild(row);
      return;
    }

    // İlk 10 ürünü göster
    const topProducts = productData.slice(0, 10);

    topProducts.forEach(product => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="ps-3">${product.merchant_sku || 'N/A'}</td>
        <td class="text-nowrap">${(product.product_id || '').substring(0, 15)}</td>
        <td class="text-end">${product.sale_count || 0}</td>
        <td class="text-end pe-3">${formatCurrency(product.total_revenue || 0)}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // Ürün Bazlı Satışlar Tablosu
  function populateProductTable(productSales) {
    const tbody = document.querySelector('#productSalesTable tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!productSales || !Array.isArray(productSales) || productSales.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `<td colspan="7" class="text-center">Veri bulunamadı</td>`;
      tbody.appendChild(row);
      return;
    }

    productSales.forEach(product => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="ps-3">${product.merchant_sku || 'N/A'}</td>
        <td>${product.product_id || 'N/A'}</td>
        <td>${product.color || '-'}</td>
        <td>${product.size || '-'}</td>
        <td class="text-end">${product.sale_count || 0}</td>
        <td class="text-end">${formatCurrency(product.total_revenue || 0)}</td>
        <td class="text-end pe-3">${formatCurrency(product.average_price || 0)}</td>
      `;
      tbody.appendChild(row);
    });
  }

  // AI Öngörülerini Yükleme
  function loadAiInsights() {
    // Simüle ediyoruz
    setTimeout(() => {
      document.getElementById('aiInsightContainer').innerHTML = `
        <p class="mb-1"><strong>Satış Trendleri Analizi:</strong></p>
        <ul class="ps-3 mb-2">
          <li>Son 30 gündeki satışlarınız bir önceki döneme göre %12.3 artış göstermiş.</li>
          <li>Cumartesi günleri saat 14:00-16:00 aralığı en yüksek satış saati.</li>
          <li>Kadın ayakkabı kategorisindeki ayakkabılarda %18 artış var.</li>
        </ul>
        <p class="mb-1"><strong>İade Analizi:</strong></p>
        <ul class="ps-3 mb-2">
          <li>İade oranınız %5.2 ile sektör ortalamasının %2.3 altında.</li>
          <li>En çok iade "beden uyumsuzluğu" sebebiyle geliyor.</li>
        </ul>
        <p class="mb-1"><strong>Öneri:</strong></p>
        <div class="alert alert-info p-2 mb-0">
          Beden uyumsuzluğunu azaltmak için ürün sayfalarına daha detaylı beden kılavuzu ekleyin.
        </div>
      `;
    }, 2000);
  }

  // Gradient oluşturma fonksiyonu
  function createGradient(ctx, color) {
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, color);
    gradient.addColorStop(1, 'rgba(255, 255, 255, 0.1)');
    return gradient;
  }
</script>
{% endblock %}