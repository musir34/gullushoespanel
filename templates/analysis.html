{% extends "base.html" %}

{% block content %}
<!-- Optimize Edilmiş Analiz Paneli Tasarımı -->
<div class="container-fluid py-3">
  <!-- Üst Bilgi Kartı -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary text-white shadow">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="fw-bold mb-1"><i class="bi bi-bar-chart-line me-2"></i> Satış Analiz Paneli</h2>
              <p class="mb-0">Satış performansı ve ürün analizlerini görüntüleyebilirsiniz</p>
            </div>
            <div class="d-flex">
              <button id="printReport" class="btn btn-sm btn-light me-2">
                <i class="bi bi-printer me-1"></i> Yazdır
              </button>
              <button id="exportExcel" class="btn btn-sm btn-light">
                <i class="bi bi-file-excel me-1"></i> Excel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtre Satırı -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body p-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-auto">
              <label class="form-label mb-0 fw-semibold">Hızlı Filtre:</label>
            </div>
            <div class="col-md-auto">
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm quick-filter active" data-filter="last30">Son 30 Gün</button>
                <button type="button" class="btn btn-outline-primary btn-sm quick-filter" data-filter="last7">Son 7 Gün</button>
                <button type="button" class="btn btn-outline-primary btn-sm quick-filter" data-filter="this_month">Bu Ay</button>
                <button type="button" class="btn btn-outline-primary btn-sm quick-filter" data-filter="today">Bugün</button>
              </div>
            </div>
            <div class="col-md-auto">
              <div class="vr h-100 mx-2 d-none d-md-block"></div>
            </div>
            <div class="col-md-auto">
              <label class="form-label mb-0 fw-semibold">Özel Tarih:</label>
            </div>
            <div class="col-md-auto">
              <div class="input-group input-group-sm">
                <input type="date" class="form-control form-control-sm" id="startDate">
                <span class="input-group-text"><i class="bi bi-arrow-right"></i></span>
                <input type="date" class="form-control form-control-sm" id="endDate">
                <button class="btn btn-primary" type="button" id="filterByDate">Uygula</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Özet Kartları Satırı -->
  <div class="row mb-4">
    <!-- Toplam Sipariş -->
    <div class="col-md-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="text-muted mb-0">Toplam Sipariş</h6>
              <h3 class="mt-2" id="totalOrders">0</h3>
            </div>
            <div class="text-primary">
              <i class="bi bi-cart fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Satılan Ürün Adedi -->
    <div class="col-md-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="text-muted mb-0">Satılan Ürün Adedi</h6>
              <h3 class="mt-2" id="totalItemsSold">0</h3>
            </div>
            <div class="text-success">
              <i class="bi bi-box-seam fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toplam Ciro -->
    <div class="col-md-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="text-muted mb-0">Toplam Ciro (TL)</h6>
              <h3 class="mt-2" id="totalRevenue">0</h3>
            </div>
            <div class="text-warning">
              <i class="bi bi-currency-lira fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ortalama Sipariş Değeri -->
    <div class="col-md-3">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="text-muted mb-0">Ort. Sipariş Değeri</h6>
              <h3 class="mt-2" id="avgOrderValue">₺0</h3>
            </div>
            <div class="text-info">
              <i class="bi bi-cash-stack fs-2"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ana Grafikler Satırı -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center bg-transparent">
          <h5 class="mb-0">Satış Performansı</h5>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary active chart-type" data-type="line">
              <i class="bi bi-graph-up"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary chart-type" data-type="bar">
              <i class="bi bi-bar-chart"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="chart-container" style="position: relative; height: 340px;">
            <canvas id="salesPerformanceChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-transparent">
          <h5 class="mb-0">En Çok Satan Ürünler</h5>
        </div>
        <div class="card-body">
          <div class="chart-container" style="position: relative; height: 340px;">
            <canvas id="topProductsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ürün Performansı Tablosu -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-transparent">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Ürün Satış Detayları</h5>
            <div class="input-group input-group-sm" style="width: 250px">
              <input type="text" class="form-control" id="productSearch" placeholder="Ürün ara...">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle" id="productSalesTable">
              <thead class="table-light">
                <tr>
                  <th>Ürün Kodu</th>
                  <th>Ürün Adı</th>
                  <th>Renk / Beden</th>
                  <th class="text-end">Satış Adedi</th>
                  <th class="text-end">Ciro (TL)</th>
                  <th class="text-end">Ort. Fiyat</th>
                </tr>
              </thead>
              <tbody>
                <!-- Veriler JavaScript ile doldurulacak -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
:root {
  --primary-color: #4e73df;
  --success-color: #1cc88a;
  --warning-color: #f6c23e;
  --danger-color: #e74a3b;
  --info-color: #36b9cc;
}

.card {
  border-radius: 0.5rem;
  border: none;
  margin-bottom: 1rem;
}

/* Gradient Arkaplan */
.bg-gradient-primary {
  background: linear-gradient(40deg, #4e73df 0%, #6f42c1 100%) !important;
}

.table th {
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Grafik nesneleri
  let salesPerformanceChart, topProductsChart;

  // Sayfa yüklendiğinde çalışacak fonksiyonlar
  setDefaultDateRange();
  loadSalesStats();
  setupEventListeners();

  // Varsayılan tarih aralığı ayarla
  function setDefaultDateRange() {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);

    document.getElementById('endDate').valueAsDate = today;
    document.getElementById('startDate').valueAsDate = thirtyDaysAgo;
  }

  // Olay dinleyicileri
  function setupEventListeners() {
    // Hızlı filtre butonları
    document.querySelectorAll('.quick-filter').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelectorAll('.quick-filter').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        const filterValue = this.getAttribute('data-filter');
        loadSalesStats(`?quick_filter=${filterValue}`);
      });
    });

    // Tarih filtreleme
    document.getElementById('filterByDate').addEventListener('click', function() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      if (!startDate || !endDate) {
        showAlert('Lütfen başlangıç ve bitiş tarihlerini seçin');
        return;
      }

      loadSalesStats(`?start_date=${startDate}&end_date=${endDate}`);
    });

    // Grafik tipini değiştirme
    document.querySelectorAll('.chart-type').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelectorAll('.chart-type').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');

        const chartType = this.getAttribute('data-type');
        updateChartType(chartType);
      });
    });

    // Yazdırma işlemi
    document.getElementById('printReport').addEventListener('click', function() {
      window.print();
    });

    // Excel export
    document.getElementById('exportExcel').addEventListener('click', function() {
      showAlert('Excel dışa aktarma işlemi başlatılıyor...');
    });

    // Ürün arama
    document.getElementById('productSearch').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const rows = document.querySelectorAll('#productSalesTable tbody tr');

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }

  // API'den verileri çekme
  async function loadSalesStats(queryParams = '') {
    try {
      // Optimizasyon: Yükleniyor göstergesi ekleme
      showLoadingIndicators();

      const response = await fetch('/api/sales-stats' + queryParams);
      const data = await response.json();

      updateSummaryStats(data);
      createSalesPerformanceChart(data.daily_sales || []);
      createTopProductsChart(data.product_sales_chart || []);
      populateProductSalesTable(data.product_sales || []);

      hideLoadingIndicators();
    } catch (error) {
      console.error('Veri çekme hatası:', error);
      showAlert('Veriler yüklenirken bir hata oluştu', 'danger');
      hideLoadingIndicators();

      // Hata durumunda örnek veriler göster
      createSampleCharts();
    }
  }

  // Yükleniyor göstergelerini göster
  function showLoadingIndicators() {
    document.getElementById('totalOrders').innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div>';
    document.getElementById('totalItemsSold').innerHTML = '<div class="spinner-border spinner-border-sm text-success" role="status"></div>';
    document.getElementById('totalRevenue').innerHTML = '<div class="spinner-border spinner-border-sm text-warning" role="status"></div>';
    document.getElementById('avgOrderValue').innerHTML = '<div class="spinner-border spinner-border-sm text-info" role="status"></div>';
  }

  // Yükleniyor göstergelerini gizle
  function hideLoadingIndicators() {
    // Yükleme işlemi tamamlandığında otomatik olarak değerler değişecek
  }

  // Özet istatistikleri güncelle
  function updateSummaryStats(data) {
    document.getElementById('totalOrders').innerText = data.total_orders?.toLocaleString('tr-TR') || 0;
    document.getElementById('totalItemsSold').innerText = data.total_items_sold?.toLocaleString('tr-TR') || 0;
    document.getElementById('totalRevenue').innerText = (data.total_revenue || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2});

    // Ortalama sipariş değeri hesapla
    const avgValue = data.total_orders > 0 ? data.total_revenue / data.total_orders : 0;
    document.getElementById('avgOrderValue').innerText = '₺' + avgValue.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  // Satış Performansı Grafiği
  function createSalesPerformanceChart(dailySales) {
    const ctx = document.getElementById('salesPerformanceChart').getContext('2d');

    if (!dailySales || dailySales.length === 0) {
      if (salesPerformanceChart) salesPerformanceChart.destroy();
      ctx.font = '14px Arial';
      ctx.fillStyle = '#6c757d';
      ctx.textAlign = 'center';
      ctx.fillText('Seçilen tarih aralığında veri bulunamadı', ctx.canvas.width / 2, 50);
      return;
    }

    // En son 30 günlük veriyi kullan
    const sortedData = [...dailySales].sort((a, b) => new Date(a.date) - new Date(b.date));
    const last30days = sortedData.slice(-30);

    // Veriler
    const dates = last30days.map(day => day.date);
    const revenues = last30days.map(day => day.total_amount || 0);
    const orderCounts = last30days.map(day => day.order_count || 0);

    // Mevcut grafiği temizle
    if (salesPerformanceChart) salesPerformanceChart.destroy();

    // Yeni grafiği oluştur
    salesPerformanceChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'Ciro (TL)',
          data: revenues,
          backgroundColor: 'rgba(78, 115, 223, 0.1)',
          borderColor: 'rgba(78, 115, 223, 1)',
          tension: 0.3,
          fill: true,
          yAxisID: 'y'
        }, {
          label: 'Sipariş Sayısı',
          data: orderCounts,
          backgroundColor: 'rgba(28, 200, 138, 0.1)',
          borderColor: 'rgba(28, 200, 138, 1)',
          tension: 0.3,
          borderDash: [5, 5],
          fill: false,
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              usePointStyle: true
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              maxRotation: 45,
              autoSkip: true,
              maxTicksLimit: 10
            }
          },
          y: {
            position: 'left',
            title: {
              display: true,
              text: 'Ciro (TL)'
            },
            ticks: {
              callback: function(value) {
                return new Intl.NumberFormat('tr-TR', {
                  notation: 'compact',
                  compactDisplay: 'short'
                }).format(value);
              }
            }
          },
          y1: {
            position: 'right',
            title: {
              display: true,
              text: 'Sipariş Sayısı'
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
  }

  // En Çok Satan Ürünler Grafiği
  function createTopProductsChart(productData) {
    const ctx = document.getElementById('topProductsChart').getContext('2d');

    if (!productData || productData.length === 0) {
      if (topProductsChart) topProductsChart.destroy();
      ctx.font = '14px Arial';
      ctx.fillStyle = '#6c757d';
      ctx.textAlign = 'center';
      ctx.fillText('Ürün satış verisi bulunamadı', ctx.canvas.width / 2, 50);
      return;
    }

    // En çok satan ilk 5 ürünü al
    const top5Products = productData.slice(0, 5);

    // Ürün adları ve satış değerleri
    const productLabels = top5Products.map(p => p.merchant_sku || p.product_id || 'Bilinmeyen');
    const salesValues = top5Products.map(p => p.total_revenue || 0);

    // Grafik renkleri
    const backgroundColors = [
      'rgba(78, 115, 223, 0.8)',
      'rgba(28, 200, 138, 0.8)',
      'rgba(246, 194, 62, 0.8)',
      'rgba(54, 185, 204, 0.8)',
      'rgba(231, 74, 59, 0.8)'
    ];

    // Mevcut grafiği temizle
    if (topProductsChart) topProductsChart.destroy();

    // Yeni grafiği oluştur
    topProductsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: productLabels,
        datasets: [{
          label: 'Toplam Satış (TL)',
          data: salesValues,
          backgroundColor: backgroundColors,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return new Intl.NumberFormat('tr-TR', {
                  style: 'currency',
                  currency: 'TRY'
                }).format(context.parsed.y);
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              maxRotation: 45,
              autoSkip: true
            }
          },
          y: {
            ticks: {
              callback: function(value) {
                return new Intl.NumberFormat('tr-TR', {
                  notation: 'compact',
                  compactDisplay: 'short'
                }).format(value);
              }
            }
          }
        }
      }
    });
  }

  // Ürün Bazlı Satışlar Tablosu
  function populateProductSalesTable(productSales) {
    const tbody = document.querySelector('#productSalesTable tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!productSales || productSales.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-3">
            <div class="alert alert-info mb-0">
              Seçilen tarih aralığında ürün satış verisi bulunamadı.
            </div>
          </td>
        </tr>
      `;
      return;
    }

    // İlk 20 ürünü göster
    const limitedData = productSales.slice(0, 20);

    limitedData.forEach(product => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><span class="badge bg-light text-dark">${product.merchant_sku || 'N/A'}</span></td>
        <td>${product.product_id || 'Bilinmiyor'}</td>
        <td>${product.color || ''} / ${product.size || ''}</td>
        <td class="text-end">${product.sale_count || 0}</td>
        <td class="text-end">${(product.total_revenue || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</td>
        <td class="text-end">${(product.average_price || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})} ₺</td>
      `;
      tbody.appendChild(row);
    });
  }

  // Grafik tipini değiştir
  function updateChartType(chartType) {
    if (salesPerformanceChart) {
      if (chartType === 'line') {
        salesPerformanceChart.config.type = 'line';
        salesPerformanceChart.data.datasets.forEach(dataset => {
          dataset.tension = 0.3;
        });
      } else if (chartType === 'bar') {
        salesPerformanceChart.config.type = 'bar';
      }

      salesPerformanceChart.update();
    }
  }

  // Örnek grafikler (veriler çekilemediğinde)
  function createSampleCharts() {
    // Örnek satış verileri
    const sampleDailySales = generateSampleDailySales();
    const sampleProductSales = generateSampleProductSales();

    createSalesPerformanceChart(sampleDailySales);
    createTopProductsChart(sampleProductSales);
    populateProductSalesTable(sampleProductSales);

    // Örnek özet değerleri
    document.getElementById('totalOrders').innerText = '1,245';
    document.getElementById('totalItemsSold').innerText = '1,876';
    document.getElementById('totalRevenue').innerText = '982,456.00';
    document.getElementById('avgOrderValue').innerText = '₺788.32';
  }

  // Örnek günlük satış verileri üret
  function generateSampleDailySales() {
    const samples = [];
    const now = new Date();

    for (let i = 29; i >= 0; i--) {
      const date = new Date(now);
      date.setDate(now.getDate() - i);

      samples.push({
        date: date.toISOString().split('T')[0],
        order_count: Math.floor(Math.random() * 30) + 20,
        total_amount: Math.floor(Math.random() * 50000) + 30000,
        total_quantity: Math.floor(Math.random() * 50) + 30
      });
    }

    return samples;
  }

  // Örnek ürün satış verileri üret
  function generateSampleProductSales() {
    return [
      {merchant_sku: 'SKU123456', product_id: 'AY-1001', color: 'Siyah', size: '38', sale_count: 45, total_revenue: 45250.50, average_price: 1005.56},
      {merchant_sku: 'SKU789012', product_id: 'AY-1002', color: 'Beyaz', size: '39', sale_count: 38, total_revenue: 36480.25, average_price: 960.01},
      {merchant_sku: 'SKU345678', product_id: 'AY-1003', color: 'Kahverengi', size: '40', sale_count: 32, total_revenue: 33600.80, average_price: 1050.03},
      {merchant_sku: 'SKU901234', product_id: 'AY-1004', color: 'Lacivert', size: '41', sale_count: 28, total_revenue: 30240.50, average_price: 1080.02},
      {merchant_sku: 'SKU567890', product_id: 'AY-1005', color: 'Bej', size: '39', sale_count: 25, total_revenue: 23750.75, average_price: 950.03}
    ];
  }

  // Uyarı gösterme
  function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed bottom-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.style.maxWidth = '350px';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
      alertDiv.classList.remove('show');
      setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
  }
});
</script>
{% endblock %}