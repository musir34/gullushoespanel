<div class="card mb-3">
  <div class="card-header bg-primary text-white">
    <h5>Sipariş Detayı: {{ siparis.siparis_no }}</h5>
    <span class="badge bg-{{ 'success' if siparis.durum == 'Tamamlandı' else 'warning' if siparis.durum == 'İşleniyor' else 'info' }}">
      {{ siparis.durum }}
    </span>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <h6>Müşteri Bilgileri</h6>
        <p><strong>Ad Soyad:</strong> <span data-musteri-adi>{{ siparis.musteri_adi }}</span> <span data-musteri-soyadi>{{ siparis.musteri_soyadi }}</span></p>
        <p><strong>Telefon:</strong> <span data-musteri-telefon>{{ siparis.musteri_telefon }}</span></p>
        <p><strong>Adres:</strong> <span data-musteri-adres>{{ siparis.musteri_adres }}</span></p>
      </div>
      <div class="col-md-6">
        <h6>Sipariş Bilgileri</h6>
        <p><strong>Sipariş No:</strong> <span data-siparis-no>{{ siparis.siparis_no }}</span></p>
        <p><strong>Tarih:</strong> <span data-siparis-tarihi>{{ siparis.siparis_tarihi.strftime('%d.%m.%Y %H:%M') }}</span></p>
        <p><strong>Durum:</strong> <span data-durum>{{ siparis.durum }}</span></p>
        <p><strong>Toplam Tutar:</strong> <span data-toplam-tutar>{{ "%.2f"|format(siparis.toplam_tutar) }} TL</span></p>
      </div>
    </div>

    <h6>Sipariş Ürünleri</h6>
    <div class="table-responsive">
      <table class="table table-striped table-products">
        <thead>
          <tr>
            <th>Barkod</th>
            <th>Ürün</th>
            <th>Renk/Beden</th>
            <th>Adet</th>
            <th>Birim Fiyat</th>
            <th>Toplam</th>
            {% if siparis.durum != 'Tamamlandı' %}
            <th>Durum</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for urun in urunler %}
          <tr data-urun-id="{{ urun.id }}">
            <td>{{ urun.urun_barkod }}</td>
            <td>{{ urun.urun_adi }}</td>
            <td>{{ urun.renk }} / {{ urun.beden }}</td>
            <td>{{ urun.adet }}</td>
            <td>{{ "%.2f"|format(urun.birim_fiyat) }} TL</td>
            <td>{{ "%.2f"|format(urun.toplam_fiyat) }} TL</td>
            {% if siparis.durum != 'Tamamlandı' %}
            <td>
              <span class="badge bg-{% if urun.urun_gorseli %}success{% else %}secondary{% endif %}">
                {% if urun.urun_gorseli %}Hazır{% else %}Bekliyor{% endif %}
              </span>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="{% if siparis.durum != 'Tamamlandı' %}6{% else %}5{% endif %}" class="text-end"><strong>Toplam:</strong></td>
            <td>{{ "%.2f"|format(siparis.toplam_tutar) }} TL</td>
            {% if siparis.durum != 'Tamamlandı' %}
            <td></td>
            {% endif %}
          </tr>
        </tfoot>
      </table>
    </div>

    {% if siparis.notlar %}
    <div class="mt-3">
      <h6>Notlar</h6>
      <div class="alert alert-info">
        <p data-notlar>{{ siparis.notlar }}</p>
      </div>
    </div>
    {% endif %}

    <div class="mt-4">
      <div class="d-flex justify-content-between">
        <div>
          <button type="button" class="btn btn-warning" onclick="duzenlemeyeAc('{{ siparis.siparis_no }}')">
            <i class="bi bi-pencil"></i> Düzenle
          </button>
          <button type="button" class="btn btn-danger" onclick="siparisiSil('{{ siparis.siparis_no }}')">
            <i class="bi bi-trash"></i> Sil
          </button>
        </div>

        <div>
          {% if siparis.durum != 'Tamamlandı' %}
          <button type="button" class="btn btn-success" onclick="siparisiTamamla('{{ siparis.siparis_no }}')">
            <i class="bi bi-check-circle"></i> Siparişi Tamamla
          </button>
          {% endif %}
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Kapat
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Sipariş tamamlama fonksiyonu
async function siparisiTamamla(siparisNo) {
  if (!confirm('Bu siparişi tamamlamak istediğinizden emin misiniz?')) return;

  try {
    const response = await fetch(`/siparis-guncelle/${siparisNo}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        durum: 'Tamamlandı'
      })
    });

    const data = await response.json();

    if (data.success) {
      alert('Sipariş başarıyla tamamlandı');
      bootstrap.Modal.getInstance(document.getElementById('orderDetailModal')).hide();
      window.location.reload();
    } else {
      alert('Sipariş tamamlanırken bir hata oluştu: ' + (data.error || data.message));
    }
  } catch (error) {
    console.error('Hata:', error);
    alert('Sipariş tamamlanırken bir hata oluştu.');
  }
}
</script>