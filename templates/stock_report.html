{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
    <h2>Stok Raporu</h2>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label>Stok Durumu</label>
                    <select class="form-select" id="stockFilter">
                        <option value="all">Tümü</option>
                        <option value="low">Kritik Stok</option>
                        <option value="out">Stok Yok</option>
                        <option value="healthy">Yeterli Stok</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label>Arama</label>
                    <input type="text" class="form-control" id="searchFilter" placeholder="Ürün adı, barkod veya SKU">
                </div>
                <div class="col-md-4">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary d-block" onclick="loadStockReport()">Filtrele</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Özet Kartları -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h6 class="card-title">Toplam Ürün</h6>
                    <h3 id="totalProducts">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h6 class="card-title">Kritik Stok</h6>
                    <h3 id="lowStockCount">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h6 class="card-title">Stok Yok</h6>
                    <h3 id="outOfStockCount">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h6 class="card-title">Toplam Stok Değeri</h6>
                    <h3 id="totalStockValue">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Stok Tablosu -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="stockTable">
                    <thead>
                        <tr>
                            <th>Ürün Adı</th>
                            <th>Barkod</th>
                            <th>Model</th>
                            <th>Renk</th>
                            <th>Beden</th>
                            <th>Stok</th>
                            <th>Birim Fiyat</th>
                            <th>Toplam Değer</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JavaScript ile doldurulacak -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function formatCurrency(amount) {
    return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY'
    }).format(amount);
}

async function loadStockReport() {
    try {
        const stockFilter = document.getElementById('stockFilter').value;
        const searchQuery = document.getElementById('searchFilter').value;

        const response = await fetch(`/api/stock-report-data?filter=${stockFilter}&search=${searchQuery}`);
        const data = await response.json();

        // Özet kartlarını güncelle
        document.getElementById('totalProducts').textContent = data.summary.total_products;
        document.getElementById('lowStockCount').textContent = data.summary.low_stock_count;
        document.getElementById('outOfStockCount').textContent = data.summary.out_of_stock_count;
        document.getElementById('totalStockValue').textContent = formatCurrency(data.summary.total_value);

        // Tabloyu güncelle
        const tableBody = document.getElementById('stockTable').querySelector('tbody');
        tableBody.innerHTML = '';

        data.products.forEach(product => {
            const row = document.createElement('tr');
            const stockStatus = getStockStatus(product.quantity);

            row.innerHTML = `
                <td>${product.title}</td>
                <td>${product.barcode}</td>
                <td>${product.sku || '-'}</td>
                <td>${product.color || '-'}</td>
                <td>${product.size || '-'}</td>
                <td>${product.quantity}</td>
                <td>${formatCurrency(product.sale_price)}</td>
                <td>${formatCurrency(product.total_value)}</td>
                <td><span class="badge ${stockStatus.class}">${stockStatus.text}</span></td>
            `;

            tableBody.appendChild(row);
        });

    } catch (error) {
        console.error('Stok raporu yüklenirken hata:', error);
        alert('Stok raporu yüklenirken bir hata oluştu.');
    }
}

function getStockStatus(quantity) {
    if (!quantity || quantity === 0) {
        return { text: 'Stok Yok', class: 'bg-danger' };
    } else if (quantity < 10) {
        return { text: 'Kritik Stok', class: 'bg-warning' };
    } else {
        return { text: 'Yeterli', class: 'bg-success' };
    }
}

// Sayfa yüklendiğinde raporu getir
document.addEventListener('DOMContentLoaded', loadStockReport);
</script>

{% endblock %}