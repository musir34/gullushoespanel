{% extends "base.html" %}
{% block content %}

<style>
/* ... Sizin CSS'leriniz aynen kalsın ... */
</style>

<div class="container mt-4">
    <h2>Stok Raporu</h2>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <!-- Stok Durumu -->
                <div class="col-md-3 mb-2">
                    <label>Stok Durumu</label>
                    <select class="form-select" id="stockFilter">
                        <option value="all">Tümü</option>
                        <option value="low">Kritik Stok</option>
                        <option value="out">Stok Yok</option>
                        <option value="healthy">Yeterli Stok</option>
                    </select>
                </div>
                <!-- Arama -->
                <div class="col-md-3 mb-2">
                    <label>Arama</label>
                    <input type="text" class="form-control" id="searchFilter" placeholder="Ürün adı, barkod veya SKU">
                </div>
                <!-- Başlangıç Tarihi -->
                <div class="col-md-3 mb-2">
                    <label>Başlangıç Tarihi</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <!-- Bitiş Tarihi -->
                <div class="col-md-3 mb-2">
                    <label>Bitiş Tarihi</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12 d-grid">
                    <button class="btn btn-primary" onclick="loadStockReport()">Filtrele</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Özet Kartları -->
    <div class="row mb-4">
        <div class="col-md-3 mb-2">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Toplam Ürün</h6>
                    <h3 id="totalProducts">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Kritik Stok</h6>
                    <h3 id="lowStockCount">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Stok Yok</h6>
                    <h3 id="outOfStockCount">-</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h6 class="card-title">Toplam Stok Değeri</h6>
                    <h3 id="totalStockValue">-</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Stok Tablosu -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="stockTable">
                    <thead>
                        <tr>
                            <th>Ürün Adı</th>
                            <th>Orijinal Barkod</th>
                            <th>Model</th>
                            <th>Renk</th>
                            <th>Beden</th>
                            <th>Stok</th>
                            <th>Birim Fiyat</th>
                            <th>Toplam Değer</th>
                            <th>Satılan Adet</th>
                            <th>Günlük Satış</th>
                            <th>Devir Hızı</th>
                            <th>Tahmini Bitme (gün)</th>
                            <th>Durum</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JavaScript ile doldurulacak -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * 1) Yardımcı Fonksiyonlar
 */
function formatCurrency(amount) {
    return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY'
    }).format(amount);
}

function formatNumber(num, fractionDigits = 2) {
    if (num === null || num === undefined) return '-';
    return num.toLocaleString('tr-TR', {
        minimumFractionDigits: fractionDigits,
        maximumFractionDigits: fractionDigits
    });
}

function getStockStatus(quantity) {
    if (!quantity || quantity === 0) {
        return { text: 'Stok Yok', class: 'bg-danger' };
    } else if (quantity < 10) {
        return { text: 'Kritik Stok', class: 'bg-warning' };
    } else {
        return { text: 'Yeterli', class: 'bg-success' };
    }
}

/**
 * 2) API'den verileri al, aynı "original_product_barcode" değerine sahip
 *    kayıtları frontend'de TEK SATIRDA BİRLEŞTİR (merge).
 */
async function loadStockReport() {
    try {
        const stockFilter = document.getElementById('stockFilter').value;
        const searchQuery = document.getElementById('searchFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        let apiUrl = `/api/stock-report-data?filter=${stockFilter}&search=${searchQuery}`;
        if (startDate) apiUrl += `&start_date=${startDate}`;
        if (endDate) apiUrl += `&end_date=${endDate}`;

        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error('Sunucudan veri alınamadı.');
        }
        const data = await response.json();

        // Özet kartlarını güncelle
        document.getElementById('totalProducts').textContent = data.summary.total_products;
        document.getElementById('lowStockCount').textContent = data.summary.low_stock_count;
        document.getElementById('outOfStockCount').textContent = data.summary.out_of_stock_count;
        document.getElementById('totalStockValue').textContent = formatCurrency(data.summary.total_value);

        // Şimdi, data.products içinde aynı original_product_barcode’a sahip ürünleri birleştirelim:
        const mergedByBarcode = {};

        data.products.forEach(item => {
            const ob = item.original_product_barcode || '-';

            // Eğer barkod dictionary'de yoksa, direkt ekle
            if (!mergedByBarcode[ob]) {
                mergedByBarcode[ob] = {
                    title: item.title,
                    original_product_barcode: ob,
                    model: item.model,
                    color: item.color,
                    size: item.size,
                    quantity: item.quantity || 0,
                    sale_price: item.sale_price || 0,
                    total_value: item.total_value || 0,
                    sold_quantity: item.sold_quantity || 0,
                    daily_sold: item.daily_sold || 0,
                    turnover_ratio: item.turnover_ratio || 0,
                    days_to_out: item.days_to_out
                };
            } else {
                // Aynı barkod varsa, stok ve bazı alanları topluyoruz
                // (Color / size gibi alanlar farklıysa hangisini tutacağınıza karar verin)
                mergedByBarcode[ob].quantity += (item.quantity || 0);
                mergedByBarcode[ob].total_value += (item.total_value || 0);
                mergedByBarcode[ob].sold_quantity += (item.sold_quantity || 0);

                // daily_sold veya turnover_ratio gibi verileri
                // "ortalama" mı alacaksınız, "toplam" mı? Size kalmış.
                // Burada basitçe ortalama alıyoruz:
                mergedByBarcode[ob].daily_sold = 
                    (mergedByBarcode[ob].daily_sold + (item.daily_sold || 0)) / 2;

                mergedByBarcode[ob].turnover_ratio = 
                    (mergedByBarcode[ob].turnover_ratio + (item.turnover_ratio || 0)) / 2;
            }
        });

        // Artık mergedByBarcode sözlüğündeki değerleri bir diziye dönüştürelim
        let mergedProducts = Object.values(mergedByBarcode);

        // İsterseniz model->color->size şeklinde sıralama yapabilirsiniz
        mergedProducts.sort((a, b) => {
            const modelCompare = (a.model || '').localeCompare(b.model || '');
            if (modelCompare !== 0) return modelCompare;

            const colorCompare = (a.color || '').localeCompare(b.color || '');
            if (colorCompare !== 0) return colorCompare;

            return (a.size || '').localeCompare(b.size || '');
        });

        // 3) Tabloyu güncelle
        const tableBody = document.getElementById('stockTable').querySelector('tbody');
        tableBody.innerHTML = '';

        mergedProducts.forEach(product => {
            const row = document.createElement('tr');
            const stockStatus = getStockStatus(product.quantity);

            row.innerHTML = `
                <td>${product.title}</td>
                <td>${product.original_product_barcode || '-'}</td>
                <td>${product.model || '-'}</td>
                <td>${product.color || '-'}</td>
                <td>${product.size || '-'}</td>
                <td>${product.quantity}</td>
                <td>${formatCurrency(product.sale_price)}</td>
                <td>${formatCurrency(product.total_value)}</td>
                <td>${product.sold_quantity}</td>
                <td>${formatNumber(product.daily_sold, 2)}</td>
                <td>${formatNumber(product.turnover_ratio, 2)}</td>
                <td>${
                    product.days_to_out !== null && product.days_to_out !== undefined 
                        ? formatNumber(product.days_to_out, 1) 
                        : '-'
                }</td>
                <td><span class="badge ${stockStatus.class}">${stockStatus.text}</span></td>
            `;
            tableBody.appendChild(row);
        });

    } catch (error) {
        console.error('Stok raporu yüklenirken hata:', error);
        alert('Stok raporu yüklenirken bir hata oluştu: ' + error.message);
    }
}

/**
 * Sayfa yüklendiğinde ilk verileri getirin.
 */
document.addEventListener('DOMContentLoaded', loadStockReport);
</script>

{% endblock %}
