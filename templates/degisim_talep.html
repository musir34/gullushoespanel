<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deƒüi≈üim Listesi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .toggle-details { cursor: pointer; }
        .details-section { display: none; transition: all 0.3s ease; }
        .details-section.show { display: block; }
        .copy-confirmation {
            display: none;
            color: green;
            font-size: 1.2em;
            position: absolute;
            margin-left: 10px;
        }
        .copy-confirmation.show {
            display: inline-block;
            color: green;
        }
        .copy-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
        }
        .container { max-width: 1200px; }
        .badge { font-size: 0.9em; }
        .clipboard-icon { cursor: pointer; }
        .product-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card { margin-bottom: 15px; }
        .card-body { padding: 15px; }
        .product-image { width: 100px; height: auto; }
        .bg-orange { background-color: orange; color: white; }
        .bg-red { background-color: red; color: white; }
        #messageBox { display: none; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div id="messageBox" class="alert" role="alert"></div>

        <div class="text-center mb-4">
            <h2>Deƒüi≈üim Talepleri Listesi</h2>
            <h5>≈ûu anki sayfa: {{ page }}</h5>
        </div>

        <!-- Filtre ve Sƒ±ralama Alanƒ± -->
        <div class="d-flex justify-content-center mb-4">
            <form action="{{ url_for('degisim.degisim_talep') }}" method="GET" class="me-3">
                <div class="input-group">
                    <select name="filter_status" class="form-select">
                        <option value="">T√ºm√º</option>
                        <option value="Beklemede" {% if request.args.get('filter_status') == 'Beklemede' %}selected{% endif %}>Beklemede</option>
                        <option value="ƒ∞≈üleme Alƒ±ndƒ±" {% if request.args.get('filter_status') == 'ƒ∞≈üleme Alƒ±ndƒ±' %}selected{% endif %}>ƒ∞≈üleme Alƒ±ndƒ±</option>
                        <option value="Kargoya Verildi" {% if request.args.get('filter_status') == 'Kargoya Verildi' %}selected{% endif %}>Kargoya Verildi</option>
                        <option value="Teslim Edildi" {% if request.args.get('filter_status') == 'Teslim Edildi' %}selected{% endif %}>Teslim Edildi</option>
                    </select>
                    <button type="submit" class="btn btn-primary btn-sm">Filtrele</button>
                </div>
            </form>

            <div>
                Sƒ±rala:
                <a href="{{ url_for('degisim.degisim_talep', filter_status=request.args.get('filter_status'), sort='asc') }}" class="btn btn-sm btn-outline-secondary">Eskiden Yeniye</a>
                <a href="{{ url_for('degisim.degisim_talep', filter_status=request.args.get('filter_status'), sort='desc') }}" class="btn btn-sm btn-outline-secondary">Yeniden Eskiye</a>
            </div>
        </div>

        <div class="text-center mb-4">
            <a href="{{ url_for('degisim.yeni_degisim_talebi') }}" class="btn btn-primary">Yeni Deƒüi≈üim Talebi Olu≈ütur</a>
        </div>

        <div class="text-center mb-4">
            <a href="{{ url_for('home.home') }}" class="btn btn-secondary">Anasayfaya D√∂n</a>
        </div>

        <div class="text-center mb-4">
            <h4>Toplam Deƒüi≈üim Talebi Sayƒ±sƒ±: {{ total_exchanges_count }}</h4>
        </div>

        <!-- Deƒüi≈üim Taleplerinin Listelendiƒüi Kƒ±sƒ±m -->
        <div class="row">
            {% for exchange in degisim_kayitlari %}
            <div class="col-md-6 col-lg-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Deƒüi≈üim Tarihi:</strong> {{ exchange.degisim_tarihi.strftime('%d.%m.%Y') }}<br>
                            <strong>Durum:</strong> 
                            <span class="badge 
                                {% if exchange.degisim_durumu == 'Beklemede' %}
                                    bg-warning
                                {% elif exchange.degisim_durumu == 'ƒ∞≈üleme Alƒ±ndƒ±' %}
                                    bg-success
                                {% elif exchange.degisim_durumu == 'Kargoya Verildi' %}
                                    bg-orange
                                {% elif exchange.degisim_durumu == 'Teslim Edildi' %}
                                    bg-info
                                {% else %}
                                    bg-secondary
                                {% endif %}">
                                {{ exchange.degisim_durumu }}
                            </span><br>
                            <strong>Sipari≈ü Numarasƒ±:</strong> {{ exchange.siparis_no }}
                            <span class="copy-container">
                                <span class="clipboard-icon" onclick="copyToClipboard('{{ exchange.siparis_no }}', this)">üìã</span>
                                <span class="copy-confirmation">‚úîÔ∏è</span>
                            </span><br>
                            <strong>Telefon No:</strong> {{ exchange.telefon_no }}
                        </div>
                    </div>
                    <div class="card-body">
                        <h6><strong>M√º≈üteri:</strong> {{ exchange.ad }} {{ exchange.soyad }}</h6>
                        <h6><strong>Adres:</strong> {{ exchange.adres }}</h6>
                        <h6><strong>√úr√ºn Bilgisi:</strong> {{ exchange.urun_model_kodu }} - {{ exchange.urun_beden }} - {{ exchange.urun_renk }}</h6>
                        <h6><strong>Deƒüi≈üim Nedeni:</strong> {{ exchange.degisim_nedeni }}</h6>

                        <img src="{{ url_for('static', filename='images/' ~ exchange.urun_barkod ~ '.jpg') }}" 
                             class="product-image mt-3" alt="√úr√ºn G√∂rseli">

                        <!-- ƒ∞≈ülem Butonlarƒ± -->
                        <div class="text-center mt-4">
                            <button class="btn btn-outline-success btn-sm" onclick="updateStatus('{{ exchange.degisim_no }}', 'ƒ∞≈üleme Alƒ±ndƒ±')">ƒ∞≈üleme Alƒ±ndƒ±</button>
                            <button class="btn btn-outline-warning btn-sm" onclick="updateStatus('{{ exchange.degisim_no }}', 'Kargoya Verildi')">Kargoya Verildi</button>
                            <button class="btn btn-outline-info btn-sm" onclick="updateStatus('{{ exchange.degisim_no }}', 'Teslim Edildi')">Teslim Edildi</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteExchange('{{ exchange.degisim_no }}')">Sil</button>

                            <!-- Kargo Etiketi Yazdƒ±rma Formu -->
                            <form action="{{ url_for('order_label') }}" method="post" target="_blank" class="mt-2">
                                <input type="hidden" name="order_number" value="{{ exchange.siparis_no }}">
                                <input type="hidden" name="shipping_code" value="{{ exchange.kargo_kodu }}">
                                <input type="hidden" name="cargo_provider" value="{{ exchange.cargo_provider_name }}">
                                <input type="hidden" name="customer_name" value="{{ exchange.ad }}">
                                <input type="hidden" name="customer_surname" value="{{ exchange.soyad }}">
                                <input type="hidden" name="customer_address" value="{{ exchange.adres }}">
                                <input type="hidden" name="telefon_no" value="{{ exchange.telefon_no }}">
                                <button type="submit" class="btn btn-outline-secondary btn-sm">Kargo Etiketini Yazdƒ±r</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Sayfalama -->
        <nav aria-label="Sayfa gezintisi" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for(request.endpoint, page=page-1, filter_status=request.args.get('filter_status'), sort=request.args.get('sort')) }}">√ñnceki</a>
                </li>
                {% endif %}
                {% for i in range(1, total_pages + 1) %}
                <li class="page-item {% if i == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for(request.endpoint, page=i, filter_status=request.args.get('filter_status'), sort=request.args.get('sort')) }}">{{ i }}</a>
                </li>
                {% endfor %}
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for(request.endpoint, page=page+1, filter_status=request.args.get('filter_status'), sort=request.args.get('sort')) }}">Sonraki</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>

    <textarea id="temp-copier" style="position: absolute; top: -1000px;"></textarea>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showMessage(message, success=true) {
            const box = document.getElementById('messageBox');
            box.style.display = 'block';
            box.className = success ? 'alert alert-success' : 'alert alert-danger';
            box.textContent = message;
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }

        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const confirmation = element.nextElementSibling;
                confirmation.classList.add('show');
                setTimeout(() => {
                    confirmation.classList.remove('show');
                }, 2000);
            }).catch(() => {
                showMessage("Kopyalama sƒ±rasƒ±nda hata olu≈ütu.", false);
            });
        }

        function updateStatus(degisim_no, status) {
            $.post("/update_status", { degisim_no: degisim_no, status: status }, function(response) {
                if (response.success) {
                    showMessage("Durum g√ºncellendi!", true);
                    setTimeout(() => { location.reload(); }, 1000);
                } else {
                    showMessage("Durum g√ºncellenirken bir hata olu≈ütu.", false);
                }
            }).fail(function() {
                showMessage("Durum g√ºncellenirken bir hata olu≈ütu.", false);
            });
        }

        function deleteExchange(degisim_no) {
            if (confirm("Bu deƒüi≈üim kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?")) {
                $.post("/delete_exchange", { degisim_no: degisim_no }, function(response) {
                    if (response.success) {
                        showMessage("Deƒüi≈üim kaydƒ± silindi!", true);
                        setTimeout(() => { location.reload(); }, 1000);
                    } else {
                        showMessage("Deƒüi≈üim kaydƒ± silinirken bir hata olu≈ütu.", false);
                    }
                }).fail(function() {
                    showMessage("Deƒüi≈üim kaydƒ± silinirken bir hata olu≈ütu.", false);
                });
            }
        }

        function editExchange(degisim_no) {
            window.location.href = `/edit_exchange/${degisim_no}`;
        }
    </script>
</body>
</html>
