<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- Meta ve Stil Kodlarƒ± -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anasayfa</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">

    <style>
        /* Sayfa D√ºzeni */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }

        /* Canvas tam ekran arkada */
        #snowCanvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1; /* ƒ∞√ßeriklerin arkasƒ±nda olsun */
            width: 100vw;
            height: 100vh;
            background: #2c3e50; /* Karanlƒ±k bir gece g√∂ky√ºz√º */
        }

        .container {
            max-width: 1200px;
            margin-top: 60px;
        }

        .user-info {
            position: fixed;
            top: 15px;
            left: 20px;
            z-index: 10;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info img {
            max-width: 100px; 
            height: auto;
        }

        .btn-group-top {
            position: fixed;
            top: 15px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .btn {
            border-radius: 10px;
            padding: 5px 12px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .order-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }

        .card {
            width: 200px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .product-image {
            width: 100%;
            height: auto;
            border-radius: 10px 10px 0 0;
        }

        .card-title {
            font-weight: bold;
            color: #444;
            text-align: center;
            margin: 10px 0;
        }

        .card-text {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }

        .form-control {
            border-radius: 10px;
            padding: 8px;
            font-size: 0.85rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            position: relative;
            margin-bottom: 35px;
        }

        .alert {
            position: absolute;
            top: -30px;
            left: 0;
            right: 0;
            font-size: 12px;
            padding: 5px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        .alert-show {
            opacity: 1;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .copy-container {
            position: relative;
            cursor: pointer;
            display: inline-block;
            margin-left: 5px;
        }

        .copy-confirmation {
            color: green;
            font-size: 1em;
            margin-left: 5px;
            display: none;
        }

        .copy-confirmation.show {
            display: inline-block;
        }

        .btn-bottom {
            max-width: 200px;
            margin: 10px 0;
            padding: 8px 15px;
            border-radius: 10px;
        }

        .bottom-buttons {
            text-align: left;
            margin-top: 20px;
        }

        .fixed-header {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .modal-content {
            border-radius: 15px;
            padding: 20px;
        }

        .modal-header {
            border-bottom: none;
            justify-content: center;
        }

        .modal-footer {
            border-top: none;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .btn {
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            .card-title {
                font-size: 0.9rem;
            }

            .card-text {
                font-size: 0.8rem;
            }

            .user-info img {
                max-width: 70px;
            }
        }
    </style>
</head>

<body>
    <!-- Canvas tabakasƒ± -->
    <canvas id="snowCanvas"></canvas>

    <!-- Kullanƒ±cƒ± bilgisi sol √ºstte + Logo -->
    <div class="user-info">
        <img src="static/logo/gullu.png" alt="G√ºll√º Shoes Logo">
        Giri≈ü Yapan: <strong>{{ session['first_name'] }} {{ session['last_name'] }}</strong>
    </div>

    <!-- Saƒü √ºst k√∂≈üede butonlar -->
    <div class="btn-group-top">
        <a href="{{ url_for('siparis_fisi_bp.siparis_fisi_sayfasi') }}" class="btn btn-primary">√úr√ºn Tedarik Sayfasƒ±</a>
        <a href="{{ url_for('approve_users') }}" class="btn btn-warning">Kullanƒ±cƒ± Y√∂netimi</a>
        <a href="{{ url_for('home.home') }}" class="btn btn-secondary">Anasayfa</a>
        <a href="{{ url_for('iade_listesi') }}" class="btn btn-secondary">ƒ∞ade Listesi</a>
        <a href="{{ url_for('product_list') }}" class="btn btn-secondary">√úr√ºn Listesi</a>
        <a href="{{ url_for('order_list_all') }}" class="btn btn-secondary">Sipari≈ü Listesi</a>
        <a href="{{ url_for('display_archive') }}" class="btn btn-secondary">Ar≈üiv</a>
        <a href="{{ url_for('degisim_talep') }}" class="btn btn-secondary">Deƒüi≈üim Talepleri</a>
        <a href="{{ url_for('all_orders_service.get_all_orders') }}" class="btn btn-info">Analiz Sayfasƒ±</a>
        <form method="POST" action="{{ url_for('logout') }}">
            <button type="submit" class="btn btn-danger">√áƒ±kƒ±≈ü Yap</button>
        </form>
    </div>

    <div class="container">
        <!-- Confirm Packing Formunu Ba≈ülatƒ±yoruz -->
        <form method="POST" action="{{ url_for('confirm_packing') }}" id="packingForm" autocomplete="off">
            <input type="hidden" name="order_number" value="{{ order_number }}">

            <!-- Sipari≈ü Kartlarƒ± -->
            <div class="order-container">
                {% for product in products %}
                    <div class="col-sm-6 col-md-4 col-lg-2 col-xl-2">
                        <div class="card product-card" data-order-number="{{ order_number }}">
                            <img src="{{ product.image_url }}" alt="√úr√ºn G√∂rseli" class="card-img-top product-image">
                            <div class="card-body">
                                <h5 class="card-title">{{ product.sku }}</h5>
                                <p class="card-text">
                                    <strong>Miktar:</strong> 
                                    {{ product.quantity if product.quantity else 1 }}
                                </p>
                                <p class="card-text">
                                    <strong>√úr√ºn Barkodu:</strong>
                                    <span id="productBarcode-{{ loop.index0 }}">{{ product.barcode }}</span>
                                    <span class="copy-container">
                                        <span class="clipboard-icon" onclick="copyToClipboard('productBarcode-{{ loop.index0 }}', this)">üìã</span>
                                        <span class="copy-confirmation">‚úîÔ∏è</span>
                                    </span>
                                </p>
                                <div class="form-group">
                                    <div id="barkodMatchMessage-right-{{ loop.index0 }}" class="alert"></div>
                                    <input type="text" class="form-control barkod-input" data-product-index="{{ loop.index0 }}" data-side="right" id="barkodInput-right-{{ loop.index0 }}" name="barkod_right_{{ loop.index0 }}" placeholder="{{ product.sku }} Saƒü Tek Barkodu" required autocomplete="off">
                                    <input type="hidden" id="expectedBarcode-right-{{ loop.index0 }}" value="{{ product.barcode }}">
                                </div>
                                <div class="form-group">
                                    <div id="barkodMatchMessage-left-{{ loop.index0 }}" class="alert"></div>
                                    <input type="text" class="form-control barkod-input" data-product-index="{{ loop.index0 }}" data-side="left" id="barkodInput-left-{{ loop.index0 }}" name="barkod_left_{{ loop.index0 }}" placeholder="{{ product.sku }} Sol Tek Barkodu" required autocomplete="off">
                                    <input type="hidden" id="expectedBarcode-left-{{ loop.index0 }}" value="{{ product.barcode }}">
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Alt Butonlar -->
            <div class="bottom-buttons">
                <button type="submit" class="btn btn-primary btn-bottom disabled-btn" id="onaylaBtn" disabled>Paketlemeyi Onayla</button>
            </div>
        </form>

        <!-- Yazdƒ±r Formu ve Ar≈üive G√∂nder Butonu -->
        <div class="bottom-buttons">
            <!-- Yazdƒ±r Formu -->
            <form method="POST" action="{{ url_for('order_label') }}" target="_blank" id="yazdirForm" autocomplete="off">
                <input type="hidden" name="order_number" value="{{ order_number }}">
                <input type="hidden" name="shipping_code" value="{{ shipping_code }}">
                <input type="hidden" name="cargo_provider" value="{{ cargo_provider_name }}">
                <input type="hidden" name="customer_name" value="{{ customer_name }}">
                <input type="hidden" name="customer_surname" value="{{ customer_surname }}">
                <input type="hidden" name="customer_address" value="{{ customer_address }}">
                <button type="submit" class="btn btn-warning btn-bottom disabled-btn" id="yazdirBtn" disabled>Yazdƒ±r</button>
            </form>

            <!-- Ar≈üive G√∂nder Butonu -->
            <button type="button" class="btn btn-danger btn-bottom" onclick="showArchiveModal('{{ order_number }}')">Ar≈üive G√∂nder</button>
        </div>

        <!-- Kargo Bilgileri Sabit √úst B√∂l√ºm -->
        <div class="fixed-header">
            <h4>Kargo Bilgileri</h4>
            <p>
                <strong>Sipari≈ü No:</strong> {{ order_number }}<br>
                <strong>M√º≈üteri:</strong> {{ customer_name }} {{ customer_surname }}<br>
                <strong>Kargoya Kalan S√ºre:</strong> {{ remaining_time }}<br>
                <strong>Kargo Firmasƒ±:</strong> {{ cargo_provider_name }}<br>
                <strong>Kargo Kodu:</strong> {{ shipping_code }}<br>
            </p>
        </div>

        <!-- Ar≈üiv Sebebi Modal Penceresi -->
        <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <form id="archiveForm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Ar≈üivleme Sebebi Se√ßin</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="archiveOrderNumber" name="order_number" value="">
                            <div class="mb-3">
                                <label for="archiveReason" class="form-label">Sebep</label>
                                <select class="form-control" id="archiveReason" name="archive_reason" required>
                                    <option value="">Sebep Se√ßin</option>
                                    <option value="Stok T√ºkendi">Stok T√ºkendi</option>
                                    <option value="Kusurlu/Defolu √úr√ºn">Kusurlu/Defolu √úr√ºn</option>
                                    <option value="Paket ƒ∞√ßeriƒüi Eksik">Paket ƒ∞√ßeriƒüi Eksik</option>
                                    <option value="√úr√ºn Sorunu Gideriliyor">√úr√ºn Sorunu Gideriliyor</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒ∞ptal</button>
                            <button type="submit" class="btn btn-primary">Ar≈üivle</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bootstrap Toast (G√ºzel Mesaj) -->
        <div class="toast" id="archiveSuccessToast" role="alert" aria-live="assertive" aria-atomic="true" 
            data-delay="2000" 
            style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="toast-header">
                <strong class="mr-auto text-success">Ba≈üarƒ±lƒ±</strong>
                <small>≈ûimdi</small>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Kapat">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body">
                Sipari≈ü ar≈üivlendi!
            </div>
        </div>
    </div>

    <!-- JS K√ºt√ºphaneleri -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>

    <!-- Geli≈ümi≈ü Kar Yaƒüma Sistemi (Canvas) -->
    <script>
    // Canvas ayarƒ±
    const canvas = document.getElementById('snowCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Kar taneleri ve zemin
    let snowflakes = [];
    let ground = [];

    // Ayarlar
    const maxFlakes = 250; // Ekranda aynƒ± anda u√ßu≈üacak kar tanesi sayƒ±sƒ±
    const cleanInterval = 10 * 60 * 1000; // 10 dakika
    let lastCleanTime = performance.now();

    // R√ºzgar ayarlarƒ±
    let windActive = false;
    let windStartTime = 0;
    let windDuration = 0;
    let nextWindTime = randomRange(4*60*1000, 5*60*1000); // ilk r√ºzgar i√ßin 4-5 dk rastgele

    // Basit yardƒ±mcƒ± fonksiyon
    function randomRange(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Kar tanesi olu≈ütur
    function createSnowflake() {
        return {
            x: Math.random() * canvas.width,
            y: -10,
            radius: 2 + Math.random() * 3,
            speed: 0.5 + Math.random() * 1.5,  // Farklƒ± hƒ±zlarda
            drift: (Math.random() - 0.5) * 0.5, // X ekseninde k√º√ß√ºk kayma
        };
    }

    function addSnowflake() {
        if (snowflakes.length < maxFlakes) {
            snowflakes.push(createSnowflake());
        }
    }

    // Kar tanesi zemine ula≈ütƒ±ysa ground dizisine ekleyip sabitliyoruz
    function settleFlake(flake) {
        ground.push({
            x: flake.x,
            y: flake.y,
            radius: flake.radius
        });
    }

    // Her 10 dakikada zemini sƒ±fƒ±rlayalƒ±m
    function checkCleanup(now) {
        if (now - lastCleanTime >= cleanInterval) {
            ground = [];
            lastCleanTime = now;
        }
    }

    // R√ºzgar kontrol
    function checkWind(now) {
        // R√ºzgarƒ± ba≈ülatma
        if (!windActive && now >= nextWindTime) {
            windActive = true;
            windStartTime = now;
            windDuration = randomRange(10000, 15000); // 10-15 sn r√ºzgar
        }
        // R√ºzgar devam mƒ± bitiyor mu
        if (windActive) {
            if (now - windStartTime > windDuration) {
                windActive = false;
                // Bir sonraki r√ºzgar i√ßin yine 4-5 dk rastgele at
                nextWindTime = now + randomRange(4*60*1000, 5*60*1000);
            }
        }
    }

    // Ana animasyon
    function animate() {
        requestAnimationFrame(animate);
        const now = performance.now();

        // Temizlik
        checkCleanup(now);
        // R√ºzgar kontrol
        checkWind(now);

        // Yeni kar tanesi ekle
        addSnowflake();

        // Temizle
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Zemindeki karƒ± √ßiz
        ctx.fillStyle = "#ecf0f1";
        ground.forEach(g => {
            ctx.beginPath();
            ctx.arc(g.x, g.y, g.radius, 0, 2*Math.PI);
            ctx.fill();
        });

        // Kar tanelerini hareket ettir
        snowflakes.forEach((flake) => {
            // R√ºzgar varsa x ekseni hƒ±zƒ±nƒ± biraz artƒ±r
            const windForce = windActive ? (Math.random() * 1.5) : 0;
            flake.x += flake.drift + windForce;
            flake.y += flake.speed;

            // Ekrandan √ßƒ±ktƒ±ysa veya zemine ula≈ütƒ±ysa
            if (flake.y >= canvas.height - flake.radius) {
                // Zemine sabitle
                flake.y = canvas.height - flake.radius;
                settleFlake(flake);

                // Bu taneyi sƒ±fƒ±rla (yukarƒ±dan yeni doƒüsun)
                Object.assign(flake, createSnowflake());
            } 
            else if (flake.x > canvas.width + flake.radius ||
                     flake.x < -flake.radius) {
                // Yanlardan √ßƒ±ktƒ±ysa da yeniden yarat
                Object.assign(flake, createSnowflake());
            }

            // Kar tanesini √ßiz
            ctx.beginPath();
            ctx.arc(flake.x, flake.y, flake.radius, 0, 2*Math.PI);
            ctx.fillStyle = "#ecf0f1";
            ctx.fill();
        });
    }

    // √áizim ba≈ülasƒ±n
    animate();
    </script>

    <!-- Mevcut Barkod, Toast vb. kodlar -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const barkodInputs = document.querySelectorAll('.barkod-input');
            const onaylaBtn = document.getElementById('onaylaBtn');
            const yazdirBtn = document.getElementById('yazdirBtn');
            const yazdirForm = document.getElementById('yazdirForm');

            const productCount = {{ products|length }};
            let barkodDogruList = new Array(productCount).fill(false);

            // ƒ∞lk input'a odaklansƒ±n
            if (barkodInputs.length > 0) {
                barkodInputs[0].focus();
            }

            barkodInputs.forEach((input, index) => {
                input.addEventListener('input', function () {
                    const side = input.dataset.side;
                    const productIndex = parseInt(input.dataset.productIndex);
                    const expectedBarcode = document.getElementById(`expectedBarcode-${side}-${productIndex}`).value;
                    const matchMessage = document.getElementById(`barkodMatchMessage-${side}-${productIndex}`);
                    const inputValue = input.value.trim();
                    const expectedValue = expectedBarcode.trim();

                    if (inputValue === expectedValue) {
                        matchMessage.classList.remove('alert-danger');
                        matchMessage.classList.add('alert-success', 'alert-show');
                        matchMessage.textContent = 'Barkod doƒüru!';

                        const nextInput = barkodInputs[index + 1];
                        if (nextInput) {
                            setTimeout(() => nextInput.focus(), 100);
                        }
                    } else {
                        matchMessage.classList.remove('alert-success');
                        matchMessage.classList.add('alert-danger', 'alert-show');
                        matchMessage.textContent = 'Barkod yanlƒ±≈ü!';
                    }

                    const rightInput = document.getElementById(`barkodInput-right-${productIndex}`);
                    const leftInput = document.getElementById(`barkodInput-left-${productIndex}`);
                    const expectedRight = document.getElementById(`expectedBarcode-right-${productIndex}`).value.trim();
                    const expectedLeft = document.getElementById(`expectedBarcode-left-${productIndex}`).value.trim();

                    if (rightInput.value.trim() === expectedRight && leftInput.value.trim() === expectedLeft) {
                        barkodDogruList[productIndex] = true;
                    } else {
                        barkodDogruList[productIndex] = false;
                    }

                    if (barkodDogruList.every(Boolean)) {
                        onaylaBtn.classList.remove('disabled-btn');
                        yazdirBtn.classList.remove('disabled-btn');
                        onaylaBtn.disabled = false;
                        yazdirBtn.disabled = false;

                        setTimeout(() => {
                            yazdirForm.submit();  // 5 saniye sonra yazdƒ±r
                        }, 5000);

                        setTimeout(() => {
                            onaylaBtn.click();  // 15 saniye sonra onayla
                        }, 15000);
                    } else {
                        onaylaBtn.classList.add('disabled-btn');
                        yazdirBtn.classList.add('disabled-btn');
                        onaylaBtn.disabled = true;
                        yazdirBtn.disabled = true;
                    }
                });
            });
        });

        function copyToClipboard(elementId, element) {
            const text = document.getElementById(elementId).innerText;
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            const confirmation = element.nextElementSibling;
            confirmation.classList.add('show');
            setTimeout(() => {
                confirmation.classList.remove('show');
            }, 2000);
        }

        function showArchiveModal(order_number) {
            document.getElementById('archiveOrderNumber').value = order_number;
            $('#archiveModal').modal('show');
        }

        $('#archiveForm').submit(function(event) {
            event.preventDefault();
            var order_number = $('#archiveOrderNumber').val();
            var archive_reason = $('#archiveReason').val();

            if (!archive_reason) {
                alert('L√ºtfen bir sebep se√ßin.');
                return;
            }

            $.post('/archive_order', { order_number: order_number, archive_reason: archive_reason }, function(response) {
                if (response.success) {
                    $('#archiveModal').modal('hide');
                    $('#archiveSuccessToast').toast('show');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    alert('Sipari≈ü ar≈üivlenirken hata: ' + response.message);
                }
            }).fail(function() {
                alert('Sipari≈ü ar≈üivlenirken bir hata olu≈ütu.');
            });
        });
    </script>
</body>
</html>
