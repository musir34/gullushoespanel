
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Trendyol Webhook Kurulumu</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <p><i class="bi bi-info-circle"></i> <strong>Webhook nedir?</strong> Webhook, siparişlerinizi çekmek için sürekli API sorgularına ihtiyaç duymadan, belirli olaylar gerçekleştiğinde Trendyol'un sizin belirlediğiniz URL'ye otomatik bildirim göndermesini sağlayan bir mekanizmadır.</p>
          </div>

          <h5 class="mt-4">1. Endpoint Bilgileri</h5>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Webhook Tipi</th>
                  <th>URL</th>
                  <th>Açıklama</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Sipariş Bildirimleri</td>
                  <td><code>{{ order_webhook_url }}</code></td>
                  <td>Sipariş oluşturma, statü değişim bildirimleri</td>
                </tr>
                <tr>
                  <td>Ürün Bildirimleri</td>
                  <td><code>{{ product_webhook_url }}</code></td>
                  <td>Ürün, fiyat ve stok değişim bildirimleri</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h5 class="mt-4">2. Webhook Durumu</h5>
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">
                  Sipariş Webhook Durumu
                </div>
                <div class="card-body">
                  <div id="orderWebhookStatus" class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Kontrol ediliyor...</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header">
                  Ürün Webhook Durumu
                </div>
                <div class="card-body">
                  <div id="productWebhookStatus" class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Kontrol ediliyor...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
            <button class="btn btn-success" onclick="registerWebhooks()">
              <i class="bi bi-plus-circle"></i> Webhook'ları Kaydet/Güncelle
            </button>
            <button class="btn btn-primary" onclick="checkWebhookStatus()">
              <i class="bi bi-arrow-repeat"></i> Durumu Yenile
            </button>
          </div>

          <h5 class="mt-5">3. Son Bildirimler</h5>
          <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="order-tab" data-bs-toggle="tab" data-bs-target="#order-events" type="button">Sipariş Bildirimleri</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="product-tab" data-bs-toggle="tab" data-bs-target="#product-events" type="button">Ürün Bildirimleri</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">Loglar</button>
            </li>
          </ul>
          
          <div class="tab-content mt-3">
            <div class="tab-pane fade show active" id="order-events">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Tarih</th>
                      <th>Sipariş No</th>
                      <th>Durum</th>
                      <th>Detay</th>
                    </tr>
                  </thead>
                  <tbody id="orderEvents">
                    <tr>
                      <td colspan="4" class="text-center">Henüz bildirim alınmadı</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div class="tab-pane fade" id="product-events">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Tarih</th>
                      <th>Barkod</th>
                      <th>İşlem</th>
                      <th>Detay</th>
                    </tr>
                  </thead>
                  <tbody id="productEvents">
                    <tr>
                      <td colspan="4" class="text-center">Henüz bildirim alınmadı</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div class="tab-pane fade" id="logs">
              <div class="mb-3">
                <label for="logType" class="form-label">Log Tipi:</label>
                <select class="form-select" id="logType" onchange="refreshLogs()">
                  <option value="all">Tümü</option>
                  <option value="order">Sipariş</option>
                  <option value="product">Ürün</option>
                  <option value="error">Hata</option>
                </select>
              </div>
              <div class="card">
                <div class="card-body">
                  <pre id="logContent" class="bg-light p-3" style="max-height: 400px; overflow: auto;">{{ logs }}</pre>
                </div>
              </div>
              <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-2">
                <button class="btn btn-sm btn-primary" onclick="refreshLogs()">
                  <i class="bi bi-arrow-repeat"></i> Logları Yenile
                </button>
              </div>
            </div>
          </div>

          <h5 class="mt-5">4. Trendyol Webhook Kurulum Adımları</h5>
          <div class="card">
            <div class="card-body">
              <ol>
                <li>Trendyol Satıcı Paneli'ne giriş yapın.</li>
                <li>Hesap Bilgilerim > Entegrasyon Bilgileri sayfasına gidin.</li>
                <li>API KEY ve API SECRET KEY bilgilerinizi kontrol edin.</li>
                <li>Bu bilgileri .env dosyanızda veya trendyol_api.py dosyasında güncelleyin.</li>
                <li>Trendyol'da webhook kullanmak için yukarıdaki "Webhook'ları Kaydet" butonuna tıklayın.</li>
                <li>İlk webhook ayarlandıktan sonra, Trendyol otomatik olarak webhooklar yoluyla bildirim göndermeye başlayacaktır.</li>
              </ol>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Sayfa yüklendiğinde webhook durumunu kontrol et
document.addEventListener('DOMContentLoaded', function() {
  checkWebhookStatus();
});

// Webhook durumunu kontrol et
function checkWebhookStatus() {
  fetch('/api/webhook-status')
    .then(response => response.json())
    .then(data => {
      // Sipariş webhook durumu
      const orderStatusElement = document.getElementById('orderWebhookStatus');
      orderStatusElement.innerHTML = '';
      
      let orderStatus = 'Pasif';
      let orderStatusClass = 'text-danger';
      
      if (data.order_webhook_active) {
        orderStatus = 'Aktif';
        orderStatusClass = 'text-success';
      }
      
      orderStatusElement.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="me-2 ${orderStatusClass}"><i class="bi bi-circle-fill"></i></div>
          <span>Webhook Durumu: <strong>${orderStatus}</strong></span>
        </div>
      `;
      
      // Ürün webhook durumu
      const productStatusElement = document.getElementById('productWebhookStatus');
      productStatusElement.innerHTML = '';
      
      let productStatus = 'Pasif';
      let productStatusClass = 'text-danger';
      
      if (data.product_webhook_active) {
        productStatus = 'Aktif';
        productStatusClass = 'text-success';
      }
      
      productStatusElement.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="me-2 ${productStatusClass}"><i class="bi bi-circle-fill"></i></div>
          <span>Webhook Durumu: <strong>${productStatus}</strong></span>
        </div>
      `;

      // Olay tablolarını güncelle
      updateEventTables(data.recent_order_events, data.recent_product_events);
    })
    .catch(error => {
      console.error('Webhook durumu kontrol edilirken hata:', error);
      
      document.getElementById('orderWebhookStatus').innerHTML = `
        <div class="text-danger">
          <i class="bi bi-exclamation-triangle"></i> Durum kontrol edilirken hata oluştu.
        </div>
      `;
      
      document.getElementById('productWebhookStatus').innerHTML = `
        <div class="text-danger">
          <i class="bi bi-exclamation-triangle"></i> Durum kontrol edilirken hata oluştu.
        </div>
      `;
    });
}

// Webhook'ları kaydet
function registerWebhooks() {
  if (confirm('Trendyol API\'ye yeni webhook\'ları kaydetmek istediğinizden emin misiniz?')) {
    // Butonları devre dışı bırak
    document.querySelectorAll('button').forEach(btn => {
      btn.disabled = true;
    });
    
    fetch('/api/register-webhooks', {
      method: 'POST'
    })
      .then(response => response.json())
      .then(data => {
        // Butonları tekrar etkinleştir
        document.querySelectorAll('button').forEach(btn => {
          btn.disabled = false;
        });
        
        if (data.success) {
          alert('Webhook\'lar başarıyla kaydedildi!');
          checkWebhookStatus();
        } else {
          alert('Webhook kaydı sırasında bir hata oluştu: ' + data.error);
        }
      })
      .catch(error => {
        // Butonları tekrar etkinleştir
        document.querySelectorAll('button').forEach(btn => {
          btn.disabled = false;
        });
        
        console.error('Webhook kaydı sırasında hata:', error);
        alert('Webhook kaydı sırasında bir hata oluştu');
      });
  }
}

// Logları yenile
function refreshLogs() {
  const logType = document.getElementById('logType').value;
  
  fetch(`/api/webhook-logs?type=${logType}`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('logContent').textContent = data.logs;
    })
    .catch(error => {
      console.error('Loglar getirilirken hata:', error);
      document.getElementById('logContent').textContent = 'Loglar yüklenirken bir hata oluştu.';
    });
}

// Olay tablolarını güncelle
function updateEventTables(orderEvents, productEvents) {
  // Sipariş olayları tablosu
  const orderEventsTable = document.getElementById('orderEvents');
  orderEventsTable.innerHTML = '';
  
  if (orderEvents && orderEvents.length > 0) {
    orderEvents.forEach(event => {
      const row = document.createElement('tr');
      
      const timestamp = document.createElement('td');
      timestamp.textContent = event.timestamp || '-';
      
      const orderNo = document.createElement('td');
      orderNo.textContent = event.order_number || '-';
      
      const status = document.createElement('td');
      status.innerHTML = `<span class="badge bg-${getStatusBadgeColor(event.status)}">${event.status || '-'}</span>`;
      
      const detail = document.createElement('td');
      detail.innerHTML = `<button class="btn btn-sm btn-outline-info" onclick="showEventDetail('order', ${JSON.stringify(event).replace(/"/g, '&quot;')})">
        <i class="bi bi-info-circle"></i>
      </button>`;
      
      row.appendChild(timestamp);
      row.appendChild(orderNo);
      row.appendChild(status);
      row.appendChild(detail);
      
      orderEventsTable.appendChild(row);
    });
  } else {
    orderEventsTable.innerHTML = `<tr><td colspan="4" class="text-center">Henüz bildirim alınmadı</td></tr>`;
  }
  
  // Ürün olayları tablosu
  const productEventsTable = document.getElementById('productEvents');
  productEventsTable.innerHTML = '';
  
  if (productEvents && productEvents.length > 0) {
    productEvents.forEach(event => {
      const row = document.createElement('tr');
      
      const timestamp = document.createElement('td');
      timestamp.textContent = event.timestamp || '-';
      
      const barcode = document.createElement('td');
      barcode.textContent = event.barcode || '-';
      
      const action = document.createElement('td');
      action.textContent = event.type || '-';
      
      const detail = document.createElement('td');
      detail.innerHTML = `<button class="btn btn-sm btn-outline-info" onclick="showEventDetail('product', ${JSON.stringify(event).replace(/"/g, '&quot;')})">
        <i class="bi bi-info-circle"></i>
      </button>`;
      
      row.appendChild(timestamp);
      row.appendChild(barcode);
      row.appendChild(action);
      row.appendChild(detail);
      
      productEventsTable.appendChild(row);
    });
  } else {
    productEventsTable.innerHTML = `<tr><td colspan="4" class="text-center">Henüz bildirim alınmadı</td></tr>`;
  }
}

// Durum badge rengini belirle
function getStatusBadgeColor(status) {
  switch (status) {
    case 'CREATED':
      return 'primary';
    case 'PICKING':
    case 'INVOICED':
    case 'AWAITING':
      return 'info';
    case 'SHIPPED':
      return 'warning';
    case 'DELIVERED':
    case 'VERIFIED':
      return 'success';
    case 'CANCELLED':
    case 'UNDELIVERED':
    case 'RETURNED':
    case 'UNSUPPLIED':
      return 'danger';
    default:
      return 'secondary';
  }
}

// Olay detayını göster
function showEventDetail(type, event) {
  // Detay modalı HTML'i
  const modalHTML = `
    <div class="modal fade" id="eventDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">${type === 'order' ? 'Sipariş' : 'Ürün'} Bildirimi Detayı</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <pre class="bg-light p-3" style="max-height: 400px; overflow: auto;">${JSON.stringify(event, null, 2)}</pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Varsa eski modalı kaldır
  const oldModal = document.getElementById('eventDetailModal');
  if (oldModal) {
    oldModal.remove();
  }
  
  // Yeni modalı ekle
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Modalı göster
  const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
  modal.show();
}
</script>
{% endblock %}
