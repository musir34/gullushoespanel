{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Trendyol Webhook Kurulum ve İzleme Paneli</h2>

  <div class="alert alert-info mb-4">
    <h5>Webhook Nedir?</h5>
    <p>Webhook'lar, Trendyol'daki sipariş ve ürün değişikliklerinin gerçek zamanlı olarak sisteminize bildirilmesini sağlar. Bu sayede, siparişler ve ürünlerle ilgili güncellemeleri anında alabilirsiniz.</p>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">Webhook Durumu</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5>Sipariş Webhook URL:</h5>
              <code id="orderWebhookUrl">{{ order_webhook_url }}</code>
            </div>
            <div>
              <span id="orderWebhookStatus" class="badge bg-secondary">Kontrol Ediliyor...</span>
            </div>
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5>Ürün Webhook URL:</h5>
              <code id="productWebhookUrl">{{ product_webhook_url }}</code>
            </div>
            <div>
              <span id="productWebhookStatus" class="badge bg-secondary">Kontrol Ediliyor...</span>
            </div>
          </div>
          <hr>
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-primary" id="checkStatus">
              <i class="bi bi-arrow-repeat"></i> Webhook Durumunu Kontrol Et
            </button>
            <button class="btn btn-success" id="registerWebhooks">
              <i class="bi bi-cloud-arrow-up"></i> Webhook'ları Kaydet
            </button>
          </div>
          <div id="status-message" class="alert mt-3" style="display: none;"></div>
          <div id="detailed-error" class="alert alert-info mt-3" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0">Son Sipariş Olayları</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>Zaman</th>
                  <th>Sipariş No</th>
                  <th>Durum</th>
                  <th>İşlemler</th>
                </tr>
              </thead>
              <tbody id="orderEventsTable">
                {% for event in order_events %}
                <tr>
                  <td>{{ event.timestamp }}</td>
                  <td>{{ event.order_number }}</td>
                  <td>
                    <span class="badge {% if event.status == 'DELIVERED' %}bg-success{% elif event.status == 'CANCELLED' %}bg-danger{% else %}bg-primary{% endif %}">
                      {{ event.status }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-info" onclick="showEventDetails('order', {{ loop.index0 }})">
                      <i class="bi bi-eye"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if not order_events %}
          <div class="alert alert-warning">Henüz sipariş olayı kaydedilmemiş.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="card-title mb-0">Son Ürün Olayları</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>Zaman</th>
                  <th>Barkod</th>
                  <th>Tip</th>
                  <th>İşlemler</th>
                </tr>
              </thead>
              <tbody id="productEventsTable">
                {% for event in product_events %}
                <tr>
                  <td>{{ event.timestamp }}</td>
                  <td>{{ event.barcode }}</td>
                  <td>
                    <span class="badge {% if event.type == 'ProductCreated' %}bg-success{% elif event.type == 'PriceChanged' %}bg-warning{% else %}bg-info{% endif %}">
                      {{ event.type }}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-info" onclick="showEventDetails('product', {{ loop.index0 }})">
                      <i class="bi bi-eye"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if not product_events %}
          <div class="alert alert-warning">Henüz ürün olayı kaydedilmemiş.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h5 class="card-title mb-0">Webhook Logları</h5>
        </div>
        <div class="card-body">
          <div class="btn-group mb-3">
            <button class="btn btn-outline-primary" onclick="filterLogs('all')">Tümü</button>
            <button class="btn btn-outline-primary" onclick="filterLogs('order')">Sipariş</button>
            <button class="btn btn-outline-primary" onclick="filterLogs('product')">Ürün</button>
            <button class="btn btn-outline-danger" onclick="filterLogs('error')">Hatalar</button>
          </div>
          <div class="logs-container bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: auto;">
            <pre id="logsContent">{{ logs }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Olay Detay Modalı -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Olay Detayı</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre id="eventDetailContent" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Sayfa yüklendiğinde webhook durumunu kontrol et
  checkWebhookStatus();

  // Webhook durumu kontrol butonuna tıklama
  document.getElementById('checkStatus').addEventListener('click', function() {
    checkWebhookStatus();
  });

  // Webhook kayıt butonuna tıklama
  document.getElementById('registerWebhooks').addEventListener('click', function() {
    registerWebhooks();
  });

  // Düzenli aralıklarla webhook durumunu kontrol et (60 saniyede bir)
  setInterval(checkWebhookStatus, 60000);
});

// Webhook durumu kontrolü
function checkWebhookStatus() {
  // Durum göstergelerini "Kontrol Ediliyor..." olarak ayarla
  const orderStatus = document.getElementById('orderWebhookStatus');
  const productStatus = document.getElementById('productWebhookStatus');
  const detailsContainer = document.getElementById('webhookDetails') || document.createElement('div');

  orderStatus.className = 'badge bg-secondary';
  orderStatus.textContent = 'Kontrol Ediliyor...';

  productStatus.className = 'badge bg-secondary';
  productStatus.textContent = 'Kontrol Ediliyor...';

  // API çağrısı yap
  fetch('/api/webhook-status')
    .then(response => response.json())
    .then(data => {
      console.log('Webhook durumu:', data);

      // Ayrıntılı bilgiyi göster
      if (data.webhook_details && data.webhook_details.length > 0) {
        let detailsHtml = '<div class="mt-4 mb-2"><h6>Webhook Detayları:</h6><ul class="list-group">';
        
        data.webhook_details.forEach(webhook => {
          const statusClass = webhook.status && webhook.status.toUpperCase() === 'ACTIVE' ? 'bg-success' : 'bg-danger';
          detailsHtml += `
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>ID:</strong> ${webhook.id} <br>
                  <strong>İsim:</strong> ${webhook.name} <br>
                  <strong>URL:</strong> <small>${webhook.url}</small>
                </div>
                <div>
                  <span class="badge ${statusClass}">${webhook.status || 'Bilinmiyor'}</span>
                </div>
              </div>
            </li>
          `;
        });
        
        detailsHtml += '</ul></div>';
        
        // Detay bölümünü ekle/güncelle
        if (!document.getElementById('webhookDetails')) {
          const detailsDiv = document.createElement('div');
          detailsDiv.id = 'webhookDetails';
          document.querySelector('.card-body').appendChild(detailsDiv);
        }
        
        document.getElementById('webhookDetails').innerHTML = detailsHtml;
      }

      // Aktif webhook sayısı
      const hasActiveWebhook = data.webhook_details && data.webhook_details.some(wh => wh.status && wh.status.toUpperCase() === 'ACTIVE');
      
      // Webhook türünü URL'den tespit et
      const hasOrderWebhook = data.webhook_details && data.webhook_details.some(wh => wh.url && wh.url.includes('webhook/orders') && wh.status && wh.status.toUpperCase() === 'ACTIVE');
      const hasProductWebhook = data.webhook_details && data.webhook_details.some(wh => wh.url && wh.url.includes('webhook/products') && wh.status && wh.status.toUpperCase() === 'ACTIVE');
      
      // Sipariş webhook durumunu güncelle
      if (hasOrderWebhook || (hasActiveWebhook && data.order_webhook_active)) {
        orderStatus.className = 'badge bg-success';
        orderStatus.textContent = 'Aktif';
      } else {
        orderStatus.className = 'badge bg-danger';
        orderStatus.textContent = 'Pasif';
      }

      // Ürün webhook durumunu güncelle
      if (hasProductWebhook || (hasActiveWebhook && data.product_webhook_active)) {
        productStatus.className = 'badge bg-success';
        productStatus.textContent = 'Aktif';
      } else {
        // Trendyol'un tek webhook desteği sebebiyle, uyarı olarak göster
        productStatus.className = 'badge bg-warning';
        productStatus.textContent = hasActiveWebhook ? 'Trendyol Kısıtlaması' : 'Pasif';
        
        // Trendyol kısıtlaması ile ilgili açıklama ekle
        if (hasActiveWebhook && !document.getElementById('webhook-restriction-warning')) {
          const restrictionDiv = document.createElement('div');
          restrictionDiv.id = 'webhook-restriction-warning';
          restrictionDiv.className = 'alert alert-warning mt-3';
          restrictionDiv.innerHTML = '<strong>Trendyol Kısıtlaması:</strong> Trendyol API\'si her satıcı için yalnızca bir adet aktif webhook\'a izin vermektedir. Şu anda sipariş webhook\'u aktif olduğu için, ürün webhook\'u aktif edilemiyor. Her ikisini birden kullanmak isterseniz, sipariş webhook\'u üzerinden gelen bildirimler içerisinde ürün bilgilerini de alabilirsiniz.';
          
          document.querySelector('.card-body').appendChild(restrictionDiv);
        }
      }
      
      // Trendyol'un webhook sınırlamasını belirt
      if (hasActiveWebhook && !data.product_webhook_active && !data.order_webhook_active) {
        // Uyarı mesajı ekle
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info mt-2';
        alertDiv.innerHTML = '<strong>Not:</strong> Webhook API durumunda bir çelişki var - webhook aktif görünüyor ancak kontrol sistemi pasif olarak algılıyor. Sistem yine de çalışacaktır.';
        
        if (!document.querySelector('.webhook-api-warning')) {
          alertDiv.classList.add('webhook-api-warning');
          document.querySelector('.card-body').appendChild(alertDiv);
        }
      }

      // Olay tablolarını güncelle
      updateEventTables(data.recent_order_events, data.recent_product_events);

      // Hata varsa göster
      if (data.error) {
        showToast('Webhook Durumu Hatası', data.error, 'error');
      }
    })
    .catch(error => {
      console.error('Webhook durumu kontrol edilirken hata:', error);
      showToast('Hata', 'Webhook durumu kontrol edilirken bir hata oluştu.', 'error');

      // Hata durumunda durum göstergelerini güncelle
      orderStatus.className = 'badge bg-danger';
      orderStatus.textContent = 'Hata';

      productStatus.className = 'badge bg-danger';
      productStatus.textContent = 'Hata';
    });
}

// Webhook kayıt işlemi
function registerWebhooks() {
  // Butonları devre dışı bırak
  document.getElementById('registerWebhooks').disabled = true;
  document.getElementById('checkStatus').disabled = true;

  // İşlem göstergesini göster
  showToast('İşlem Başlatıldı', 'Webhook kayıt işlemi başlatıldı...', 'info');

  // API çağrısı yap
  fetch('/api/register-webhooks', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
      // Butonları tekrar aktif hale getir
      document.getElementById('registerWebhooks').disabled = false;
      document.getElementById('checkStatus').disabled = false;
      document.getElementById('status-message').style.display = 'none';
      document.getElementById('detailed-error').style.display = 'none';


      if (data.success) {
        showToast('Başarılı', 'Webhook\'lar başarıyla kaydedildi.', 'success');
        // Webhook durumunu güncelle
        setTimeout(checkWebhookStatus, 2000);
      } else {
        // Show detailed error message
        const statusMessage = document.getElementById('status-message');
        const detailedError = document.getElementById('detailed-error');
        statusMessage.className = 'alert alert-danger mt-3';
        statusMessage.textContent = 'Webhook kayıt işlemi başarısız oldu. Detaylar aşağıda.';
        statusMessage.style.display = 'block';

        detailedError.className = 'alert alert-warning mt-3';
        detailedError.textContent = data.error || 'Bilinmeyen hata';
        detailedError.style.display = 'block';

      }
    })
    .catch(error => {
      console.error('Webhook kayıt hatası:', error);
      showToast('Hata', 'Webhook kayıt işlemi sırasında bir hata oluştu: ' + error.message, 'error');

      // Butonları tekrar aktif hale getir
      document.getElementById('registerWebhooks').disabled = false;
      document.getElementById('checkStatus').disabled = false;
    });
}

// Olay tablolarını güncelle
function updateEventTables(orderEvents, productEvents) {
  // Sipariş olayları tablosunu güncelle
  const orderEventsTable = document.getElementById('orderEventsTable');
  orderEventsTable.innerHTML = '';

  if (orderEvents && orderEvents.length > 0) {
    orderEvents.forEach((event, index) => {
      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${event.timestamp || ''}</td>
        <td>${event.order_number || ''}</td>
        <td>
          <span class="badge ${getStatusBadgeClass(event.status)}">
            ${event.status || ''}
          </span>
        </td>
        <td>
          <button class="btn btn-sm btn-info" onclick="showEventDetails('order', ${index})">
            <i class="bi bi-eye"></i>
          </button>
        </td>
      `;

      orderEventsTable.appendChild(row);
    });
  } else {
    const row = document.createElement('tr');
    row.innerHTML = '<td colspan="4" class="text-center">Henüz sipariş olayı kaydedilmemiş.</td>';
    orderEventsTable.appendChild(row);
  }

  // Ürün olayları tablosunu güncelle
  const productEventsTable = document.getElementById('productEventsTable');
  productEventsTable.innerHTML = '';

  if (productEvents && productEvents.length > 0) {
    productEvents.forEach((event, index) => {
      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${event.timestamp || ''}</td>
        <td>${event.barcode || ''}</td>
        <td>
          <span class="badge ${getTypeBadgeClass(event.type)}">
            ${event.type || ''}
          </span>
        </td>
        <td>
          <button class="btn btn-sm btn-info" onclick="showEventDetails('product', ${index})">
            <i class="bi bi-eye"></i>
          </button>
        </td>
      `;

      productEventsTable.appendChild(row);
    });
  } else {
    const row = document.createElement('tr');
    row.innerHTML = '<td colspan="4" class="text-center">Henüz ürün olayı kaydedilmemiş.</td>';
    productEventsTable.appendChild(row);
  }
}

// Sipariş durumuna göre badge sınıfı döndür
function getStatusBadgeClass(status) {
  if (!status) return 'bg-secondary';

  switch (status.toUpperCase()) {
    case 'DELIVERED':
      return 'bg-success';
    case 'CANCELLED':
    case 'UNDELIVERED':
    case 'RETURNED':
      return 'bg-danger';
    case 'SHIPPED':
      return 'bg-info';
    case 'CREATED':
      return 'bg-primary';
    case 'PICKING':
    case 'INVOICED':
      return 'bg-warning';
    default:
      return 'bg-secondary';
  }
}

// Olay tipine göre badge sınıfı döndür
function getTypeBadgeClass(type) {
  if (!type) return 'bg-secondary';

  switch (type) {
    case 'ProductCreated':
      return 'bg-success';
    case 'ProductUpdated':
      return 'bg-info';
    case 'PriceChanged':
      return 'bg-warning';
    case 'StockChanged':
      return 'bg-primary';
    default:
      return 'bg-secondary';
  }
}

// Olay detaylarını göster
function showEventDetails(eventType, index) {
  // API çağrısı yap
  fetch(`/api/webhook-status`)
    .then(response => response.json())
    .then(data => {
      const events = eventType === 'order' ? data.recent_order_events : data.recent_product_events;

      if (events && events.length > index) {
        const event = events[index];
        const eventDetailContent = document.getElementById('eventDetailContent');

        // JSON formatında göster
        eventDetailContent.textContent = JSON.stringify(event, null, 2);

        // Modalı göster
        const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
        modal.show();
      }
    })
    .catch(error => {
      console.error('Olay detayları alınırken hata:', error);
      showToast('Hata', 'Olay detayları alınırken bir hata oluştu.', 'error');
    });
}

// Log filtreleme
function filterLogs(type) {
  fetch(`/api/webhook-logs?type=${type}`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('logsContent').textContent = data.logs;
    })
    .catch(error => {
      console.error('Log filtreleme hatası:', error);
      showToast('Hata', 'Loglar filtrelenirken bir hata oluştu.', 'error');
    });
}

// Bildirim göster
function showToast(title, message, type = 'info') {
  const toastContainer = document.createElement('div');
  toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
  toastContainer.style.zIndex = '5';

  const bgClass = type === 'error' ? 'bg-danger' :
                  type === 'success' ? 'bg-success' :
                  type === 'warning' ? 'bg-warning' : 'bg-info';

  toastContainer.innerHTML = `
    <div class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <strong>${title}</strong>: ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;

  document.body.appendChild(toastContainer);

  const toastElement = toastContainer.querySelector('.toast');
  const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });

  toast.show();

  // Toast kapandığında container'ı kaldır
  toastElement.addEventListener('hidden.bs.toast', function() {
    document.body.removeChild(toastContainer);
  });
}
</script>
{% endblock %}