
{% extends 'base.html' %}

{% block title %}Toplu Kâr Analizi{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Toplu Kâr Analizi</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="card bg-primary text-white mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Toplam Ürün</h5>
                                    <h2 class="display-4" id="totalProductsCount">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card bg-success text-white mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Kârlı Ürünler</h5>
                                    <h2 class="display-4" id="profitableCount">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card bg-danger text-white mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Zararlı Ürünler</h5>
                                    <h2 class="display-4" id="unprofitableCount">-</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="card bg-info text-white mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Ortalama Kâr Marjı</h5>
                                    <h2 class="display-4" id="avgMargin">-</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Ürün Seçimi</h5>
                                </div>
                                <div class="card-body">
                                    <form id="bulkAnalysisForm">
                                        <div class="form-group">
                                            <label>Analiz Yöntemi:</label>
                                            <select class="form-control" id="analysisMethod">
                                                <option value="all">Tüm Ürünler</option>
                                                <option value="barcodes">Belirli Barkodlar</option>
                                                <option value="model">Model Koduna Göre</option>
                                                <option value="color">Renge Göre</option>
                                                <option value="size">Bedene Göre</option>
                                            </select>
                                        </div>
                                        
                                        <div id="barcodesInput" class="form-group" style="display: none;">
                                            <label>Ürün Barkodları:</label>
                                            <textarea class="form-control" id="barcodesList" rows="5" placeholder="Her satıra bir barkod girin"></textarea>
                                        </div>
                                        
                                        <div id="modelInput" class="form-group" style="display: none;">
                                            <label>Model Kodu:</label>
                                            <input type="text" class="form-control" id="modelCode" placeholder="Model kodu girin">
                                        </div>
                                        
                                        <div id="colorInput" class="form-group" style="display: none;">
                                            <label>Renk:</label>
                                            <select class="form-control" id="colorSelect">
                                                <option value="">Renk Seçin</option>
                                            </select>
                                        </div>
                                        
                                        <div id="sizeInput" class="form-group" style="display: none;">
                                            <label>Beden:</label>
                                            <select class="form-control" id="sizeSelect">
                                                <option value="">Beden Seçin</option>
                                                <option value="35">35</option>
                                                <option value="36">36</option>
                                                <option value="37">37</option>
                                                <option value="38">38</option>
                                                <option value="39">39</option>
                                                <option value="40">40</option>
                                                <option value="41">41</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>Komisyon Oranı (%):</label>
                                            <input type="number" class="form-control" id="commissionRate" value="25" placeholder="Komisyon oranını girin">
                                        </div>
                                        
                                        <button type="button" class="btn btn-primary" id="runAnalysis">Analizi Başlat</button>
                                    </form>
                                    
                                    <div id="loading" class="text-center mt-3" style="display: none;">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">Yükleniyor...</span>
                                        </div>
                                        <p>Analiz yapılıyor, lütfen bekleyin...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Analiz Sonuçları</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered" id="resultsTable">
                                            <thead>
                                                <tr>
                                                    <th>Barkod</th>
                                                    <th>Ürün Adı</th>
                                                    <th>Renk/Beden</th>
                                                    <th>Maliyet</th>
                                                    <th>Satış Fiyatı</th>
                                                    <th>Komisyon</th>
                                                    <th>Kâr</th>
                                                    <th>Kâr Marjı</th>
                                                    <th>Durum</th>
                                                </tr>
                                            </thead>
                                            <tbody id="resultsTableBody"></tbody>
                                        </table>
                                    </div>
                                    
                                    <div id="noResultsMessage" class="text-center p-5">
                                        <i class="fas fa-chart-pie fa-3x mb-3 text-muted"></i>
                                        <p>Analiz yapmak için ürün seçin ve "Analizi Başlat" butonuna tıklayın.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Kâr Dağılımı Grafikleri</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <canvas id="profitMarginChart"></canvas>
                                        </div>
                                        <div class="col-md-6">
                                            <canvas id="profitDistributionChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Analiz yöntemi değiştiğinde ilgili alanları göster/gizle
    document.getElementById('analysisMethod').addEventListener('change', function() {
        const method = this.value;
        
        // Tüm input alanlarını gizle
        document.getElementById('barcodesInput').style.display = 'none';
        document.getElementById('modelInput').style.display = 'none';
        document.getElementById('colorInput').style.display = 'none';
        document.getElementById('sizeInput').style.display = 'none';
        
        // Seçilen yönteme göre input alanını göster
        if (method === 'barcodes') {
            document.getElementById('barcodesInput').style.display = 'block';
        } else if (method === 'model') {
            document.getElementById('modelInput').style.display = 'block';
        } else if (method === 'color') {
            document.getElementById('colorInput').style.display = 'block';
            loadColors();
        } else if (method === 'size') {
            document.getElementById('sizeInput').style.display = 'block';
        }
    });
    
    // Renk seçeneklerini yükle
    function loadColors() {
        // Ajax isteği ile renkleri getir
        fetch('/api/product-colors')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const colorSelect = document.getElementById('colorSelect');
                    colorSelect.innerHTML = '<option value="">Renk Seçin</option>';
                    
                    data.colors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color;
                        option.textContent = color;
                        colorSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Renk seçenekleri yüklenirken hata:', error);
            });
    }
    
    // Analizi başlat
    document.getElementById('runAnalysis').addEventListener('click', function() {
        const method = document.getElementById('analysisMethod').value;
        const commissionRate = parseFloat(document.getElementById('commissionRate').value);
        
        if (isNaN(commissionRate) || commissionRate < 0 || commissionRate > 100) {
            alert('Lütfen geçerli bir komisyon oranı girin (0-100 arası).');
            return;
        }
        
        let requestData = {
            method: method,
            commission_rate: commissionRate
        };
        
        // Seçilen yönteme göre veri ekle
        if (method === 'barcodes') {
            const barcodes = document.getElementById('barcodesList').value.trim().split(/\n+/);
            if (barcodes.length === 0 || (barcodes.length === 1 && barcodes[0] === '')) {
                alert('Lütfen en az bir barkod numarası girin.');
                return;
            }
            requestData.barcodes = barcodes;
        } else if (method === 'model') {
            const modelCode = document.getElementById('modelCode').value.trim();
            if (!modelCode) {
                alert('Lütfen bir model kodu girin.');
                return;
            }
            requestData.model_code = modelCode;
        } else if (method === 'color') {
            const color = document.getElementById('colorSelect').value;
            if (!color) {
                alert('Lütfen bir renk seçin.');
                return;
            }
            requestData.color = color;
        } else if (method === 'size') {
            const size = document.getElementById('sizeSelect').value;
            if (!size) {
                alert('Lütfen bir beden seçin.');
                return;
            }
            requestData.size = size;
        }
        
        // Yükleniyor göster
        document.getElementById('loading').style.display = 'block';
        document.getElementById('noResultsMessage').style.display = 'none';
        document.getElementById('resultsTableBody').innerHTML = '';
        
        // Analiz isteği gönder
        fetch('/api/toplu-fiyat-analizi', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // Yükleniyor gizle
            document.getElementById('loading').style.display = 'none';
            
            if (data.success) {
                // Sonuçları göster
                showResults(data.results);
            } else {
                alert(data.error || 'Analiz sırasında bir hata oluştu.');
            }
        })
        .catch(error => {
            // Yükleniyor gizle
            document.getElementById('loading').style.display = 'none';
            console.error('Hata:', error);
            alert('Analiz sırasında bir hata oluştu.');
        });
    });
    
    // Sonuçları göster
    function showResults(results) {
        if (results.length === 0) {
            document.getElementById('noResultsMessage').style.display = 'block';
            document.getElementById('totalProductsCount').textContent = '0';
            document.getElementById('profitableCount').textContent = '0';
            document.getElementById('unprofitableCount').textContent = '0';
            document.getElementById('avgMargin').textContent = '0%';
            return;
        }
        
        const tableBody = document.getElementById('resultsTableBody');
        tableBody.innerHTML = '';
        
        let profitableCount = 0;
        let unprofitableCount = 0;
        let totalMargin = 0;
        let validMarginCount = 0;
        
        // Grafik verileri
        const profitMargins = [];
        const profitDistribution = {
            cost: 0,
            commission: 0,
            profit: 0
        };
        
        results.forEach(result => {
            if (result.status === 'error') {
                // Hata durumunu göster
                const row = document.createElement('tr');
                row.className = 'table-warning';
                
                const barcodeCell = document.createElement('td');
                barcodeCell.textContent = result.barcode;
                
                const nameCell = document.createElement('td');
                nameCell.setAttribute('colspan', '7');
                nameCell.textContent = result.message || 'Ürün bilgisi alınamadı';
                
                row.appendChild(barcodeCell);
                row.appendChild(nameCell);
                
                tableBody.appendChild(row);
            } else {
                // Başarılı analiz durumunu göster
                const row = document.createElement('tr');
                
                const isProfitable = result.analysis.is_profitable;
                if (isProfitable) {
                    profitableCount++;
                } else {
                    unprofitableCount++;
                    row.className = 'table-danger';
                }
                
                const barcodeCell = document.createElement('td');
                barcodeCell.textContent = result.barcode;
                
                const nameCell = document.createElement('td');
                nameCell.textContent = result.product_name;
                
                const colorSizeCell = document.createElement('td');
                colorSizeCell.textContent = result.color + ' / ' + result.size;
                
                const costCell = document.createElement('td');
                costCell.textContent = result.analysis.cost_price + ' TL';
                
                const saleCell = document.createElement('td');
                saleCell.textContent = result.analysis.sale_price + ' TL';
                
                const commissionCell = document.createElement('td');
                commissionCell.textContent = result.analysis.commission_amount + ' TL';
                
                const profitCell = document.createElement('td');
                profitCell.textContent = result.analysis.profit + ' TL';
                if (isProfitable) {
                    profitCell.className = 'text-success';
                } else {
                    profitCell.className = 'text-danger';
                }
                
                const marginCell = document.createElement('td');
                marginCell.textContent = result.analysis.profit_margin + '%';
                
                const statusCell = document.createElement('td');
                if (isProfitable) {
                    statusCell.innerHTML = '<span class="badge badge-success">Kârlı</span>';
                } else {
                    statusCell.innerHTML = '<span class="badge badge-danger">Zararlı</span>';
                }
                
                // Satırı tabloya ekle
                row.appendChild(barcodeCell);
                row.appendChild(nameCell);
                row.appendChild(colorSizeCell);
                row.appendChild(costCell);
                row.appendChild(saleCell);
                row.appendChild(commissionCell);
                row.appendChild(profitCell);
                row.appendChild(marginCell);
                row.appendChild(statusCell);
                
                tableBody.appendChild(row);
                
                // Ortalama kâr marjı için toplam
                if (!isNaN(result.analysis.profit_margin)) {
                    totalMargin += result.analysis.profit_margin;
                    validMarginCount++;
                }
                
                // Grafik verileri
                profitMargins.push({
                    barcode: result.barcode,
                    name: result.product_name,
                    margin: result.analysis.profit_margin
                });
                
                // Dağılım için veriler
                const salePrice = parseFloat(result.analysis.sale_price);
                const costPrice = parseFloat(result.analysis.cost_price);
                const commissionAmount = parseFloat(result.analysis.commission_amount);
                
                profitDistribution.cost += costPrice;
                profitDistribution.commission += commissionAmount;
                if (salePrice > costPrice + commissionAmount) {
                    profitDistribution.profit += (salePrice - costPrice - commissionAmount);
                }
            }
        });
        
        // Özet bilgileri güncelle
        document.getElementById('totalProductsCount').textContent = results.length;
        document.getElementById('profitableCount').textContent = profitableCount;
        document.getElementById('unprofitableCount').textContent = unprofitableCount;
        
        const avgMargin = validMarginCount > 0 ? (totalMargin / validMarginCount).toFixed(2) : '0';
        document.getElementById('avgMargin').textContent = avgMargin + '%';
        
        // Grafikleri oluştur
        createProfitMarginChart(profitMargins);
        createProfitDistributionChart(profitDistribution);
    }
    
    // Kâr marjı grafiği
    function createProfitMarginChart(data) {
        const ctx = document.getElementById('profitMarginChart').getContext('2d');
        
        // Verileri sırala
        data.sort((a, b) => b.margin - a.margin);
        
        // En yüksek ilk 10 ürünü al
        const topItems = data.slice(0, 10);
        
        const labels = topItems.map(item => {
            // Uzun ürün adlarını kısalt
            let name = item.name;
            if (name.length > 20) {
                name = name.substring(0, 17) + '...';
            }
            return name;
        });
        
        const values = topItems.map(item => item.margin);
        
        // Renk paleti oluştur
        const colors = values.map(value => {
            if (value <= 0) return '#dc3545'; // Negatif kâr - kırmızı
            if (value < 15) return '#ffc107'; // Düşük kâr - sarı
            if (value < 30) return '#17a2b8'; // Orta kâr - mavi
            return '#28a745'; // Yüksek kâr - yeşil
        });
        
        // Önceki grafiği temizle
        if (window.profitMarginChart) {
            window.profitMarginChart.destroy();
        }
        
        window.profitMarginChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Kâr Marjı (%)',
                    data: values,
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: 'En Yüksek Kâr Marjına Sahip İlk 10 Ürün'
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }
    
    // Kâr dağılımı grafiği
    function createProfitDistributionChart(data) {
        const ctx = document.getElementById('profitDistributionChart').getContext('2d');
        
        const total = data.cost + data.commission + data.profit;
        const costPercent = ((data.cost / total) * 100).toFixed(2);
        const commissionPercent = ((data.commission / total) * 100).toFixed(2);
        const profitPercent = ((data.profit / total) * 100).toFixed(2);
        
        // Önceki grafiği temizle
        if (window.profitDistributionChart) {
            window.profitDistributionChart.destroy();
        }
        
        window.profitDistributionChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [
                    `Maliyet (${costPercent}%)`,
                    `Komisyon (${commissionPercent}%)`,
                    `Kâr (${profitPercent}%)`
                ],
                datasets: [{
                    data: [data.cost, data.commission, data.profit],
                    backgroundColor: ['#dc3545', '#ffc107', '#28a745'],
                    borderColor: ['#dc3545', '#ffc107', '#28a745'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: 'Satış Fiyatı Dağılımı'
                }
            }
        });
    }
});
</script>
{% endblock %}
