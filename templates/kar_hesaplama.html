
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Ana başlık -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary-to-secondary shadow-lg">
        <div class="card-body text-white p-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="fw-bold mb-1"><i class="bi bi-calculator me-2"></i> Kar Analizi Hesaplama</h2>
              <p class="mb-0">Ürünlerin maliyetlerini girerek kar marjlarını ve toplam karı hesaplayın</p>
            </div>
            <div class="d-flex">
              <button id="printReport" class="btn btn-sm btn-light me-2">
                <i class="bi bi-printer-fill me-1"></i> Yazdır
              </button>
              <button id="exportExcel" class="btn btn-sm btn-light">
                <i class="bi bi-file-excel me-1"></i> Excel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ortak maliyet girişi  -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Ortak Maliyet Kalemleri</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="mb-3">
                <label for="shipping_cost" class="form-label">Kargo Ücreti (TL/ürün)</label>
                <input type="number" id="shipping_cost" class="form-control" min="0" step="0.01" value="30.00">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="labor_cost" class="form-label">İşçilik Maliyeti (TL/ürün)</label>
                <input type="number" id="labor_cost" class="form-control" min="0" step="0.01" value="20.00">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="packaging_cost" class="form-label">Paketleme Maliyeti (TL/ürün)</label>
                <input type="number" id="packaging_cost" class="form-control" min="0" step="0.01" value="10.00">
              </div>
            </div>
            <div class="col-md-3">
              <div class="mb-3">
                <label for="exchange_rate" class="form-label">Güncel Dolar Kuru (TL)</label>
                <div class="input-group">
                  <input type="number" id="exchange_rate" class="form-control" min="0" step="0.01" value="{{ current_rate }}">
                  <button class="btn btn-outline-secondary" type="button" id="refresh_rate">
                    <i class="bi bi-arrow-repeat"></i>
                  </button>
                </div>
                <small class="text-muted">Son güncelleme: <span id="last_update">{{ now }}</span></small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Model bazlı maliyet girişi ve sonuçlar -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Model Maliyetleri</h5>
          <button id="calculate_profit" class="btn btn-primary">
            <i class="bi bi-calculator"></i> Kar Hesapla
          </button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-bordered" id="model_costs_table">
              <thead class="table-dark">
                <tr>
                  <th style="width: 80px;">Görsel</th>
                  <th>Model Kodu</th>
                  <th>Satış Adedi</th>
                  <th>Satış Geliri (TL)</th>
                  <th>Birim Maliyet (USD)</th>
                </tr>
              </thead>
              <tbody>
                {% for model in model_data %}
                <tr data-model-id="{{ model.model_id }}">
                  <td>
                    {% if model.image_url %}
                    <img src="{{ model.image_url }}" class="img-thumbnail" style="max-height: 50px;" alt="{{ model.model_id }}">
                    {% else %}
                    <div class="bg-light text-center p-2"><i class="bi bi-image text-muted"></i></div>
                    {% endif %}
                  </td>
                  <td>{{ model.model_id }}</td>
                  <td class="text-end">{{ model.count }}</td>
                  <td class="text-end">{{ "%.2f"|format(model.total_amount) }} ₺</td>
                  <td>
                    <input type="number" class="form-control form-control-sm cost-input" 
                      data-model-id="{{ model.model_id }}" min="0" step="0.01" value="0">
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Kar Analizi Sonuçları</h5>
        </div>
        <div class="card-body">
          <div id="results_placeholder">
            <div class="text-center py-5 text-muted">
              <i class="bi bi-calculator display-4"></i>
              <p class="mt-3">Kar analizini görmek için "Kar Hesapla" butonuna tıklayın.</p>
            </div>
          </div>

          <div id="results_container" style="display: none;">
            <h5 class="border-bottom pb-2 mb-3">Özet</h5>
            <div class="row g-3 mb-4">
              <div class="col-6">
                <div class="card bg-light h-100">
                  <div class="card-body p-3">
                    <h6 class="text-muted mb-1">Toplam Gelir</h6>
                    <h4 class="mb-0 text-primary" id="total_revenue">0 ₺</h4>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card bg-light h-100">
                  <div class="card-body p-3">
                    <h6 class="text-muted mb-1">Toplam Maliyet</h6>
                    <h4 class="mb-0 text-danger" id="total_cost">0 ₺</h4>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card bg-light h-100">
                  <div class="card-body p-3">
                    <h6 class="text-muted mb-1">Toplam Kar</h6>
                    <h4 class="mb-0 text-success" id="total_profit">0 ₺</h4>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="card bg-light h-100">
                  <div class="card-body p-3">
                    <h6 class="text-muted mb-1">Kar Marjı</h6>
                    <h4 class="mb-0 text-success" id="profit_margin">%0</h4>
                  </div>
                </div>
              </div>
            </div>

            <h5 class="border-bottom pb-2 mb-3">Model Bazlı Kar Analizi</h5>
            <div class="table-responsive">
              <table class="table table-sm table-striped" id="results_table">
                <thead class="table-dark">
                  <tr>
                    <th>Model</th>
                    <th class="text-end">Adet</th>
                    <th class="text-end">Kar</th>
                    <th class="text-end">Marj</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- JavaScript ile doldurulacak -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Güncel döviz kurunu al
    document.getElementById('refresh_rate').addEventListener('click', async function() {
      try {
        const response = await fetch('/api/guncel-kur');
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('exchange_rate').value = data.rate.toFixed(2);
          document.getElementById('last_update').textContent = new Date().toLocaleString();
        } else {
          showAlert('Döviz kuru güncellenirken bir hata oluştu: ' + data.error, 'danger');
        }
      } catch (error) {
        showAlert('Döviz kuru güncellenirken bir hata oluştu: ' + error.message, 'danger');
      }
    });

    // Kar hesaplama
    document.getElementById('calculate_profit').addEventListener('click', async function() {
      try {
        // Maliyet verilerini topla
        const modelCosts = {};
        document.querySelectorAll('.cost-input').forEach(input => {
          const modelId = input.dataset.modelId;
          const costValue = parseFloat(input.value) || 0;
          modelCosts[modelId] = costValue;
        });

        // Ortak maliyet değerlerini al
        const shippingCost = parseFloat(document.getElementById('shipping_cost').value) || 0;
        const laborCost = parseFloat(document.getElementById('labor_cost').value) || 0;
        const packagingCost = parseFloat(document.getElementById('packaging_cost').value) || 0;
        const exchangeRate = parseFloat(document.getElementById('exchange_rate').value) || 0;

        // API'ye gönder
        const response = await fetch('/api/hesapla-kar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model_costs: modelCosts,
            shipping_cost: shippingCost,
            labor_cost: laborCost,
            packaging_cost: packagingCost,
            exchange_rate: exchangeRate
          }),
        });

        const data = await response.json();
        
        if (data.success) {
          // Sonuçları göster
          displayResults(data);
        } else {
          showAlert('Kar hesaplanırken bir hata oluştu: ' + data.error, 'danger');
        }
      } catch (error) {
        showAlert('Kar hesaplanırken bir hata oluştu: ' + error.message, 'danger');
      }
    });

    // Yazdırma işlemi
    document.getElementById('printReport').addEventListener('click', function() {
      window.print();
    });

    // Excel'e aktarma
    document.getElementById('exportExcel').addEventListener('click', function() {
      // Tablonun Excel'e aktarılması için temel işlem
      const table = document.getElementById('results_table');
      if (!table || table.style.display === 'none') {
        showAlert('Excel\'e aktarılacak sonuç bulunamadı. Önce kar hesaplayın.', 'warning');
        return;
      }

      // Excel dışa aktarma işlemi burada yapılacak
      exportTableToExcel(table, 'Kar_Analizi_' + new Date().toISOString().slice(0, 10));
    });

    // Tablo Excel'e aktarma fonksiyonu
    function exportTableToExcel(table, filename) {
      const downloadLink = document.createElement("a");
      const dataType = 'application/vnd.ms-excel';
      
      // Tablo verilerini HTML olarak al
      let tableHTML = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">';
      tableHTML += '<head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Sheet1</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>';
      tableHTML += '<body><table>';
      
      // Başlık satırını ekle
      const headerRow = document.createElement('tr');
      for (const cell of table.tHead.rows[0].cells) {
        tableHTML += `<th>${cell.innerText}</th>`;
      }
      tableHTML += '</tr>';
      
      // Veri satırlarını ekle
      for (const row of table.tBodies[0].rows) {
        tableHTML += '<tr>';
        for (const cell of row.cells) {
          tableHTML += `<td>${cell.innerText}</td>`;
        }
        tableHTML += '</tr>';
      }
      
      tableHTML += '</table></body></html>';
      
      // İndirme bağlantısını oluştur
      const blob = new Blob([tableHTML], { type: dataType });
      downloadLink.href = URL.createObjectURL(blob);
      downloadLink.download = filename + '.xls';
      downloadLink.click();
    }

    // Sonuçları görüntüleme fonksiyonu
    function displayResults(data) {
      // Placeholder'ı gizle, sonuçları göster
      document.getElementById('results_placeholder').style.display = 'none';
      document.getElementById('results_container').style.display = 'block';
      
      // Özet verilerini doldur
      document.getElementById('total_revenue').textContent = formatCurrency(data.summary.total_revenue);
      document.getElementById('total_cost').textContent = formatCurrency(data.summary.total_cost);
      document.getElementById('total_profit').textContent = formatCurrency(data.summary.total_profit);
      document.getElementById('profit_margin').textContent = '%' + data.summary.total_profit_margin.toFixed(2);
      
      // Tablo verilerini doldur
      const resultsTable = document.getElementById('results_table').getElementsByTagName('tbody')[0];
      resultsTable.innerHTML = '';
      
      data.results.forEach(result => {
        const row = resultsTable.insertRow();
        
        // Model bilgisi
        const modelCell = row.insertCell();
        modelCell.innerHTML = result.model_id;
        
        // Adet
        const countCell = row.insertCell();
        countCell.textContent = result.count;
        countCell.className = 'text-end';
        
        // Kar
        const profitCell = row.insertCell();
        profitCell.textContent = formatCurrency(result.profit);
        profitCell.className = 'text-end';
        if (result.profit < 0) {
          profitCell.classList.add('text-danger');
        } else {
          profitCell.classList.add('text-success');
        }
        
        // Kar marjı
        const marginCell = row.insertCell();
        marginCell.textContent = '%' + result.profit_margin.toFixed(2);
        marginCell.className = 'text-end';
        if (result.profit_margin < 0) {
          marginCell.classList.add('text-danger');
        } else {
          marginCell.classList.add('text-success');
        }
      });
    }

    // Para birimini formatla
    function formatCurrency(amount) {
      return new Intl.NumberFormat('tr-TR', { 
        style: 'currency', 
        currency: 'TRY',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    // Uyarı gösterme
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed bottom-0 end-0 m-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.style.maxWidth = '350px';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      document.body.appendChild(alertDiv);

      // 5 saniye sonra otomatik kapat
      setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => {
          alertDiv.remove();
        }, 300);
      }, 5000);
    }
  });
</script>

<style>
  @media print {
    .btn, button, .no-print {
      display: none !important;
    }
    .card {
      border: 1px solid #ddd !important;
      box-shadow: none !important;
    }
    .card-header {
      background-color: #f8f9fa !important;
      color: #000 !important;
    }
    body {
      font-size: 12pt;
    }
    .container-fluid {
      width: 100% !important;
      max-width: 100% !important;
    }
  }
</style>
{% endblock %}
