
{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Kar-Zarar Analizi</h4>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">Başlangıç</span>
                        <input type="date" id="startDate" class="form-control">
                        <span class="input-group-text">Bitiş</span>
                        <input type="date" id="endDate" class="form-control">
                        <button class="btn btn-primary" onclick="getKarAnaliz()">Analiz Et</button>
                    </div>
                </div>
            </div>

            <!-- Özet Kartları -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Toplam Kar</h5>
                            <h3 id="toplamKar">0.00 ₺</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">Toplam Ciro</h5>
                            <h3 id="toplamCiro">0.00 ₺</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">Toplam Maliyet</h5>
                            <h3 id="toplamMaliyet">0.00 ₺</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Genel Kar Oranı</h5>
                            <h3 id="genelKarOrani">%0.00</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detay Tablosu -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Ürün ID</th>
                            <th>Toplam Satış</th>
                            <th>Toplam Adet</th>
                            <th>Birim Maliyet</th>
                            <th>Toplam Maliyet</th>
                            <th>Kar</th>
                            <th>Kar Oranı</th>
                        </tr>
                    </thead>
                    <tbody id="karAnalizTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Varsayılan tarih aralığını ayarla
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    
    getKarAnaliz();
});

function getKarAnaliz() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    fetch(`/api/kar-analiz?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateOzet(data.ozet);
                updateTablo(data.sonuclar);
            } else {
                alert('Hata: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Veriler alınırken bir hata oluştu.');
        });
}

function updateOzet(ozet) {
    document.getElementById('toplamKar').textContent = formatPrice(ozet.toplam_kar);
    document.getElementById('toplamCiro').textContent = formatPrice(ozet.toplam_ciro);
    document.getElementById('toplamMaliyet').textContent = formatPrice(ozet.toplam_maliyet);
    document.getElementById('genelKarOrani').textContent = `%${ozet.genel_kar_orani.toFixed(2)}`;
}

function updateTablo(sonuclar) {
    const tbody = document.getElementById('karAnalizTable');
    tbody.innerHTML = '';
    
    sonuclar.forEach(sonuc => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${sonuc.urun_id}</td>
            <td>${formatPrice(sonuc.toplam_satis)}</td>
            <td>${sonuc.toplam_adet}</td>
            <td>${formatPrice(sonuc.birim_maliyet)}</td>
            <td>${formatPrice(sonuc.toplam_maliyet)}</td>
            <td class="${sonuc.kar >= 0 ? 'text-success' : 'text-danger'}">${formatPrice(sonuc.kar)}</td>
            <td class="${sonuc.kar_orani >= 0 ? 'text-success' : 'text-danger'}">%${sonuc.kar_orani.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
    });
}

function formatPrice(price) {
    return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY'
    }).format(price);
}
</script>
{% endblock %}
