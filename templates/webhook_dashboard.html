
{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Webhook İzleme Paneli</h2>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">Webhook Durumu</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5>Sipariş Webhook URL:</h5>
              <code id="orderWebhookUrl">{{ order_webhook_url }}</code>
            </div>
            <div>
              <span id="orderWebhookStatus" class="badge bg-success">Aktif</span>
            </div>
          </div>
          <hr>
          <div class="d-flex justify-content-between">
            <div>
              <h5>Ürün Webhook URL:</h5>
              <code id="productWebhookUrl">{{ product_webhook_url }}</code>
            </div>
            <div>
              <span id="productWebhookStatus" class="badge bg-success">Aktif</span>
            </div>
          </div>
          <hr>
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-primary" id="checkStatus">Webhook Durumunu Kontrol Et</button>
            <button class="btn btn-success" id="registerWebhooks">Webhook'ları Kaydet</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="card-title mb-0">Son Sipariş Olayları</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Olay Tipi</th>
                  <th>Sipariş No</th>
                  <th>Durum</th>
                </tr>
              </thead>
              <tbody id="orderEvents">
                {% for event in order_events %}
                <tr>
                  <td>{{ event.timestamp }}</td>
                  <td>{{ event.type }}</td>
                  <td>{{ event.order_number }}</td>
                  <td>{{ event.status }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0">Son Ürün Olayları</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Olay Tipi</th>
                  <th>Barkod</th>
                  <th>İşlem</th>
                </tr>
              </thead>
              <tbody id="productEvents">
                {% for event in product_events %}
                <tr>
                  <td>{{ event.timestamp }}</td>
                  <td>{{ event.type }}</td>
                  <td>{{ event.barcode }}</td>
                  <td>{{ event.action }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="card-title mb-0">Webhook Log Görüntüleyici</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="input-group">
              <select class="form-select" id="logType">
                <option value="all">Tüm Loglar</option>
                <option value="order">Sipariş Logları</option>
                <option value="product">Ürün Logları</option>
                <option value="error">Hata Logları</option>
              </select>
              <button class="btn btn-primary" id="refreshLogs">Yenile</button>
            </div>
          </div>
          <div class="log-container bg-dark text-light p-3" style="height: 300px; overflow-y: auto;">
            <pre id="logContent">{{ logs }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Webhook durumu kontrolü
  document.getElementById('checkStatus').addEventListener('click', function() {
    checkWebhookStatus();
  });

  // Webhook kaydı
  document.getElementById('registerWebhooks').addEventListener('click', function() {
    registerWebhooks();
  });

  // Log yenileme
  document.getElementById('refreshLogs').addEventListener('click', function() {
    refreshLogs();
  });

  // Sayfa yüklendiğinde ilk kontrol
  checkWebhookStatus();
  refreshLogs();

  // Her 30 saniyede bir verileri güncelle
  setInterval(function() {
    checkWebhookStatus();
    refreshLogs();
  }, 30000);
});

function checkWebhookStatus() {
  fetch('/api/webhook-status')
    .then(response => response.json())
    .then(data => {
      // Sipariş webhook durumu
      const orderStatus = document.getElementById('orderWebhookStatus');
      if (data.order_webhook_active) {
        orderStatus.className = 'badge bg-success';
        orderStatus.textContent = 'Aktif';
      } else {
        orderStatus.className = 'badge bg-danger';
        orderStatus.textContent = 'Pasif';
      }

      // Ürün webhook durumu
      const productStatus = document.getElementById('productWebhookStatus');
      if (data.product_webhook_active) {
        productStatus.className = 'badge bg-success';
        productStatus.textContent = 'Aktif';
      } else {
        productStatus.className = 'badge bg-danger';
        productStatus.textContent = 'Pasif';
      }

      // Olay tablolarını güncelle
      updateEventTables(data.recent_order_events, data.recent_product_events);
    })
    .catch(error => {
      console.error('Webhook durumu kontrol edilirken hata:', error);
    });
}

function registerWebhooks() {
  if (confirm('Trendyol API\'ye yeni webhook\'ları kaydetmek istediğinizden emin misiniz?')) {
    fetch('/api/register-webhooks', {
      method: 'POST'
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Webhook\'lar başarıyla kaydedildi!');
          checkWebhookStatus();
        } else {
          alert('Webhook kaydı sırasında bir hata oluştu: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Webhook kaydı sırasında hata:', error);
        alert('Webhook kaydı sırasında bir hata oluştu');
      });
  }
}

function refreshLogs() {
  const logType = document.getElementById('logType').value;
  fetch(`/api/webhook-logs?type=${logType}`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('logContent').textContent = data.logs;
    })
    .catch(error => {
      console.error('Loglar getirilirken hata:', error);
    });
}

function updateEventTables(orderEvents, productEvents) {
  // Sipariş olayları tablosu
  const orderEventsTable = document.getElementById('orderEvents');
  orderEventsTable.innerHTML = '';
  
  orderEvents.forEach(event => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${event.timestamp}</td>
      <td>${event.type}</td>
      <td>${event.order_number}</td>
      <td>${event.status}</td>
    `;
    orderEventsTable.appendChild(row);
  });

  // Ürün olayları tablosu
  const productEventsTable = document.getElementById('productEvents');
  productEventsTable.innerHTML = '';
  
  productEvents.forEach(event => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${event.timestamp}</td>
      <td>${event.type}</td>
      <td>${event.barcode}</td>
      <td>${event.action}</td>
    `;
    productEventsTable.appendChild(row);
  });
}
</script>

<style>
.log-container {
  border-radius: 0.25rem;
  font-family: monospace;
}
pre {
  white-space: pre-wrap;
  word-wrap: break-word;
}
</style>
{% endblock %}
